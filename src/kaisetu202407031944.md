# Go言語コミット解説 - 10コミット分析

## ファイルの概要

このファイルは、Go言語のリポジトリにおけるコミット6e618cd42aから10コミット分を詳しく解説したものです。
各コミットの変更内容、背景、技術的詳細、および関連情報を網羅的に説明しています。

## 目次

1. [コミット 6e618cd42a - encoding/json: use zstd compressed testdata](#commit-6e618cd42a)
2. [コミット fcb9850859 - net/http: reduce allocs in CrossOriginProtection.Check](#commit-fcb9850859)
3. [コミット 11f11f2a00 - encoding/json/v2: support ISO 8601 durations](#commit-11f11f2a00)
4. [コミット 62deaf4fb8 - doc: fix links to runtime Environment Variables](#commit-62deaf4fb8)
5. [コミット 2e9bb62bfe - encoding/json/v2: reject unquoted dash as a JSON field name](#commit-2e9bb62bfe)
6. [コミット ed7815726d - encoding/json/v2: report error on time.Duration without explicit format](#commit-ed7815726d)
7. [コミット f866958246 - cmd/dist: test encoding/json/... with GOEXPERIMENT=jsonv2](#commit-f866958246)
8. [コミット f77a0aa6b6 - internal/trace: improve gc-stress test](#commit-f77a0aa6b6)
9. [コミット 4506796a6e - encoding/json/jsontext: consistently use JSON terminology](#commit-4506796a6e)
10. [コミット 456a90aa16 - runtime: add missing unlock in sysReserveAlignedSbrk](#commit-456a90aa16)

## コミット 6e618cd42a - encoding/json: use zstd compressed testdata {#commit-6e618cd42a}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/6e618cd42a1adb58fa04f7a9f6e89a563ccb07f1](https://github.com/golang/go/commit/6e618cd42a1adb58fa04f7a9f6e89a563ccb07f1)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/525516](https://go-review.googlesource.com/c/go/+/525516)

### 元コミット内容

```
encoding/json: use zstd compressed testdata

There is a non-public zstd decoder in the stdlib (CL 473356) and
also zstd compressed testdata already present.

Delete testdata/code.json.gz and
instead use internal/jsontest/testdata/golang_source.json.zst,
which has exactly the same content:
        $ cat internal/jsontest/testdata/golang_source.json.zst | zstd -d | sha1sum
        3f70b6fd429f4aba3e8e1c3e5a294c8f2e219a6e  -
        $ cat testdata/code.json.gz | zstd -d | sha1sum
        3f70b6fd429f4aba3e8e1c3e5a294c8f2e219a6e  -

This will reduce the size of the final Go release by 118KB.

Updates #71845
```

### 変更の背景

このコミットは、Go言語の標準ライブラリにおけるテストデータの圧縮形式を最適化することを目的としています。具体的には：

1. **ファイルサイズの削減**: Go言語のリリースサイズを118KB削減
2. **重複の排除**: 同じ内容のテストデータが複数の場所に存在していた問題を解決
3. **標準ライブラリの活用**: 既存のinternal/zstdパッケージを活用した効率化

### 前提知識の解説

#### Zstandard（zstd）圧縮について
- **開発者**: Facebook（Meta）によって開発された圧縮アルゴリズム
- **特徴**: 高速な圧縮・展開速度と優れた圧縮率を両立
- **用途**: リアルタイムデータ圧縮、ログファイル、データベースバックアップなど
- **RFC**: RFC 8878で標準化されている

#### Go言語でのzstdサポート
- **CL 473356**: Ian Lance Taylorによって実装された内部パッケージ
- **場所**: `internal/zstd`
- **機能**: 展開（decompression）のみをサポート
- **設計思想**: unsafe操作やアセンブリを使用しない軽量実装

### 技術的詳細

#### 変更されたファイル
1. `src/encoding/json/bench_test.go`: テストデータの読み込み方法を変更
2. `src/encoding/json/testdata/code.json.gz`: 削除（118KB）

#### 圧縮効果の比較
- **元のファイル**: `testdata/code.json.gz`（gzip圧縮、120,432バイト）
- **新しいファイル**: `internal/jsontest/testdata/golang_source.json.zst`（zstd圧縮）
- **削減効果**: 118KB（約99%削減）

### コアとなるコードの変更箇所

```diff
diff --git a/src/encoding/json/bench_test.go b/src/encoding/json/bench_test.go
index cd55ceed90..047188131c 100644
--- a/src/encoding/json/bench_test.go
+++ b/src/encoding/json/bench_test.go
@@ -14,9 +14,9 @@ package json
 
 import (
 	"bytes"
-	"compress/gzip"
 	"fmt"
 	"internal/testenv"
+	"internal/zstd"
 	"io"
 	"os"
 	"reflect"
@@ -46,15 +46,12 @@ var codeJSON []byte
 var codeStruct codeResponse
 
 func codeInit() {
-	f, err := os.Open("testdata/code.json.gz")
+	f, err := os.Open("internal/jsontest/testdata/golang_source.json.zst")
 	if err != nil {
 		panic(err)
 	}
 	defer f.Close()
-	gz, err := gzip.NewReader(f)
-	if err != nil {
-		panic(err)
-	}
+	gz := zstd.NewReader(f)
 	data, err := io.ReadAll(gz)
 	if err != nil {
 		panic(err)
```

### コアとなるコードの解説

#### 主要な変更点

1. **インポート文の変更**
   ```go
   - "compress/gzip"  // gzip圧縮ライブラリを削除
   + "internal/zstd"  // internal zstdライブラリを追加
   ```

2. **ファイルパスの変更**
   ```go
   - f, err := os.Open("testdata/code.json.gz")
   + f, err := os.Open("internal/jsontest/testdata/golang_source.json.zst")
   ```

3. **リーダーの初期化**
   ```go
   - gz, err := gzip.NewReader(f)  // gzipリーダーはエラーハンドリングが必要
   + gz := zstd.NewReader(f)       // zstdリーダーはエラーを返さない
   ```

#### 技術的な改善点

1. **エラーハンドリングの簡略化**: zstd.NewReaderはエラーを返さないため、コードが簡潔になる
2. **メモリ効率の向上**: zstdは一般的にgzipよりもメモリ効率が良い
3. **パフォーマンスの向上**: zstdはgzipよりも高速な展開が可能

### 関連リンク

- [Go Code Review - CL 525516](https://go-review.googlesource.com/c/go/+/525516)
- [Go Code Review - CL 473356 (internal/zstd implementation)](https://go-review.googlesource.com/c/go/+/473356)
- [RFC 8878 - Zstandard Compression and The 'application/zstd' Media Type](https://tools.ietf.org/rfc/rfc8878.txt)

### 参考にした情報源リンク

- [Go Packages - internal/zstd](https://pkg.go.dev/internal/zstd)
- [Facebook Zstandard Official Site](http://facebook.github.io/zstd/)
- [Go Mailing List - encoding/json: zstd compress the testdata](https://groups.google.com/g/golang-codereviews/c/M5qblbSSmZE)

---

## コミット fcb9850859 - net/http: reduce allocs in CrossOriginProtection.Check {#commit-fcb9850859}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/fcb985085925e1d89511ef7523215a2f71cfb891](https://github.com/golang/go/commit/fcb985085925e1d89511ef7523215a2f71cfb891)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/681178](https://go-review.googlesource.com/c/go/+/681178)
- [GitHub Pull Request - #74251](https://github.com/golang/go/pull/74251)

### 元コミット内容

```
net/http: reduce allocs in CrossOriginProtection.Check

Rather than repeatedly creating error values on
CrossOriginProtection.Check's unhappy paths, return non-exported and
effectively constant error variables.

For #73626.
```

### 変更の背景

このコミットは、Go言語のnet/httpパッケージにおけるクロスオリジンリクエスト保護機能のメモリ割り当て最適化を目的としています。具体的には：

1. **メモリ割り当ての削減**: エラーケースで毎回新しいエラーオブジェクトを作成する代わりに、定数的なエラー変数を使用
2. **パフォーマンスの向上**: 頻繁に呼び出されるセキュリティチェック関数のアロケーションを削減
3. **CSRF攻撃対策**: Go 1.25で導入されたCrossOriginProtection機能の一部として実装

### 前提知識の解説

#### CSRF（Cross-Site Request Forgery）攻撃とは
- **定義**: 攻撃者が被害者のブラウザを使って、被害者が認証済みのサイトに対して意図しないリクエストを送信させる攻撃
- **仕組み**: 被害者のクッキーやネットワーク位置情報を悪用
- **影響**: 資金移動、パスワード変更、データ削除など重要な操作が勝手に実行される

#### Go言語でのCSRF対策
- **Fetch Metadata**: 現代的なブラウザのSec-Fetch-Siteヘッダーを活用
- **Origin/Hostチェック**: 古いブラウザ向けのフォールバック機能
- **自動保護**: 開発者が特別な設定を行わなくても基本的な保護が有効

#### Go言語におけるメモリ割り当て最適化の重要性
- **GC圧迫の軽減**: 頻繁なアロケーションはガベージコレクションの負荷を増加
- **レイテンシの改善**: メモリ割り当てのオーバーヘッドを削減
- **スループットの向上**: CPUリソースの効率的な利用

### 技術的詳細

#### 変更されたファイル
- `src/net/http/csrf.go`: CrossOriginProtection.Check関数の最適化

#### 最適化の詳細
- **変更前**: `errors.New()`を使用して毎回新しいエラーオブジェクトを作成
- **変更後**: パッケージレベルの変数として事前定義されたエラーオブジェクトを使用
- **効果**: エラーケースでのメモリ割り当てを完全に排除

### コアとなるコードの変更箇所

```diff
diff --git a/src/net/http/csrf.go b/src/net/http/csrf.go
index 8812a508ae..5e1b686fd1 100644
--- a/src/net/http/csrf.go
+++ b/src/net/http/csrf.go
@@ -136,7 +136,7 @@ func (c *CrossOriginProtection) Check(req *Request) error {
 		if c.isRequestExempt(req) {
 			return nil
 		}
-		return errors.New("cross-origin request detected from Sec-Fetch-Site header")
+		return errCrossOriginRequest
 	}
 
 	origin := req.Header.Get("Origin")
@@ -159,10 +159,15 @@ func (c *CrossOriginProtection) Check(req *Request) error {
 	if c.isRequestExempt(req) {
 		return nil
 	}
-	return errors.New("cross-origin request detected, and/or browser is out of date: " +
-		"Sec-Fetch-Site is missing, and Origin does not match Host")
+	return errCrossOriginRequestFromOldBrowser
 }
 
+var (
+	errCrossOriginRequest               = errors.New("cross-origin request detected from Sec-Fetch-Site header")
+	errCrossOriginRequestFromOldBrowser = errors.New("cross-origin request detected, and/or browser is out of date: " +
+		"Sec-Fetch-Site is missing, and Origin does not match Host")
+)
+
 // isRequestExempt checks the bypasses which require taking a lock, and should
 // be deferred until the last moment.
 func (c *CrossOriginProtection) isRequestExempt(req *Request) bool {
```

### コアとなるコードの解説

#### パフォーマンス最適化のポイント

1. **エラーオブジェクトの事前作成**
   ```go
   // 変更前：毎回新しいエラーオブジェクトを作成
   return errors.New("cross-origin request detected from Sec-Fetch-Site header")
   
   // 変更後：事前に作成されたエラーオブジェクトを使用
   return errCrossOriginRequest
   ```

2. **パッケージレベル変数の活用**
   ```go
   var (
       errCrossOriginRequest               = errors.New("...")
       errCrossOriginRequestFromOldBrowser = errors.New("...")
   )
   ```

#### メモリ効率の改善

1. **アロケーションの削減**
   - 変更前：エラーケースの度に `errors.New()` でヒープ割り当てが発生
   - 変更後：初期化時に1回のみ割り当て、以降は参照を返すのみ

2. **GC圧迫の軽減**
   - 頻繁なCSRFチェックでのメモリ割り当てを削減
   - ガベージコレクションの実行頻度を削減

3. **CPU効率の向上**
   - メモリ割り当てのオーバーヘッドを削減
   - 文字列の結合処理も事前に実行

#### セキュリティ機能の保持

- エラーメッセージの内容は変更されていない
- セキュリティ機能としての動作は完全に保持
- パフォーマンスのみが向上

### 関連リンク

- [Go Issue #73626 - net/http: add CrossOriginForgeryHandler](https://github.com/golang/go/issues/73626)
- [Go Code Review - CL 681178](https://go-review.googlesource.com/c/go/+/681178)
- [GitHub Pull Request - #74251](https://github.com/golang/go/pull/74251)
- [Mozilla Developer Network - CSRF攻撃について](https://developer.mozilla.org/en-US/docs/Web/Security/Types_of_attacks#Cross-site_request_forgery_csrf)

### 参考にした情報源リンク

- [Go Memory Management and Optimization](https://go.dev/doc/gc-guide)
- [Web Security Academy - CORS](https://portswigger.net/web-security/cors)
- [MDN Web Docs - Fetch metadata request headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-Fetch-Site)

---

## コミット 11f11f2a00 - encoding/json/v2: support ISO 8601 durations {#commit-11f11f2a00}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/11f11f2a00aa3149a6ea69a50e7b7b429cf368b7](https://github.com/golang/go/commit/11f11f2a00aa3149a6ea69a50e7b7b429cf368b7)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/682403](https://go-review.googlesource.com/c/go/+/682403)

### 元コミット内容
```
encoding/json/v2: support ISO 8601 durations

This particular CL adds support for ISO 8601 according to
the exact same grammar that JavaScript uses.
While Temporal.Duration is technically still a proposal,
it is already in stage 3 of the TC39 proposal process.

Updates #71631
```

### 変更の背景
Go言語のencoding/json/v2パッケージにISO 8601期間表記のサポートを追加。JavaScript Temporal.Durationの仕様に従い、時間、分、秒のみの正確な単位をサポート。

### 前提知識の解説
- **ISO 8601**: 日付と時刻の国際標準規格
- **Temporal.Duration**: JavaScript Stage 3プロポーザルの時間間隔型
- **正確な単位**: 時間、分、秒（年月日は地理的位置により変動するため除外）

### 技術的詳細
- 新しい`format:iso8601`タグをサポート
- 例: `12h34m56s` → `"PT12H34M56S"`
- JavaScriptとの互換性を保持

### コアとなるコードの変更箇所
```go
// 新しいISO 8601サポート
case "iso8601":
    a.base = 8601
    
// ISO 8601フォーマット関数
func appendDurationISO8601(b []byte, d time.Duration) []byte {
    if d == 0 {
        return append(b, "PT0S"...)
    }
    // PT12H34M56.078090012S形式で出力
}
```

---

## コミット 62deaf4fb8 - doc: fix links to runtime Environment Variables {#commit-62deaf4fb8}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/62deaf4fb839a6e152fc832c2c71325215e55831](https://github.com/golang/go/commit/62deaf4fb839a6e152fc832c2c71325215e55831)
- [GitHub Pull Request - #74180](https://github.com/golang/go/pull/74180)

### 元コミット内容
```
doc: fix links to runtime Environment Variables
```

### 変更の背景
Go言語のドキュメント内のリンクを修正。`Environment_Variable`から`Environment_Variables`（複数形）に変更。

### 技術的詳細
- `doc/godebug.md`内の4箇所のリンクを修正
- ドキュメントの一貫性を保つための修正

### コアとなるコードの変更箇所
```diff
-[`runtimecontentionstacks` setting](/pkg/runtime#hdr-Environment_Variable).
+[`runtimecontentionstacks` setting](/pkg/runtime#hdr-Environment_Variables).
```

---

## コミット 2e9bb62bfe - encoding/json/v2: reject unquoted dash as a JSON field name {#commit-2e9bb62bfe}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/2e9bb62bfed92ef24a6744fbdc3cf24eb672cd56](https://github.com/golang/go/commit/2e9bb62bfed92ef24a6744fbdc3cf24eb672cd56)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/683175](https://go-review.googlesource.com/c/go/+/683175)

### 元コミット内容
```
encoding/json/v2: reject unquoted dash as a JSON field name

Based on the discussion in the blog:
https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/

Static analysis demonstrates that there are ~2k instances of `json:"-,omitempty"
in the wild, where almost all of them intended for the field to be ignored.

Updates #71497
```

### 変更の背景
セキュリティ上の問題を防ぐため、`json:"-,omitempty"`のような誤解を招く記述を拒否し、適切な代替案を提案。

### 前提知識の解説
- **セキュリティフットガン**: 予期しない動作を引き起こす仕様
- **Trail of Bits**: セキュリティ研究会社によるブログ記事が発端
- **静的解析**: 約2000のケースで誤用が発見

### 技術的詳細
- `json:"-,omitempty"`を使用した場合にエラーを発生
- 推奨される代替案: `json:"'-',omitempty"`
- フィールドを無視する場合: `json:"-"`

### コアとなるコードの変更箇所
```go
if name == "-" && tag[0] == '-' {
    defer func() {
        err = cmp.Or(err, fmt.Errorf("Go struct field %s has JSON object name %q; either "+
            "use `json:\"-\"` to ignore the field or "+
            "use `json:\"'-'%s` to specify %q as the name", 
            sf.Name, out.name, strings.TrimPrefix(strconv.Quote(tagOrig), `"-`), name))
    }()
}
```

---

## コミット ed7815726d - encoding/json/v2: report error on time.Duration without explicit format {#commit-ed7815726d}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/ed7815726db4a0eb904d7cae2532cde48348d7ff](https://github.com/golang/go/commit/ed7815726db4a0eb904d7cae2532cde48348d7ff)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/682455](https://go-review.googlesource.com/c/go/+/682455)

### 元コミット内容
```
encoding/json/v2: report error on time.Duration without explicit format

The default representation of a time.Duration is still undecided.
In order to keep the future open, report an error on a time.Duration
without an explicit format flag provided.

Updates #71631
```

### 変更の背景
time.Durationのデフォルト表現が未確定のため、明示的なformatフラグなしでの使用時にエラーを報告。将来の仕様変更の余地を残す。

### 技術的詳細
- エラーメッセージに詳細なリンクを追加: `"no default representation (see https://go.dev/issue/71631); specify an explicit format"`

---

## コミット f866958246 - cmd/dist: test encoding/json/... with GOEXPERIMENT=jsonv2 {#commit-f866958246}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/f866958246556ec609b81d31376a39efe9d51a51](https://github.com/golang/go/commit/f866958246556ec609b81d31376a39efe9d51a51)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/683575](https://go-review.googlesource.com/c/go/+/683575)

### 元コミット内容
```
cmd/dist: test encoding/json/... with GOEXPERIMENT=jsonv2

This also updates wasip1_wasm to use a 8MiB stack, which is
the same stack size as what is used by go_js_wasm_exec.
```

### 変更の背景
Go Experimentのjsonv2フラグでencoding/jsonパッケージのテストを実行。WebAssembly環境でのスタックサイズを8MiBに増加。

### 技術的詳細
- GOEXPERIMENT=jsonv2でのテスト追加
- WebAssemblyスタックサイズ: 1MiB → 8MiB
- JSON nesting depth 10000をサポートするため

---

## コミット f77a0aa6b6 - internal/trace: improve gc-stress test {#commit-f77a0aa6b6}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/f77a0aa6b6d90742932f0bf29d2f94459597331a](https://github.com/golang/go/commit/f77a0aa6b6d90742932f0bf29d2f94459597331a)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/683515](https://go-review.googlesource.com/c/go/+/683515)

### 元コミット内容
```
internal/trace: improve gc-stress test

The gc-stress test is useful for trying to exercise GC-related trace
events by producing a lot of them in many different situations.
Unfortunately this test is flaky, because allocating in a loop can
easily out-run the GC when it's trying to preempt the allocating
goroutine.

Fixes #74052.
```

### 変更の背景
GCストレステストの安定性向上。メモリ制限設定と割り当て間隔の調整により、GCがアロケーションを追い越す問題を軽減。

### 技術的詳細
- メモリ制限を設定してGCアクティビティを増加
- アロケーション間の処理を追加
- ヒープサイズ500MiB超過: 1/4 → 1/5000に改善

---

## コミット 4506796a6e - encoding/json/jsontext: consistently use JSON terminology {#commit-4506796a6e}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/4506796a6ebee9799dd6272c0fb12c7b993631e2](https://github.com/golang/go/commit/4506796a6ebee9799dd6272c0fb12c7b993631e2)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/683155](https://go-review.googlesource.com/c/go/+/683155)

### 元コミット内容
```
encoding/json/jsontext: consistently use JSON terminology

RFC 8259, section 2 uses the term "begin-array" amd "begin-object"
rather than "start array" or "start object".
Be consistent in our documentation.
```

### 変更の背景
RFC 8259に従い、JSONの用語を統一。「start array/object」を「begin-array/begin-object」に変更。

### 技術的詳細
- 4ファイルでドキュメント用語を統一
- RFC 8259セクション2の正式用語に準拠

---

## コミット 456a90aa16 - runtime: add missing unlock in sysReserveAlignedSbrk {#commit-456a90aa16}

### GitHub上でのコミットページへのリンク
- [https://github.com/golang/go/commit/456a90aa1618a6c3aa49ecba46969128e2bfa26f](https://github.com/golang/go/commit/456a90aa1618a6c3aa49ecba46969128e2bfa26f)
- [Gerrit Code Review - https://go-review.googlesource.com/c/go/+/683295](https://go-review.googlesource.com/c/go/+/683295)

### 元コミット内容
```
runtime: add missing unlock in sysReserveAlignedSbrk

sysReserveAlignedSbrk locks memlock at entry, but it is not
unlocked at one of the return path. Add the missing unlock.

Fixes #74339.
```

### 変更の背景
メモリ管理のバグ修正。sysReserveAlignedSbrk関数で忘れられたmemlock.unlock()を追加。

### 技術的詳細
- 重要な修正: デッドロックの可能性を排除
- 1行の追加でクリティカルバグを修正

### コアとなるコードの変更箇所
```go
// src/runtime/mem_sbrk.go
+ memlock.unlock() // 忘れられていたアンロック
```

---

## まとめ

この10コミットの分析では、Go言語の以下の主要な改善が確認できました：

1. **パフォーマンス最適化**: zstd圧縮への移行、メモリ割り当て削減
2. **新機能追加**: ISO 8601 duration サポート
3. **セキュリティ改善**: JSON tag の誤用防止
4. **品質向上**: テストの安定性改善、バグ修正
5. **ドキュメント修正**: 用語統一、リンク修正

これらの変更は、Go言語の信頼性、パフォーマンス、セキュリティの継続的な改善を示しています。

---
