# [インデックス 1007] ファイルの概要

このドキュメントは、Go言語の初期開発段階におけるコンパイラのパーサー拡張に関する重要なコミットを解説します。Russ Cox氏による2008年の変更で、構造体フィールドのインポート時のアノテーション機能と、型分散機能の実装が行われました。

## コミット

- **コミットハッシュ**: 1850b29da672c8c1364ce9a2cdfebefead6d40e2
- **作成者**: Russ Cox <rsc@golang.org>
- **日付**: 2008年10月30日 15:25:26 (UTC-7)
- **コミットメッセージ**: "struct annotations in imports. distribute tag across multiple names."
- **レビュー**: R=ken (Ken Thompson氏によるレビュー)
- **CL番号**: 18178

## GitHub上でのコミットページへのリンク

https://github.com/golang/go/commit/1850b29da672c8c1364ce9a2cdfebefead6d40e2

## 元コミット内容

```
commit 1850b29da672c8c1364ce9a2cdfebefead6d40e2
Author: Russ Cox <rsc@golang.org>
Date:   Thu Oct 30 15:25:26 2008 -0700

    struct annotations in imports.
    distribute tag across multiple names.
    
    R=ken
    OCL=18178
    CL=18178
```

変更されたファイル:
- src/cmd/gc/go.y (yacc文法ファイル)
- src/cmd/gc/subr.c (サブルーチン関数群)

## 変更の背景

2008年は、Go言語の初期開発段階で、基本的なコンパイラ機能が実装されていた時期です。この時期のGoコンパイラは、Plan 9のCコンパイラをベースに開発されており、yacc（Yet Another Compiler-Compiler）を使用してパーサーを生成していました。

このコミットは、構造体フィールドにメタデータを付与する仕組み（後の構造体タグ）の基礎を築く重要な変更です。Go言語の設計思想として、シンプルで明確な構文でありながら、メタプログラミングやリフレクションに必要な情報を効率的に格納できる仕組みが求められていました。

## 前提知識の解説

### yaccパーサーとgo.yファイル

yaccは、LALR(1)パーサージェネレータで、BNF（Backus-Naur Form）に似た記法で記述された文法規則からパーサーを自動生成するツールです。Go言語の初期コンパイラでは、言語仕様をgo.yファイルに記述し、yaccを使ってC言語のパーサーコードを生成していました。

### 構造体フィールドの宣言構文

Go言語の構造体フィールドは、以下の形式で宣言されます：

```go
type StructName struct {
    FieldName FieldType `tag:"value"`
}
```

この`tag:"value"`部分が構造体タグと呼ばれ、フィールドにメタデータを付与する仕組みです。

### ASTノードの構造

Goコンパイラでは、パーサーが構文解析を行った結果をAST（Abstract Syntax Tree）として表現します。各ASTノードには以下の情報が含まれます：

- ノードタイプ（ODCLFIELD：フィールド宣言など）
- 型情報（type）
- 値情報（val）
- 子ノード（left、right）

## 技術的詳細

### パーサー文法の拡張

go.yファイルでは、`hidden_structdcl`規則が以下のように変更されました：

**変更前:**
```yacc
hidden_structdcl:
    sym1 hidden_type
    {
        $$ = nod(ODCLFIELD, newname($1), N);
        $$->type = $2;
    }
```

**変更後:**
```yacc
hidden_structdcl:
    sym1 hidden_type oliteral
    {
        $$ = nod(ODCLFIELD, newname($1), N);
        $$->type = $2;
        $$->val = $3;
    }
```

この変更により、構造体フィールドの宣言時にオプションのリテラル値（`oliteral`）を受け取り、それをASTノードの`val`フィールドに格納できるようになりました。

### 型分散機能の実装

subr.cファイルの`cleanidlist`関数では、複数の識別子に対して型情報を分散させる処理が拡張されました：

**変更前:**
```c
for(n=na; n->op == OLIST; n=n->right)
    n->left->type = last->type;
```

**変更後:**
```c
for(n=na; n->op == OLIST; n=n->right) {
    n->left->type = last->type;
    n->left->val = last->val;
}
```

この変更により、型情報だけでなく値情報（val）も複数の識別子に分散されるようになりました。

## コアとなるコードの変更箇所

### 1. go.yファイルの変更 (src/cmd/gc/go.y:1892-1898)

```diff
 hidden_structdcl:
-	sym1 hidden_type
+	sym1 hidden_type oliteral
 	{
 		$$ = nod(ODCLFIELD, newname($1), N);
 		$$->type = $2;
+		$$->val = $3;
 	}
```

### 2. subr.cファイルの変更 (src/cmd/gc/subr.c:2192-2199)

```diff
-	for(n=na; n->op == OLIST; n=n->right)
+	for(n=na; n->op == OLIST; n=n->right) {
 		n->left->type = last->type;
+		n->left->val = last->val;
+	}
```

## コアとなるコードの解説

### パーサー文法の拡張

`hidden_structdcl`規則の拡張は、構造体フィールドの宣言時に構造体タグを解析できるようにする重要な変更です。

- `sym1`: フィールド名
- `hidden_type`: フィールドの型
- `oliteral`: オプションのリテラル値（構造体タグ）

`nod(ODCLFIELD, newname($1), N)`は、フィールド宣言を表すASTノードを作成します。このノードに型情報（`$$->type = $2`）と値情報（`$$->val = $3`）を設定することで、構造体タグの情報を保持できるようになりました。

### 型分散機能

`cleanidlist`関数の拡張は、以下のような宣言において重要な役割を果たします：

```go
type S struct {
    a, b, c int `json:"field"`
}
```

この場合、`a`、`b`、`c`の3つのフィールドすべてに、型情報（`int`）と値情報（`json:"field"`）を分散させる必要があります。変更後のコードでは：

1. `n->left->type = last->type`：型情報を各フィールドに分散
2. `n->left->val = last->val`：値情報（タグ）を各フィールドに分散

この機能により、1つの構造体タグを複数のフィールドに適用できるようになりました。

### ASTノードの構造

変更されたASTノードの構造：

```c
struct Node {
    uchar op;           // ノードタイプ（ODCLFIELD等）
    Type* type;         // 型情報
    Val val;            // 値情報（追加）
    Node* left;         // 左の子ノード
    Node* right;        // 右の子ノード
    // その他のフィールド
};
```

`val`フィールドの追加により、構造体タグの情報をASTレベルで保持できるようになりました。

## 関連リンク

- [Go言語仕様書](https://go.dev/ref/spec)
- [Go Wiki: 既知の構造体タグ](https://go.dev/wiki/Well-known-struct-tags)
- [reflect パッケージ](https://pkg.go.dev/reflect)
- [Go言語の歴史ドキュメンタリー](https://golang.design/history/)
- [Yacc - Wikipedia](https://en.wikipedia.org/wiki/Yacc)
- [Go言語のドキュメンタリー](https://github.com/golang-design/history)

## 参考にした情報源リンク

- [Go言語の構造体タグに関する詳細解説](https://medium.com/pragmatic-programmers/parsing-struct-tags-a99c5db9accd)
- [Go言語のリフレクションについて](https://medium.com/capital-one-tech/learning-to-use-go-reflection-822a0aed74b7)
- [Go言語のコンパイラ内部構造](https://chermehdi.com/posts/go-compiler/part-1/)
- [Go言語のAST package](https://pkg.go.dev/go/ast)
- [Go言語における構造体タグの深い理解](https://metamemelord.medium.com/deep-dive-into-go-struct-tags-d629ec0be30d)
- [Go言語の最初のプログラム](https://go.dev/blog/first-go-program)
- [goyacc コマンド](https://pkg.go.dev/golang.org/x/tools/cmd/goyacc)