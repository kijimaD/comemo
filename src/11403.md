# [インデックス 11403] ファイルの概要

このコミットは、Go 1リリースにおける`net/url`パッケージの変更点を公式ドキュメント（`doc/go1.html`と`doc/go1.tmpl`）に追加するものです。具体的には、`url.URL`構造体のフィールドの削除、置換、および新しいメソッドの追加に関する詳細な説明が記述されています。これにより、Go 1への移行を検討している開発者が、`net/url`パッケージのAPI変更に適切に対応できるよう情報が提供されます。

## コミット

```
commit 805d6206829abfb483e2fca88c88171b777de7dc
Author: Gustavo Niemeyer <gustavo@niemeyer.net>
Date:   Wed Jan 25 23:11:25 2012 -0200

    doc/go1: add net/url changes
    
    R=golang-dev, bradfitz, r
    CC=golang-dev
    https://golang.org/cl/5575056
```

## GitHub上でのコミットページへのリンク

[https://github.com/golang/go/commit/805d6206829abfb483e2fca88c88171b777de7dc](https://github.com/golang/go/commit/805d6206829abfb483e2fca88c88171b777de7dc)

## 元コミット内容

`doc/go1: add net/url changes`

## 変更の背景

Go言語の初期バージョン（Go 1より前）では、`net/url`パッケージの`url.URL`構造体は、URLの各コンポーネントを表現するためにいくつかのフィールドを持っていました。しかし、これらのフィールドの一部は、URLのエンコード状態や、ユーザー情報、パスの表現方法に関して、一貫性や予測可能性に欠ける部分がありました。特に、パスワードがエスケープされてしまう問題や、エンコードされたパスとデコードされたパスの扱いが複雑である点が挙げられます。

Go 1のリリースにあたり、GoチームはAPIの安定化と改善を目指しました。`net/url`パッケージにおいても、より堅牢で予測可能なURLのパースと構築を実現するために、`url.URL`構造体の設計が見直されました。この見直しにより、冗長なフィールドや混乱を招く可能性のあるフィールドが削除または置き換えられ、より明確なセマンティクスを持つ新しいフィールドやメソッドが導入されました。

このコミットは、これらの`net/url`パッケージ内部の変更を、Go 1のリリースノートの一部として公式ドキュメントに反映させることを目的としています。これにより、既存のGoプログラムをGo 1に移行する開発者が、`net/url`パッケージの変更点と、それに対応するためのコード修正の指針を明確に理解できるようになります。

## 前提知識の解説

### URL (Uniform Resource Locator)

URLは、インターネット上のリソースの位置を示すための標準的な方法です。一般的なURLは、以下のようなコンポーネントで構成されます。

*   **スキーム (Scheme)**: リソースにアクセスするためのプロトコル（例: `http`, `https`, `ftp`, `mailto`）。
*   **ユーザー情報 (Userinfo)**: ユーザー名とパスワード（オプション）。通常は`username:password@`の形式でホスト名の前に置かれます。
*   **ホスト (Host)**: リソースが配置されているサーバーのドメイン名またはIPアドレス。
*   **ポート (Port)**: サーバー上の特定のサービスを識別するための番号（オプション）。
*   **パス (Path)**: サーバー上のリソースの場所を示す階層的な情報。
*   **クエリ (Query)**: リソースに渡される追加のパラメータ（例: `?key=value&another=param`）。
*   **フラグメント (Fragment)**: リソース内の特定の部分を指す識別子（例: `#section`）。

### Go言語の`net/url`パッケージ

Go言語の標準ライブラリに含まれる`net/url`パッケージは、URLのパース、構築、および操作のための機能を提供します。このパッケージの中心となるのが`url.URL`構造体であり、上記のURLコンポーネントをそれぞれフィールドとして保持します。

### `url.URL`構造体（Go 1以前の概念を含む）

Go 1以前の`url.URL`構造体には、以下のようなフィールドが存在しました（変更点と関連するフィールドに焦点を当てる）。

*   `Scheme` (string): スキーム。
*   `Opaque` (string): 非階層型URL（例: `mailto:`）のパス部分。
*   `User` (`*Userinfo`): ユーザー情報。
*   `Host` (string): ホスト名とポート番号。
*   `Path` (string): デコードされたパス。
*   `RawPath` (string): エンコードされたパス。
*   `RawQuery` (string): エンコードされたクエリ文字列。
*   `Fragment` (string): デコードされたフラグメント。
*   `Raw` (string): URL全体のエンコードされた文字列。
*   `RawUserinfo` (string): エンコードされたユーザー情報。
*   `RawAuthority` (string): エンコードされたオーソリティ（ユーザー情報とホスト）。
*   `OpaquePath` (bool): パスが非階層型であるかを示すフラグ。

### ルート付きURLと非ルート付きURL

*   **ルート付きURL (Rooted URLs)**: スキームの後にスラッシュ（`/`）が続くURL。例: `http://example.com/path/to/resource`。パスは通常、`/`で始まります。
*   **非ルート付きURL (Non-rooted paths / Opaque URLs)**: スキームの後にスラッシュが続かないURL。例: `mailto:dev@golang.org`。この場合、スキームの後の部分はパスとして扱われず、`Opaque`フィールドに格納されます。

### `gofix`ツール

`gofix`は、Go言語の古いAPIを使用しているコードを、新しいAPIに自動的に変換するためのツールです。Go 1のリリース時に、多くのAPI変更に対応するために導入されました。しかし、セマンティックな変更（意味合いが変わる変更）を伴う場合は、`gofix`による自動変換が困難な場合があります。

## 技術的詳細

このコミットで文書化されている`net/url`パッケージの変更は、`url.URL`構造体のフィールドとメソッドのセマンティクスを改善し、より予測可能で堅牢なURL処理を実現することを目的としています。

1.  **`url.URL.String()` メソッドの変更**:
    *   Go 1では、`String()`メソッドは`URL`構造体のすべてのフィールドを使用して、エンコードされたURL文字列を予測可能に再構築するようになりました。
    *   重要な変更点として、結果の文字列にパスワードがエスケープされなくなりました。これにより、URL文字列をログに出力する際などに、意図せずパスワードが露出するリスクが低減されます。

2.  **`Raw` フィールドの削除**:
    *   Go 1以前に存在した`Raw`フィールドは削除されました。このフィールドはURL全体のエンコードされた文字列を保持していましたが、多くの場合、新しい`String()`メソッドで代替可能です。

3.  **`RawUserinfo` フィールドの削除と `User` フィールドへの置き換え**:
    *   古い`RawUserinfo`フィールドは削除され、代わりに`*net.Userinfo`型の`User`フィールドが導入されました。
    *   `net.Userinfo`型は、ユーザー名とパスワードをより構造化された形で保持します。
    *   新しい`net.User()`および`net.UserPassword()`関数を使用して`Userinfo`型の値を作成できます。
    *   これに伴い、`EscapeUserinfo`および`UnescapeUserinfo`関数も削除されました。この変更により、ユーザー情報の扱いがより安全かつ明確になりました。

4.  **`RawAuthority` フィールドの削除**:
    *   `RawAuthority`フィールドも削除されました。このフィールドが提供していた情報は、`Host`フィールドと新しい`User`フィールドから取得できるようになりました。これにより、冗長なフィールドが排除されました。

5.  **`RawPath` フィールドと `EncodedPath` メソッドの削除**:
    *   `RawPath`フィールドと`EncodedPath`メソッドは削除されました。
    *   ルート付きURL（スキームの後にスラッシュが続くURL）のパス情報は、デコードされた形式で`Path`フィールドにのみ提供されるようになりました。
    *   この変更の背景には、URLのパスは通常デコードされた形式で扱われるべきであるという設計思想があります。
    *   ただし、エンコードされたデータからしか得られない情報（例: `%2F`がパスセパレータではなく文字としてエンコードされている場合など）が必要な場合は、元のURLデータにアクセスして処理する必要があります。これは、`net/url`パッケージがURLの正規化をより厳密に行うようになった結果です。

6.  **非ルート付きパス（Opaque URLs）の扱い変更**:
    *   `OpaquePath`ブーリアンフィールドが削除され、代わりに新しい`Opaque`文字列フィールドが導入されました。
    *   `mailto:dev@golang.org?subject=Hi`のような非ルート付きURLの場合、Go 1では以下のようにパースされます。
        ```go
        URL{
            Scheme: "mailto",
            Opaque: "dev@golang.org",
            RawQuery: "subject=Hi",
        }
        ```
    *   これにより、非ルート付きURLのパス部分がより明確に`Opaque`フィールドに格納されるようになり、`Path`フィールドとの混同がなくなりました。

7.  **`url.URL.RequestURI()` メソッドの追加**:
    *   `URL`構造体に新しい`RequestURI()`メソッドが追加されました。このメソッドは、HTTPリクエストのURI（パスとクエリ文字列）を生成するために使用されます。これは、WebサーバーやHTTPクライアントの実装において非常に有用な機能です。

8.  **更新に関する注意点**:
    *   このドキュメントでは、古いフィールドを使用しているコードはコンパイルエラーになるため、手動で更新する必要があることが明記されています。
    *   `gofix`ツールによる自動更新が困難である理由として、「セマンティックな変更」が挙げられています。これは、単なる名前の変更だけでなく、フィールドの意味合いや振る舞いが根本的に変わったため、ツールが自動的に適切な変換を行うことができないことを意味します。開発者は、これらの変更を理解し、コードのロジックを適切に調整する必要があります。

これらの変更は、`net/url`パッケージのAPIをよりクリーンで、予測可能で、安全なものにすることを目的としていました。特に、URLのエンコード/デコードのセマンティクスを明確にし、ユーザー情報やパスの扱いを改善することで、開発者がURL関連のバグに遭遇するリスクを低減しています。

## コアとなるコードの変更箇所

このコミット自体は、Go言語のソースコード（`net/url`パッケージの実装）を変更するものではありません。変更されたファイルは以下の2つです。

*   `doc/go1.html`
*   `doc/go1.tmpl`

これらのファイルは、Go 1の公式リリースノートおよびドキュメントの一部であり、`net/url`パッケージの変更点に関する説明が追加されています。具体的には、`url.URL`構造体のフィールドの削除・置換、および新しいメソッドの追加に関する詳細な記述がHTML形式で追加されています。

## コアとなるコードの解説

このコミットの「コアとなるコード」は、Go 1のリリースノートを構成するドキュメントファイルです。

`doc/go1.html`は、Go 1のリリースに関する主要な変更点をまとめたHTMLドキュメントです。`doc/go1.tmpl`は、このHTMLドキュメントを生成するためのテンプレートファイルです。

このコミットでは、これらのファイルに`net/url`パッケージの変更に関する新しいセクションが追加されています。追加された内容は、前述の「技術的詳細」で説明した`url.URL`構造体の変更点（`String`メソッドの挙動、`Raw`、`RawUserinfo`、`RawAuthority`、`RawPath`、`EncodedPath`、`OpaquePath`フィールドの削除、`User`、`Opaque`フィールドの追加、`RequestURI`メソッドの追加）を詳細に説明しています。

このドキュメントの追加は、Go 1への移行をスムーズにするための重要なステップであり、開発者が新しいAPIに適切に対応するためのガイドラインを提供します。特に、`gofix`ツールが自動的に修正できないセマンティックな変更については、ドキュメントによる詳細な説明が不可欠です。

## 関連リンク

*   Go 1 Release Notes (公式ドキュメント): [https://go.dev/doc/go1](https://go.dev/doc/go1) (このコミットで追加された内容が反映されています)
*   `net/url`パッケージのドキュメント: [https://pkg.go.dev/net/url](https://pkg.go.dev/net/url)

## 参考にした情報源リンク

*   Go 1 Release Notes: [https://go.dev/doc/go1](https://go.dev/doc/go1)
*   Go `net/url` package documentation: [https://pkg.go.dev/net/url](https://pkg.go.dev/net/url)
*   Go issue tracker (related discussions for `net/url` changes leading up to Go 1, e.g., CL 5575056 mentioned in the commit message): [https://go.dev/cl/5575056](https://go.dev/cl/5575056) (This is a Change List, not a direct issue, but it links to the review process.)
*   General understanding of URL components and parsing.
*   Understanding of `gofix` tool and its limitations.

