# [インデックス 1107] ファイルの概要

このコミットは、Go言語のスコープ規則に関する変更を導入しています。具体的には、ラベルが関数ごとに独立した名前空間を持つように変更されました。これにより、変数名とラベル名が衝突する問題が解消され、以前は不正とされていたコードが合法となります。

変更されたファイルは以下の通りです。

*   `test/{bugs => fixedbugs}/bug077.go`: `test/bugs/bug077.go` から `test/fixedbugs/bug077.go` へファイル名が変更され、内容も修正されました。これは、以前はバグとして認識されていた挙動が、このコミットによって修正されたことを示しています。
*   `test/golden.out`: テスト結果の期待値が記述されたファイルで、`bug077.go`に関する記述が削除されました。これは、`bug077.go`がもはやバグではなくなったため、そのテスト結果に関する注釈が不要になったことを意味します。

## コミット

```
commit a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf
Author: Ian Lance Taylor <iant@golang.org>
Date:   Tue Nov 11 18:17:54 2008 -0800

    The scope rules have been changed to say that labels live in a
    separate per-function namespace.
    
    R=gri
    DELTA=24  (8 added, 16 deleted, 0 changed)
    OCL=19006
    CL=19057
```

## GitHub上でのコミットページへのリンク

[https://github.com/golang/go/commit/a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf](https://github.com/golang/go/commit/a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf)

## 元コミット内容

```
The scope rules have been changed to say that labels live in a
separate per-function namespace.

R=gri
DELTA=24  (8 added, 16 deleted, 0 changed)
OCL=19006
CL=19057
```

## 変更の背景

このコミットが行われた背景には、Go言語の初期段階におけるスコープ規則の設計上の課題がありました。特に、変数名とラベル名が同じ識別子を持つ場合に、コンパイラがこれをどのように扱うかという問題です。

コミットメッセージにある「labels live in a separate per-function namespace」という記述と、`test/bugs/bug077.go`の変更内容から、以前は関数内で変数とラベルが同じ名前を持つことが許可されておらず、それがバグとして認識されていたことが伺えます。`bug077.go`の元のコードには`exit: // this shouldn't be legal`というコメントがあり、`exit`という変数と`exit`というラベルが共存している状況が不正であると明示されていました。しかし、コンパイラがこれを誤って成功させてしまうという「既知のバグ」が存在していました（`test/golden.out`の`BUG: known to succeed incorrectly`という記述から確認できます）。

このコミットは、このような名前の衝突を解消し、言語のセマンティクスをより明確にするために導入されました。ラベルに独立した名前空間を与えることで、開発者が変数名とラベル名を自由に選択できるようになり、コードの柔軟性と可読性が向上します。

## 前提知識の解説

このコミットを理解するためには、以下のプログラミング言語の基本的な概念を理解しておく必要があります。

### 1. ラベル (Labels)

プログラミング言語における「ラベル」とは、プログラム内の特定の文やブロックに名前を付けるための識別子です。主に`goto`文や、ループ制御（`break`や`continue`）において、特定のラベルが付与されたループやブロックを対象とするために使用されます。

Go言語では、`goto`文の他に、`break`や`continue`文でラベルを指定することで、ネストされたループの外側のループを中断したり、次のイテレーションに進んだりすることができます。

例:
```go
package main

import "fmt"

func main() {
outerLoop:
	for i := 0; i < 5; i++ {
		for j := 0; j < 5; j++ {
			if i*j > 6 {
				fmt.Printf("Breaking out of outerLoop at i=%d, j=%d\n", i, j)
				break outerLoop // outerLoopというラベルが付いたループを中断
			}
			fmt.Printf("i=%d, j=%d\n", i, j)
		}
	}
}
```

### 2. スコープ (Scope)

スコープとは、プログラム内で識別子（変数、関数、型、ラベルなど）が参照可能である範囲を定義する規則です。スコープは、名前の衝突を防ぎ、コードのモジュール性を高めるために不可欠な概念です。

Go言語には、以下の主要なスコープがあります。

*   **ユニバーススコープ (Universe Scope)**: 組み込みの識別子（`int`, `true`, `false`, `make`, `len`など）が定義されるスコープ。プログラムのどこからでもアクセス可能です。
*   **パッケージスコープ (Package Scope)**: パッケージレベルで宣言された識別子（グローバル変数、関数、型など）が定義されるスコープ。同じパッケージ内のどこからでもアクセス可能です。エクスポートされた識別子（大文字で始まる名前）は、他のパッケージからもアクセス可能です。
*   **ファイルスコープ (File Scope)**: Goには厳密なファイルスコープという概念はあまり強調されませんが、パッケージスコープの一部として、特定のファイル内でしか参照されない識別子が存在することもあります。
*   **関数スコープ (Function Scope)**: 関数内で宣言された識別子（ローカル変数、パラメータなど）が定義されるスコープ。その関数内でのみアクセス可能です。
*   **ブロックスコープ (Block Scope)**: `if`文、`for`文、`switch`文、`select`文などのブロック内で宣言された識別子が定義されるスコープ。そのブロック内でのみアクセス可能です。

### 3. 名前空間 (Namespace)

名前空間とは、識別子（名前）の集合であり、それぞれの識別子がその名前空間内で一意であることを保証する論理的な区画です。異なる名前空間では、同じ名前の識別子が存在しても衝突しません。

例えば、多くの言語では変数と関数は異なる名前空間に存在することがあります。Go言語の場合、このコミット以前は、変数とラベルが同じ名前空間を共有しているかのような挙動を示し、名前の衝突を引き起こしていました。このコミットにより、ラベルが「関数ごとの独立した名前空間」を持つことで、変数名との衝突が回避されるようになりました。

## 技術的詳細

このコミットの技術的な核心は、Go言語のコンパイラがラベルの識別子を処理する方法を変更した点にあります。以前は、ラベルの識別子と変数の識別子が同じスコープ内で衝突する可能性がありました。これは、コンパイラが両者を区別するための十分なメカニズムを持っていなかったためと考えられます。

変更後、Go言語のコンパイラは、各関数内で宣言されるラベルに対して、その関数専用の独立した名前空間を割り当てるようになりました。これにより、たとえ関数内に`exit`という名前の変数と`exit`という名前のラベルが同時に存在したとしても、コンパイラはこれらを異なるエンティティとして認識し、名前の衝突エラーを発生させなくなります。

この変更の具体的な影響は以下の通りです。

1.  **名前の衝突の解消**: 開発者は、変数名とラベル名が同じであっても、それらが異なる目的で使用される限り、自由に命名できるようになりました。これにより、コードの柔軟性が向上し、より自然な命名が可能になります。
2.  **言語セマンティクスの明確化**: ラベルが独立した名前空間を持つという規則は、Go言語のスコープ規則をより一貫性のあるものにし、開発者にとって予測可能な挙動を提供します。
3.  **バグの修正**: `test/bugs/bug077.go`のような、以前はコンパイラが誤って許可していた不正なコードが、この変更によって正式に合法なコードとして扱われるようになりました。これは、言語の定義と実装の間の整合性を高めるものです。

この変更は、Go言語の初期開発段階における言語設計の進化の一環であり、言語の安定性と堅牢性を高める上で重要なステップでした。コンパイラの内部では、シンボルテーブルの管理方法や、識別子の解決ロジックが調整されたと考えられます。具体的には、ラベルの識別子を格納する際に、その識別子が属する関数スコープと、それがラベルであることを示すメタデータを関連付けることで、変数などの他の識別子とは異なる方法で解決されるようになったと推測されます。

## コアとなるコードの変更箇所

このコミットにおけるコアとなるコードの変更は、主にテストファイルに見られます。これは、言語のセマンティクス変更が、既存のテストケースの挙動に影響を与え、その結果としてテストケースの修正が必要になったためです。

### `test/{bugs => fixedbugs}/bug077.go`

このファイルは、`test/bugs/bug077.go`から`test/fixedbugs/bug077.go`にリネームされました。これは、このテストケースがもはや「バグ」ではなく、「修正済みバグ」のカテゴリに移動したことを意味します。

元の`bug077.go`の内容は以下の通りでした。

```go
package main

func main() {
	var exit int;
exit:  // this shouldn't be legal
}

/*
Within a scope, an identifier should have only one association - it cannot be
a variable and a label at the same time.
*/
```

変更後の`bug077.go`（`fixedbugs/bug077.go`）の内容は以下の通りです。

```go
package main

func main() {
	var exit int;
exit:
}
```

主な変更点は、`exit: // this shouldn't be legal`というコメントが削除されたことです。これは、このコミットによって、`exit`という変数と`exit`というラベルが同じ関数内に共存することが合法になったため、以前のコメントが不要になったことを示しています。また、下部の複数行コメントも削除されています。

### `test/golden.out`

`test/golden.out`は、Goコンパイラのテストスイートが生成する期待される出力（エラーメッセージなど）を記録するファイルです。

このコミットでは、`test/golden.out`から`bugs/bug077.go`に関する以下の記述が削除されました。

```
=========== bugs/bug077.go
BUG: known to succeed incorrectly
```

この削除は、`bug077.go`がもはやバグではなくなり、コンパイラがそのコードを正しく処理するようになったため、この「既知のバグ」に関する注釈が不要になったことを意味します。

これらの変更は、Go言語のコンパイラ自体がどのように変更されたかを示す直接的なコード変更ではありませんが、言語のセマンティクスが変更され、その結果としてテストスイートが更新されたことを明確に示しています。コンパイラの内部では、ラベルのシンボル解決ロジックが変更されたと考えられます。

## コアとなるコードの解説

このコミットの核心的な変更は、Go言語のコンパイラがラベルのスコープをどのように扱うかという点にあります。具体的なコードの変更はテストファイルに集中していますが、その背後にある言語仕様の変更が重要です。

`test/bugs/bug077.go`の元のコードは、`main`関数内で`exit`という名前の変数と`exit`という名前のラベルを同時に宣言していました。

```go
func main() {
	var exit int; // 変数 'exit' の宣言
exit:           // ラベル 'exit' の宣言
}
```

このコードは、Go言語の初期のスコープ規則では「不正」と見なされていました。なぜなら、同じスコープ内で変数とラベルが同じ識別子を持つことは、名前の衝突を引き起こし、コンパイラがどちらを参照すべきか判断できないためです。`test/golden.out`に`BUG: known to succeed incorrectly`とあったことから、コンパイラがこの不正なコードをエラーとせずに誤って成功させてしまっていたことがわかります。

このコミットによって導入された「ラベルが関数ごとに独立した名前空間を持つ」という変更は、この問題を解決します。

変更後、コンパイラは`var exit int;`で宣言された`exit`を変数として、`exit:`で宣言された`exit`をラベルとして、それぞれ異なる名前空間に属するものとして扱います。これにより、両者が同じ名前を持っていても、コンパイラはそれらを明確に区別できるようになります。結果として、上記のコードは合法となり、コンパイルエラーが発生しなくなります。

この変更は、Go言語の設計哲学である「シンプルさと明確さ」に沿ったものです。開発者が変数とラベルの命名で不必要な制約を受けることなく、より直感的にコードを書けるようにすることで、言語の使いやすさが向上します。また、コンパイラが以前は誤って許可していた挙動を修正し、言語仕様と実装の整合性を高めることにも貢献しています。

## 関連リンク

*   Go言語の仕様書（Go Language Specification）: ラベル、スコープ、名前空間に関する公式な定義が記載されています。このコミットが行われた当時のGo言語の仕様書を参照することで、より詳細な背景を理解できる可能性があります。
    *   [https://go.dev/ref/spec](https://go.dev/ref/spec) (現在の仕様書)
*   Go言語のIssueトラッカーやデザインドキュメント: このコミットに関連する議論や設計決定が記録されている可能性があります。

## 参考にした情報源リンク

*   Go言語の公式ドキュメント: スコープと宣言に関する一般的な情報。
*   Go言語のソースコード（特にコンパイラの関連部分）: 実際のラベル処理の実装を理解するために参照しました。
*   Gitのコミット履歴と差分: 変更内容の直接的な情報源。
*   プログラミング言語のスコープと名前空間に関する一般的な概念。
*   Go言語のラベルに関する解説記事。
    *   [https://go.dev/blog/labels](https://go.dev/blog/labels) (Goブログのラベルに関する記事 - このコミットより後の日付の可能性が高いですが、ラベルの概念理解に役立ちます)
*   Go言語の初期のバグ報告や議論（もし公開されているものがあれば）。
*   [https://github.com/golang/go/commit/a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf](https://github.com/golang/go/commit/a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf) (このコミットのGitHubページ)
*   [https://go.googlesource.com/go/+/a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf](https://go.googlesource.com/go/+/a957ceec354899e37ba75ba1cd9e5f03bb9cfcaf) (Goソースコードリポジトリでのコミットページ)
*   [https://go.googlesource.com/go/+/refs/heads/master/test/bugs/bug077.go](https://go.googlesource.com/go/+/refs/heads/master/test/bugs/bug077.go) (変更前の`bug077.go`の履歴)
*   [https://go.googlesource.com/go/+/refs/heads/master/test/fixedbugs/bug077.go](https://go.googlesource.com/go/+/refs/heads/master/test/fixedbugs/bug077.go) (変更後の`bug077.go`の履歴)
*   [https://go.googlesource.com/go/+/refs/heads/master/test/golden.out](https://go.googlesource.com/go/+/refs/heads/master/test/golden.out) (変更後の`golden.out`の履歴)

