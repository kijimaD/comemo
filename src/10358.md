# [インデックス 10358] ファイルの概要

このコミットは、Go言語のランタイムにおけるOpenBSD固有のスレッド関連コードから、もはや使用されなくなった列挙型（enum）を削除するものです。これらの列挙型は、ミューテックスの状態管理やスピンロックの挙動を定義していましたが、関連するコードが`lock_sema.c`という別のファイルに移動されたため、`thread.c`からは不要となりました。これはコードの整理と冗長性の排除を目的とした変更です。

## コミット

- **コミットハッシュ**: `13dc53055f7fb6e15b640cdb24284c481bd4402c`
- **Author**: Joel Sing <jsing@google.com>
- **Date**: Sun Nov 13 03:58:24 2011 +1100
- **コミットメッセージ**:
    ```
    runtime: remove no longer used enums for openbsd
    
    The code that used these has been moved to lock_sema.c.
    
    R=golang-dev, rsc
    CC=golang-dev
    https://golang.org/cl/5376062
    ```

## GitHub上でのコミットページへのリンク

[https://github.com/golang/go/commit/13dc53055f7fb6e15b640cdb24284c481bd4402c](https://github.com/golang/go/commit/13dc53055f7fb6e15b640cdb24284c481bd4402c)

## 元コミット内容

このコミットは、GoランタイムのOpenBSDプラットフォーム向けコードから、使用されなくなった列挙型を削除します。これらの列挙型は、以前は`src/pkg/runtime/openbsd/thread.c`ファイル内で定義されていましたが、それらを使用していたコードが`lock_sema.c`に移動されたため、`thread.c`内では冗長となりました。

## 変更の背景

Go言語のランタイムは、様々なオペレーティングシステム（OS）上で動作するように設計されており、OS固有の低レベルな処理（スレッド管理、メモリ管理、同期プリミティブなど）は、それぞれのOSに対応するファイルで実装されています。

このコミットの背景には、Goランタイムにおける同期プリミティブ（ミューテックスやセマフォなど）の実装に関するリファクタリングがあります。具体的には、OpenBSD環境でのスレッド同期に使用されていた一部のロジックが、`src/pkg/runtime/openbsd/thread.c`から、より汎用的な同期メカニズムを扱う`lock_sema.c`（またはそれに相当するファイル）へと移動されたと考えられます。

このコード移動に伴い、`thread.c`内に残っていた、移動されたコードでのみ使用されていた列挙型が不要になりました。不要なコードを削除することは、コードベースのクリーンアップ、保守性の向上、コンパイル時間の短縮、そして潜在的な混乱の回避に繋がります。

## 前提知識の解説

### Go言語のランタイム (Runtime)

Go言語のプログラムは、Goランタイムと呼ばれる軽量な実行環境上で動作します。ランタイムは、ガベージコレクション、ゴルーチン（軽量スレッド）のスケジューリング、チャネル通信、同期プリミティブ、システムコールインターフェースなど、Goプログラムの実行に必要な低レベルな機能を提供します。OS固有の機能は、各OSに対応するディレクトリ（例: `src/pkg/runtime/openbsd`）に実装されています。

### 列挙型 (Enum)

列挙型は、プログラミングにおいて、関連する定数群に名前を付けて定義するためのデータ型です。これにより、コードの可読性が向上し、マジックナンバー（意味不明な数値定数）の使用を避けることができます。C言語では、`enum`キーワードを使用して定義されます。

### ミューテックス (Mutex)

ミューテックス（Mutual Exclusionの略）は、並行プログラミングにおける同期プリミティブの一つです。複数のスレッドやゴルーチンが共有リソースに同時にアクセスするのを防ぎ、データ競合（data race）を回避するために使用されます。ミューテックスは「ロック」と「アンロック」の操作を持ち、一度に一つのスレッドのみがロックを取得できます。

### スピンロック (Spinlock)

スピンロックも同期プリミティブの一種です。ミューテックスがロックされている場合、ロックを取得しようとするスレッドは通常、OSによってスリープ状態にされ、CPUを解放します。しかし、スピンロックの場合、ロックが解放されるまで、スレッドはCPUを占有したままループ（スピン）し続けます。これは、ロックが非常に短時間で解放されることが予想される場合に、スレッドのコンテキストスイッチのオーバーヘッドを避けるために使用されます。

-   **アクティブスピン (Active Spin)**: ロックが解放されるまで、積極的にCPUを消費してループし続ける状態。
-   **パッシブスピン (Passive Spin)**: アクティブスピンを一定回数行った後、それでもロックが解放されない場合に、スレッドをスリープ状態にするなどしてCPUを解放する状態。これは、アクティブスピンとブロッキング（スリープ）のハイブリッド戦略です。

### OpenBSD

OpenBSDは、セキュリティを重視して開発されたUNIX系オペレーティングシステムです。Goランタイムは、OpenBSDを含む様々なOSをサポートしており、それぞれのOSの特性に合わせた低レベルな実装が必要となります。

### `thread.c`と`lock_sema.c`

-   `thread.c`（または`thread_openbsd.c`のようなファイル）は、通常、特定のOS上でのスレッドの作成、管理、終了など、スレッドに関する低レベルなOS固有のインターフェースを実装するファイルです。
-   `lock_sema.c`（または`lock_sema_openbsd.c`のようなファイル）は、セマフォやミューテックスといった同期プリミティブの具体的な実装、特にそれらのロック/アンロックメカニズムや、スピンロックの挙動などを扱うファイルです。このコミットでは、`thread.c`にあったミューテックスやスピンロック関連の定義が、より適切な`lock_sema.c`に移動されたことを示唆しています。

## 技術的詳細

このコミットで削除された列挙型は、以下の通りです。

-   `MUTEX_UNLOCKED = 0`
-   `MUTEX_LOCKED = 1`
-   `MUTEX_SLEEPING = 2`
    -   これらはミューテックスの内部状態を表す定数です。ミューテックスがロックされていない状態、ロックされている状態、そしてロックを待っているスレッドがスリープしている状態を示します。
-   `ACTIVE_SPIN = 4`
-   `ACTIVE_SPIN_CNT = 30`
-   `PASSIVE_SPIN = 1`
    -   これらはスピンロックの挙動を制御するための定数です。`ACTIVE_SPIN`はアクティブスピンが有効であることを示唆し、`ACTIVE_SPIN_CNT`はアクティブスピンを試みる最大回数（この場合は30回）を定義しています。`PASSIVE_SPIN`は、アクティブスピン後にパッシブスピン（またはブロッキング）に移行する際の挙動に関連する可能性があります。

これらの列挙型が`thread.c`から削除されたのは、それらを使用する実際のミューテックスやスピンロックのロジックが`lock_sema.c`に移動されたためです。Goランタイムの設計では、OS固有の低レベルな同期プリミティブの実装は、`lock_sema.c`のような専用のファイルに集約されることが一般的です。これにより、コードのモジュール性が向上し、関連する機能がまとめて管理されるようになります。

`thread.c`は、スレッドのライフサイクル管理（作成、終了など）に特化し、同期プリミティブの内部状態定義は`lock_sema.c`に任せるという役割分担が明確になった結果、`thread.c`内のこれらの列挙型は冗長となり、削除されました。

## コアとなるコードの変更箇所

```diff
--- a/src/pkg/runtime/openbsd/thread.c
+++ b/src/pkg/runtime/openbsd/thread.c
@@ -8,14 +8,6 @@
 
 enum
 {
--	MUTEX_UNLOCKED = 0,\n-	MUTEX_LOCKED = 1,\n-	MUTEX_SLEEPING = 2,\n-\n-	ACTIVE_SPIN = 4,\n-	ACTIVE_SPIN_CNT = 30,\n-	PASSIVE_SPIN = 1,\n-\n 	ESRCH = 3,\n 	ENOTSUP = 91,\n 
```

## コアとなるコードの解説

上記のdiffを見ると、`src/pkg/runtime/openbsd/thread.c`ファイル内の`enum`ブロックから、以下の8行が削除されていることが明確にわかります。

-   `MUTEX_UNLOCKED = 0,`
-   `MUTEX_LOCKED = 1,`
-   `MUTEX_SLEEPING = 2,`
-   `ACTIVE_SPIN = 4,`
-   `ACTIVE_SPIN_CNT = 30,`
-   `PASSIVE_SPIN = 1,`

これらの行は、前述の通り、ミューテックスの状態とスピンロックの挙動を定義する列挙型定数です。これらの削除は、これらの定数を使用するコードが`thread.c`から完全に移動したことを意味します。残された`ESRCH = 3,`と`ENOTSUP = 91,`は、おそらくOpenBSDシステムコールからのエラーコードであり、`thread.c`内で引き続き関連するエラーハンドリングに使用されるため残されています。

この変更は、コードの依存関係を整理し、各ファイルがその主要な責務に集中するようにするための典型的なリファクタリングパターンです。これにより、`thread.c`はスレッド管理に、`lock_sema.c`は同期プリミティブの実装に特化するという、よりクリーンなアーキテクチャが実現されます。

## 関連リンク

-   Go CL 5376062: [https://golang.org/cl/5376062](https://golang.org/cl/5376062)

## 参考にした情報源リンク

-   Go言語のソースコード（特に`src/runtime`ディレクトリ）
-   Go言語のドキュメント
-   並行プログラミングに関する一般的な知識（ミューテックス、スピンロックなど）
-   OpenBSDのシステムプログラミングに関する一般的な知識
-   [https://github.com/golang/go/commit/13dc53055f7fb6e15b640cdb24284c481bd4402c](https://github.com/golang/go/commit/13dc53055f7fb6e15b640cdb24284c481bd4402c)
-   [https://golang.org/cl/5376062](https://golang.org/cl/5376062)

