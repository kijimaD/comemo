# [インデックス 11287] ファイルの概要

このコミットは、Go言語の2012年1月20日時点での週次スナップショット（`weekly.2012-01-20`）の内容を反映したものです。主に、実験的なパッケージの安定版への昇格、APIの整合性向上、型安全性の強化、および標準ライブラリの様々な改善とバグ修正が含まれています。特に、`exp/sql`パッケージが`database/sql`として安定化されたこと、ネットワーク関連のタイムアウト設定が`SetDeadline`に統一されたこと、ファイルモードの扱いが`uint32`から`os.FileMode`型に変更されたことなどが主要な変更点として挙げられます。

## コミット

```
commit 22ef504654079bd0a6f227b7485ce0657bf205e1
Author: Nigel Tao <nigeltao@golang.org>
Date:   Fri Jan 20 16:57:10 2012 +1100

    weekly.2012-01-20
    
    R=r
    CC=golang-dev
    https://golang.org/cl/5557067
```

## GitHub上でのコミットページへのリンク

[https://github.com/golang/go/commit/22ef504654079bd0a6f227b7485ce065bf205e1](https://github.com/golang/go/commit/22ef504654079bd0a6f227b7485ce065bf205e1)

## 元コミット内容

```
weekly.2012-01-20

R=r
CC=golang-dev
https://golang.org/cl/5557067
```

## 変更の背景

このコミットは、Go言語の標準ライブラリとツールチェインの継続的な進化の一環として行われました。Go言語の開発初期段階では、新しいAPIや機能はまず`exp`（experimental）パッケージとして導入され、コミュニティからのフィードバックや実際の使用を通じて安定性が確認された後に、標準パッケージへと昇格されるというプロセスが取られていました。

この週次スナップショットの主な背景は以下の通りです。

1.  **APIの安定化と標準化**: `exp/sql`パッケージが`database/sql`として安定版に移行したことは、GoにおけるデータベースアクセスAPIの成熟を示す重要なステップです。これにより、Goアプリケーションでのデータベース操作がより標準的かつ予測可能な方法で行えるようになりました。
2.  **一貫性と型安全性**: `net`パッケージにおけるタイムアウト設定の`SetDeadline`への統一や、`os`パッケージでのファイルモードの`os.FileMode`型への変更は、APIの一貫性を高め、誤用を防ぐための型安全性を強化する目的があります。特に`uint32`のような汎用的な型から特定の意味を持つ型への変更は、コードの可読性と堅牢性を向上させます。
3.  **パフォーマンスとセキュリティの改善**: `crypto/hmac`におけるハッシュ関数指定の明確化や、`crypto/elliptic`での定数時間P224の実装などは、暗号関連の処理におけるセキュリティとパフォーマンスの向上を目指しています。
4.  **継続的な改善とバグ修正**: 週次スナップショットは、Go開発チームが定期的に行っていた、広範なバグ修正、ドキュメントの更新、テストの改善、ビルドスクリプトの整理など、プロジェクト全体の健全性を維持するための取り組みを反映しています。

これらの変更は、Go言語がより堅牢で、使いやすく、高性能な言語として成長していく過程で不可欠なものでした。

## 前提知識の解説

このコミットの変更内容を理解するためには、以下のGo言語の概念と背景知識が役立ちます。

1.  **`exp`パッケージ**: Go言語の標準ライブラリには、`exp`（experimental）というプレフィックスを持つパッケージ群が存在しました。これらは、まだAPIが安定しておらず、将来的に変更される可能性がある実験的な機能やAPIを提供していました。コミュニティからのフィードバックや十分なテストを経て安定したと判断された場合、`exp`プレフィックスが外され、標準パッケージとして昇格されます。`exp/sql`から`database/sql`への移行はその典型例です。
2.  **`database/sql`パッケージ**: Go言語の標準ライブラリに含まれる、データベースにアクセスするための汎用的なインターフェースを提供するパッケージです。特定のデータベースシステム（例: MySQL, PostgreSQL, SQLite）に依存せず、統一されたAPIを通じてデータベース操作を行うことができます。実際のデータベースとの接続には、このパッケージが定義するインターフェースを実装したデータベースドライバーが必要です。
3.  **`net`パッケージとタイムアウト**: `net`パッケージは、ネットワークI/Oのプリミティブを提供します。ネットワーク通信では、接続の確立やデータの送受信に時間がかかりすぎると、アプリケーションの応答性が低下したり、リソースが枯渇したりする可能性があります。このため、タイムアウトを設定して、一定時間内に操作が完了しない場合にエラーを返す仕組みが重要です。
    *   **`SetTimeout`**: 特定の操作（例: 読み込み、書き込み）に対するタイムアウトを設定するメソッド。
    *   **`SetDeadline`**: 読み込みと書き込みの両方に対して、操作が完了しなければならない絶対的な時刻（デッドライン）を設定するメソッド。`SetTimeout`よりも柔軟で、より厳密な時間管理が可能です。
4.  **`os.FileMode`**: `os`パッケージは、オペレーティングシステムとの相互作用（ファイル操作、プロセス管理など）を提供します。ファイルやディレクトリのパーミッション（読み取り、書き込み、実行権限など）は、通常、数値（例: Unixの`chmod`コマンドで使用される8進数）で表現されます。Goでは、これらのパーミッションを表現するために`os.FileMode`という型が導入されており、`uint32`のような汎用的な整数型よりも、その意味が明確になります。`os.ModeSticky`は、ディレクトリに設定される特殊なパーミッションビットで、そのディレクトリ内のファイルは、ファイルの所有者、ディレクトリの所有者、またはrootユーザーのみが削除または名前変更できることを意味します。
5.  **`image`パッケージと`YCbCr`**: `image`パッケージは、画像処理の基本的なインターフェースと実装を提供します。`YCbCr`は、輝度（Y）と2つの色差（Cb, Cr）で色を表現する色空間です。これは、JPEGなどの画像圧縮によく使用されます。`image.YCbCr`構造体は、この色空間の画像を表現するためのもので、内部的にピクセルデータをバッファとして保持します。
6.  **`crypto/hmac`パッケージ**: `crypto/hmac`パッケージは、HMAC（Keyed-Hash Message Authentication Code）の実装を提供します。HMACは、メッセージの認証と完全性を保証するために、秘密鍵とハッシュ関数（例: MD5, SHA-1, SHA-256）を組み合わせて使用するメカニズムです。

## 技術的詳細

このコミットに含まれる主要な技術的変更点は以下の通りです。

1.  **`exp/sql`から`database/sql`への昇格**:
    *   **変更内容**: 実験的なデータベースパッケージ`exp/sql`が、標準ライブラリの`database/sql`として正式に採用されました。これは、Go言語におけるデータベースアクセスのAPIが安定し、本番環境での使用に適していると判断されたことを意味します。
    *   **影響**: 既存の`exp/sql`を使用していたコードは、インポートパスを`database/sql`に変更する必要があります。これにより、Goアプリケーションでのデータベース操作がより標準化され、将来的な互換性が保証されます。
    *   **関連するサブ変更**:
        *   `exp/sql`内で、`[]byte`へのスキャン時にデフォルトでコピーを行うようになりました。これは、スキャンされたデータが一時的なバッファを参照するのではなく、独立したコピーとして扱われることで、データのライフサイクル管理が容易になり、潜在的なバグを防ぎます。
        *   `NullableString`が`NullString`にリネームされ、パラメータとしての使用が許可されました。これは、データベースのNULL可能な文字列型をGoの型システムでより適切に表現し、利用しやすくするための改善です。

2.  **`net`パッケージの`SetTimeout`から`SetDeadline`への変更**:
    *   **変更内容**: `net`パッケージ内の接続（`net.Conn`）やリスナー（`net.Listener`）のタイムアウト設定メソッドが、`SetTimeout`から`SetDeadline`に変更されました。
    *   **背景**: `SetTimeout`は特定の操作（読み込みまたは書き込み）に対して相対的なタイムアウトを設定しますが、`SetDeadline`は読み込みと書き込みの両方に対して絶対的な期限を設定します。`SetDeadline`の方がより柔軟で、複雑なネットワークプロトコルやアプリケーションロジックにおいて、より正確な時間管理を可能にします。
    *   **影響**: ネットワークI/Oのタイムアウト処理を記述する際、絶対時刻ベースでの制御が推奨されるようになりました。これにより、より予測可能で堅牢なネットワークアプリケーションの構築が促進されます。

3.  **`os`パッケージにおける`os.FileMode`の導入**:
    *   **変更内容**: `os`パッケージの多くの関数（例: `os.Chmod`, `os.MkdirAll`など）が、ファイルパーミッションの引数として`uint32`の代わりに`os.FileMode`型を受け取るようになりました。また、`os.ModeSticky`定数が定義されました。
    *   **背景**: `uint32`は汎用的な整数型であり、その値がファイルパーミッションを意味することをコードから直接読み取ることは困難でした。`os.FileMode`という専用の型を導入することで、APIの意図が明確になり、型システムによる誤用チェックが可能になります。
    *   **影響**: ファイルパーミッションを扱うコードの可読性と堅牢性が向上します。開発者は、`os.FileMode`型の定数（例: `os.ModePerm`, `os.ModeDir`など）やビット演算子を組み合わせて、より安全にパーミッションを指定できるようになります。

4.  **`image.YCbCr`のバッファセマンティクス変更**:
    *   **変更内容**: `image.YCbCr`構造体の最初のバッファ要素の意味が、`image.RGBA`などの他の画像タイプと一致するように変更されました。
    *   **背景**: `image`パッケージ内の異なる画像タイプ間で、ピクセルデータのメモリレイアウトやアクセス方法に一貫性を持たせることで、画像処理コードの記述を簡素化し、バグを減らすことを目的としています。
    *   **影響**: `YCbCr`画像を直接操作する低レベルのコードに影響を与える可能性がありますが、高レベルのAPIを使用している場合は影響が少ないでしょう。

5.  **`crypto/hmac`におけるハッシュ関数指定の明確化**:
    *   **変更内容**: `crypto/hmac`パッケージの`NewMD5`, `NewSHA1`, `NewSHA256`関数が非推奨（deprecated）となり、代わりに`New`関数を使用してハッシュ関数を明示的に渡すことが推奨されるようになりました。
    *   **例**: `hmac.New(sha256.New, key)`のように使用します。
    *   **背景**: 特定のハッシュ関数に特化したファクトリ関数を非推奨にすることで、APIの柔軟性を高め、将来的に新しいハッシュ関数が追加された場合でも、既存のAPIを変更することなく対応できるようになります。また、どのハッシュ関数が使用されているかをコード上でより明確にすることができます。
    *   **関連するサブ変更**: HMAC-SHA224およびHMAC-SHA384/512のサポートが追加されました。これは、より強力なハッシュアルゴリズムの需要に応えるものです。

その他、多数の細かい改善が含まれています。

*   **`buildscripts`**: ビルドスクリプトが専用のディレクトリに移動され、整理されました。
*   **`cmd/go`**: `gotest`に関するドキュメントの言及が削除され、パッケージスキャン時に`_obj`ディレクトリがスキップされるようになりました。
*   **`container/heap`**: パッケージドキュメントが改善されました。
*   **`crypto/elliptic`**: 定数時間P224の実装が追加され、サイドチャネル攻撃に対する耐性が向上しました。
*   **`encoding/json`**: タグ名に`/`と`%`が許可され、アングルブラケットのエスケープがドキュメント化されました。
*   **`go/doc`**: インポートの収集機能が追加され、テストフレームワークが書き直され、完成しました。
*   **`godoc`**: `cmd`ドキュメントの見出しにアンカーが追加され、HTMLページメタデータがJSONで指定できるようになりました。
*   **`runtime`**: FreeBSD/386およびamd64向けの`runtime.usleep`が実装され、Darwin向けの`madvise`と`SysUnused`が追加されました。
*   **`time`**: 経過時間を返す`Since`関数が追加されました。

これらの変更は、Go言語の標準ライブラリがより成熟し、堅牢で、開発者にとって使いやすいものになるための継続的な努力を反映しています。

## コアとなるコードの変更箇所

このコミットは、主に以下の2つのファイルに影響を与えています。

1.  `.hgtags`:
    *   このファイルは、Mercurialリポジトリのタグ情報を管理するために使用されていました。GoプロジェクトはかつてMercurialで管理されており、このファイルは特定のコミットハッシュとそれに対応するタグ（この場合は週次スナップショットのタグ）を記録していました。
    *   変更内容: `354b17404643c0f1a710bdc48927dff02f203ae3 weekly`という行が削除されました。これは、おそらく古い週次タグの参照を削除し、新しい週次スナップショットのタグ（`weekly.2012-01-20`）が追加されたことを示唆しています。

2.  `doc/devel/weekly.html`:
    *   このファイルは、Go言語の週次スナップショットのリリースノートや変更履歴をまとめたHTMLドキュメントです。
    *   変更内容: `2012-01-20`のセクションが追加され、この週のスナップショットに含まれる主要な変更点と、貢献者名が詳細にリストアップされています。具体的には、パッケージのリネーム、APIの変更、新機能の追加、バグ修正などが箇条書きで記述されています。このファイルへの変更が、このコミットの主要な情報源となっています。

実際のコード変更は、この`weekly.html`に記述されている内容に対応する、Go言語の様々なソースファイル（`exp/sql`, `net`, `os`, `crypto/hmac`など）で行われています。しかし、このコミット自体は、それらの変更をまとめた週次スナップショットのリリースノートを更新し、タグ情報を調整するものです。

## コアとなるコードの解説

このコミット自体は、Go言語のソースコードそのものに直接的な機能変更を加えるものではなく、主に以下の2つの側面でプロジェクトの管理と情報提供を行っています。

1.  **`.hgtags`の更新**:
    *   このファイルの変更は、Goプロジェクトのバージョン管理システム（当時はMercurial）におけるタグ付けの慣習を反映しています。`weekly`という汎用的なタグが削除され、`weekly.2012-01-15`のような日付付きの具体的なタグが使用されるようになったことを示唆しています。これにより、特定の週次スナップショットをより正確に参照できるようになり、バージョン管理の明確性が向上します。

2.  **`doc/devel/weekly.html`の更新**:
    *   このHTMLファイルへの追加は、Go言語の進化をコミュニティに伝えるための重要なドキュメント更新です。開発者が新しいスナップショットに更新する際に、どのような変更が加えられたのかを迅速に把握できるように、詳細なリリースノートが提供されています。
    *   このドキュメントは、`exp/sql`から`database/sql`への移行、`SetTimeout`から`SetDeadline`への変更、`os.FileMode`の導入など、Go言語のAPIがどのように成熟し、改善されていったかを示す歴史的な記録としても機能します。
    *   特に、各変更点に貢献者の名前が記載されていることは、Goコミュニティのオープンな開発プロセスと、多くの開発者の協力によってプロジェクトが成り立っていることを示しています。

要するに、このコミットは、Go言語の週次リリースサイクルにおける「リリースノートの作成」と「バージョンタグの管理」という側面を担っており、Go言語自体の機能変更は、このコミットが参照する他のコミット群によって行われています。このコミットは、それらの変更を統合し、ユーザーに情報を提供する「まとめ」の役割を果たしています。

## 関連リンク

*   Go言語の公式ドキュメント: [https://golang.org/doc/](https://golang.org/doc/)
*   Go言語の週次スナップショットに関する情報（当時のもの）: [https://golang.org/doc/devel/weekly.html](https://golang.org/doc/devel/weekly.html) (このコミットで更新されたファイル)
*   `database/sql`パッケージのドキュメント: [https://golang.org/pkg/database/sql/](https://golang.org/pkg/database/sql/)
*   `net`パッケージのドキュメント: [https://golang.org/pkg/net/](https://golang.org/pkg/net/)
*   `os`パッケージのドキュメント: [https://golang.org/pkg/os/](https://golang.org/pkg/os/)
*   `image`パッケージのドキュメント: [https://golang.org/pkg/image/](https://golang.org/pkg/image/)
*   `crypto/hmac`パッケージのドキュメント: [https://golang.org/pkg/crypto/hmac/](https://golang.org/pkg/crypto/hmac/)

## 参考にした情報源リンク

*   Go言語の公式リポジトリ（GitHub）: [https://github.com/golang/go](https://github.com/golang/go)
*   Go言語のコミット履歴（Mercurial時代を含む）: [https://go.googlesource.com/go](https://go.googlesource.com/go)
*   Go言語の`exp`パッケージに関する議論や歴史（一般的な情報源）
    *   "Go's experimental packages" - 関連するブログ記事やメーリングリストの議論
*   Go言語のAPI設計原則に関する情報（一般的な情報源）
    *   "Effective Go" や "Go Code Review Comments" など、Goの慣習や設計思想に関する公式ドキュメント。
*   HMACの概念に関する一般的な情報源（例: Wikipedia, RFCなど）
*   ファイルパーミッションに関する一般的な情報源（例: Unixの`chmod`コマンドに関するドキュメント）
*   Go言語の週次スナップショットの仕組みに関する情報（当時の開発プロセスに関する情報）
    *   Go開発者メーリングリストのアーカイブ (golang-dev)
    *   Goブログの過去記事

