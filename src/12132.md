# [インデックス 12132] ファイルの概要

このコミットは、Go言語の標準ライブラリから `os.Wait` 関数が完全に削除されたことに伴い、`cmd/fix` ツールから `os.Wait` 関連の修正ロジックを削除するものです。これにより、`gofix` はもはや存在しない `os.Wait` の呼び出しを修正しようとせず、ドキュメントもそれに合わせて更新されます。

## コミット

```
commit 6d3530270454316f64dc71e6b6c2231dba56d69f
Author: David Symonds <dsymonds@golang.org>
Date:   Wed Feb 22 15:46:31 2012 +1100

    cmd/fix: remove os.Wait gofix.
    
    The os.Wait function has been removed entirely, so there's no point in fixing code that called it.
    
    R=r
    CC=golang-dev
    https://golang.org/cl/5685078
```

## GitHub上でのコミットページへのリンク

[https://github.com/golang/go/commit/6d3530270454316f64dc71e6b6c2231dba56d69f](https://github.com/golang/go/commit/6d3530270454316f64dc71e6b6c2231dba56d69f)

## 元コミット内容

`cmd/fix: os.Wait gofix を削除。`

`os.Wait 関数が完全に削除されたため、それを呼び出すコードを修正する意味がなくなった。`

`R=r`
`CC=golang-dev`
`https://golang.org/cl/5685078`

## 変更の背景

このコミットの背景には、Go言語の標準ライブラリにおける重要な変更、具体的には `os` パッケージ内の `Wait` 関数が完全に削除されたという事実があります。

Go言語は、その進化の過程でAPIの変更や改善を頻繁に行います。特にGo 1のリリース前は、APIの安定化に向けて多くの変更が加えられていました。`os.Wait` 関数は、プロセスが終了するのを待機するために使用されていましたが、より柔軟で堅牢なプロセス管理のために、`os.Process` 型のメソッドである `Wait` に置き換えられました。

`gofix` (または `cmd/fix`) は、Go言語のツールチェーンの一部であり、Go言語のAPIが変更された際に、古いAPIを使用しているコードを新しいAPIに自動的に書き換えるためのユーティリティです。これにより、開発者は手動で大量のコードを修正する手間を省き、Go言語のバージョンアップにスムーズに対応できるようになります。

`os.Wait` が完全に削除されたため、`gofix` がこの関数を修正するためのロジックを保持しておく必要がなくなりました。むしろ、存在しない関数を修正しようとすることは無意味であり、ツールの複雑性を増すだけです。したがって、このコミットは、`os.Wait` 関連の `gofix` ロジックを削除し、ドキュメントを更新することで、コードベースの整理と整合性の維持を図っています。

## 前提知識の解説

### `os.Wait` 関数 (旧)

Go言語の初期のバージョンでは、`os` パッケージに `Wait` という関数が存在しました。この関数は、子プロセスの終了を待機し、その終了ステータスを取得するために使用されていました。しかし、この関数は `os.Process` 型のインスタンスに関連付けられておらず、プロセスの管理という観点からすると、よりオブジェクト指向的なアプローチが望ましいと判断されました。

### `os.Process.Wait` メソッド (現行)

`os.Wait` 関数が削除された後、その機能は `os.Process` 型のメソッドである `Wait()` に移行されました。`os.Process` は、`os.StartProcess` などによって起動された外部プロセスを表す型です。この変更により、特定のプロセスインスタンスに対して `Wait` を呼び出すという、より自然で直感的なAPI設計が実現されました。

### `gofix` (または `cmd/fix`)

`gofix` は、Go言語のソースコードを自動的に書き換えるためのコマンドラインツールです。Go言語のAPIが変更された際に、古いAPIの呼び出しを新しいAPIの呼び出しに変換する役割を担います。例えば、関数のシグネチャが変更された場合や、関数が別のパッケージに移動した場合などに `gofix` が利用されます。これにより、Go言語のバージョンアップに伴うコードの修正作業を大幅に軽減し、Goエコシステムの進化を円滑に進めることができます。

`gofix` は、Goの抽象構文木 (AST) を解析し、定義されたルールに基づいてコードを変換します。このコミットで削除された `oswait.go` は、まさに `os.Wait` の呼び出しを修正するための特定のルールを実装していました。

### 後方互換性 (Backward Compatibility)

ソフトウェア開発において、後方互換性とは、新しいバージョンのソフトウェアが古いバージョンのデータやコードを問題なく扱える能力を指します。Go言語は、Go 1のリリース以降、厳格な後方互換性ポリシーを維持しています。しかし、Go 1リリース前は、APIの安定化のために破壊的な変更も行われていました。`os.Wait` の削除は、Go 1リリース前のこのような破壊的な変更の一例です。`gofix` は、このような破壊的な変更の影響を緩和し、開発者がコードを新しいバージョンに移行するのを支援する重要なツールでした。

## 技術的詳細

このコミットの技術的な詳細は、主に `gofix` ツールの内部動作と、Go言語のAPI変更への対応方法に焦点を当てています。

### `gofix` の `os.Wait` 修正ロジック

削除された `src/cmd/fix/oswait.go` ファイルは、`gofix` が `os.Wait` の呼び出しをどのように処理していたかを示しています。このファイルには `oswaitFix` という `fix` 構造体が定義されており、`oswait` という関数が実際の修正ロジックを実装していました。

`oswait` 関数は、GoのASTを走査し、`os.Wait` の呼び出しを探していました。特に、引数として `0` を渡している `os.Wait(0)` のような呼び出しを対象としていました。これは、`os.Wait` が引数なしで呼び出されるように変更された際に、`gofix` が自動的に `0` の引数を削除するように設計されていたためです。それ以外の引数を持つ `os.Wait` の呼び出しについては、`gofix` は警告を発し、手動での修正を促していました。

このロジックは、`os.Wait` が `os.Process.Wait` に移行する過渡期において、既存のコードベースを新しいAPIに適合させるための重要な役割を担っていました。

### `os.Wait` の完全な削除

コミットメッセージにあるように、`os.Wait` 関数は「完全に削除された」ため、もはや `gofix` がその呼び出しを修正する必要がなくなりました。これは、Go言語の標準ライブラリからこの関数が完全に消滅したことを意味します。したがって、`oswait.go` とそのテストファイル `oswait_test.go` は不要となり、削除されました。

### ドキュメントの更新

`doc/go1.html` と `doc/go1.tmpl` は、Go 1のリリースノートやドキュメントの一部です。これらのファイルは、`os.Wait` の変更と `gofix` による修正について記述していました。`os.Wait` が完全に削除され、`gofix` による自動修正が不要になったため、これらのドキュメントも更新され、`gofix` が `os.Wait` の呼び出しを修正するという記述が削除されました。代わりに、「すべての変更はコンパイラによって捕捉され、手動で更新する必要がある」という記述に修正されています。これは、`os.Wait` が完全に削除されたため、コンパイラが未定義の関数呼び出しとしてエラーを報告し、開発者が手動で `os.Process.Wait` に移行する必要があることを示しています。

## コアとなるコードの変更箇所

このコミットによる主要なコード変更は以下の4つのファイルにわたります。

1.  `doc/go1.html`
2.  `doc/go1.tmpl`
3.  `src/cmd/fix/oswait.go` (削除)
4.  `src/cmd/fix/oswait_test.go` (削除)

具体的には、以下の変更が行われました。

*   **`doc/go1.html` と `doc/go1.tmpl` の変更**:
    *   `os.Wait` の `gofix` による自動修正に関する記述が削除されました。
    *   変更前:
        ```html
        Gofix will rewrite calls to <code>os.Wait</code> with an explicit zero
        argument, dropping the argument.
        All other changes will be caught by the compiler and must be updated by hand.
        ```
    *   変更後:
        ```html
        All changes will be caught by the compiler and must be updated by hand.
        ```
*   **`src/cmd/fix/oswait.go` の削除**:
    *   `os.Wait` の呼び出しを修正するための `gofix` のロジックが実装されていたファイルが完全に削除されました。
*   **`src/cmd/fix/oswait_test.go` の削除**:
    *   `oswait.go` の修正ロジックに対するテストケースが記述されていたファイルが完全に削除されました。

これらの変更は、`os.Wait` 関数がGo言語の標準ライブラリから完全に削除されたことに伴い、`gofix` ツールとその関連ドキュメントから、もはや不要となった修正ロジックと記述を削除するものです。

## コアとなるコードの解説

### `src/cmd/fix/oswait.go` (削除されたファイル)

このファイルは、`gofix` ツールの一部として、`os.Wait` 関数の呼び出しを自動的に修正するためのロジックを含んでいました。

*   **`package main`**: `cmd/fix` の実行可能ファイルの一部であることを示します。
*   **`func init()`**: `oswaitFix` という修正ルールを `gofix` に登録していました。
*   **`var oswaitFix = fix{...}`**: 修正ルールのメタデータ（名前、日付、説明など）を定義していました。特に、`oswait` 関数が実際の修正処理を行うことを指定していました。
*   **`func oswait(f *ast.File) bool`**: この関数が `os.Wait` の呼び出しを検出して修正する主要なロジックでした。
    *   `imports(f, "os")`: ファイルが `os` パッケージをインポートしているかを確認します。
    *   `walk(f, func(n interface{}) {...})`: 抽象構文木 (AST) を走査し、各ノードを検査します。
    *   `isPkgDot(call.Fun, "os", "Wait")`: 呼び出しが `os.Wait` であるかを確認します。
    *   `len(args) != 1`: `os.Wait` が引数を1つ持つことを期待していました。
    *   `basicLit, ok := args[0].(*ast.BasicLit); !ok || basicLit.Value != "0"`: 引数がリテラル `0` であるかを確認していました。もし `0` でない場合、またはリテラルでない場合は、手動での修正を促す警告 (`warning`) を出力していました。
    *   `call.Args = nil`: 引数が `0` の場合、引数を削除して `os.Wait()` の形に書き換えていました。
    *   `fixed = true`: 修正が行われたことを示すフラグを設定していました。

このファイルが削除されたことで、`gofix` はもはや `os.Wait` の呼び出しを自動的に修正しようとしなくなりました。

### `src/cmd/fix/oswait_test.go` (削除されたファイル)

このファイルは、`oswait.go` で実装された `gofix` の修正ロジックが正しく機能するかどうかを検証するためのテストケースを含んでいました。

*   **`package main`**: テストファイルが `cmd/fix` の一部であることを示します。
*   **`func init()`**: `oswaitTests` に定義されたテストケースを `gofix` のテストフレームワークに登録していました。
*   **`var oswaitTests = []testCase{...}`**: 複数のテストケースを定義していました。各テストケースは、入力コード (`In`) と期待される出力コード (`Out`) を含んでいました。
    *   例として、`os.Wait()` はそのまま、`os.Wait(0)` は `os.Wait()` に変換されるが、`os.Wait(1)` や `os.Wait(A | B)` はそのまま（警告が出力される）という挙動をテストしていました。

このテストファイルが削除されたことで、`os.Wait` 関連の修正ロジックが完全に削除されたことが確認できます。

### `doc/go1.html` および `doc/go1.tmpl` の変更

これらのファイルは、Go 1のリリースに関するドキュメントの一部です。変更は、`os.Wait` の変更に関する記述を更新するものです。

*   **変更前**: `gofix` が `os.Wait(0)` を `os.Wait()` に書き換えることを明記し、それ以外の変更は手動で行う必要があると述べていました。
*   **変更後**: `os.Wait` が完全に削除されたため、`gofix` による自動修正の記述は不要となり、すべての変更はコンパイラによって捕捉され、手動で更新する必要があるという、より一般的な記述に修正されました。これは、`os.Wait` がもはや存在しないため、コンパイラがエラーを報告し、開発者がコードを `os.Process.Wait` に手動で移行する必要があることを示唆しています。

これらの変更は、Go言語のAPI変更とそれに伴うツールの進化、そしてドキュメントの整合性を保つための典型的なプロセスを示しています。

## 関連リンク

*   GitHubコミットページ: [https://github.com/golang/go/commit/6d3530270454316f64dc71e6b6c2231dba56d69f](https://github.com/golang/go/commit/6d3530270454316f64dc71e6b6c2231dba56d69f)
*   Go Code Review (CL): [https://golang.org/cl/5685078](https://golang.org/cl/5685078)

## 参考にした情報源リンク

*   Go 1 Release Notes (Go 1のリリースノートには、`os.Wait` の変更に関する詳細が記載されている可能性がありますが、直接的なリンクはコミットメッセージにはありませんでした。一般的なGo 1のリリースノートを参照することで、より広範な背景情報を得ることができます。)
    *   [https://go.dev/doc/go1](https://go.dev/doc/go1) (Go 1の公式ドキュメント)
*   `cmd/fix` のドキュメント (Goのツールに関する一般的な情報源)
    *   [https://go.dev/cmd/fix/](https://go.dev/cmd/fix/) (Goの公式ドキュメントにおける `fix` コマンドの説明)
*   Go言語のプロセス管理に関するドキュメント (`os.Process` の詳細について)
    *   [https://go.dev/pkg/os/#Process.Wait](https://go.dev/pkg/os/#Process.Wait) (現在の `os.Process.Wait` メソッドのドキュメント)
*   Go言語の後方互換性ポリシー
    *   [https://go.dev/doc/go1compat](https://go.dev/doc/go1compat) (Go 1以降の後方互換性に関する公式ドキュメント)
```

