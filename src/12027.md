# [インデックス 12027] ファイルの概要

このコミットは、Go言語のテストスイート内の`test/fixedbugs/bug040.go`ファイルのテスト方法を変更し、より堅牢なエラーチェックメカニズムである`errorcheck`ディレクティブを使用するように修正したものです。これにより、テストが特定のコンパイル時エラーを正しく検出できるようになり、以前見過ごされていた問題（`main`関数のエラーなど）が適切に捕捉されるようになりました。

## コミット

```
commit 292bd04a434dcd294f243e247d6e3811a0921994
Author: Ian Lance Taylor <iant@golang.org>
Date:   Fri Feb 17 20:35:40 2012 -0800

    test: change bug040 to use errorcheck
    
    Because bug040.go was ignoring all error messages, the fact
    that it got an error about fuction main was being ignored.
    
    R=golang-dev, r
    CC=golang-dev
    https://golang.org/cl/5675085
```

## GitHub上でのコミットページへのリンク

[https://github.com/golang/go/commit/292bd04a434dcd294f243e247d6e3811a0921994](https://github.com/golang/go/commit/292bd04a434dcd294f243e247d6e3811a0921994)

## 元コミット内容

元の`test/fixedbugs/bug040.go`ファイルは、Goコンパイラのバグをテストするために設計されていました。しかし、そのテストの実行方法には問題がありました。

```go
// ! $G $D/$F.go >/dev/null
// # ignoring error messages...

package main

func main (x, x int) {  // BUG redeclaration error
```

このテストファイルは、`// ! $G $D/$F.go >/dev/null`という行を含んでいました。これは、テストスクリプトがGoコンパイラ（`$G`）を使ってこのファイル（`$D/$F.go`）をコンパイルし、その標準出力と標準エラー出力を`/dev/null`にリダイレクトして破棄することを意味します。つまり、コンパイル時に発生する可能性のあるエラーメッセージがすべて無視されていました。

コメント`// # ignoring error messages...`も、このテストが意図的にエラーメッセージを無視していることを示しています。この設定のため、`func main (x, x int)`という関数定義における引数`x`の再宣言エラー（`redeclaration error`）がコンパイラによって報告されても、テストシステムはそのエラーを捕捉できず、テストの目的が達成されていませんでした。特に、`main`関数に関するエラーは、その性質上、コンパイルの早い段階で検出されるべき重要な問題であり、それが無視されることはテストの有効性を著しく損なっていました。

## 変更の背景

このコミットの背景には、Goコンパイラのテストスイートにおけるエラー検出の信頼性向上の必要性がありました。`bug040.go`のようなテストファイルは、特定のコンパイル時エラー（この場合は引数の再宣言）が発生することを期待して書かれています。しかし、前述の通り、`>/dev/null`による出力リダイレクトのため、コンパイラがエラーを報告しても、テストハーネスはそのエラーを認識できませんでした。

特に、`main`関数に関するエラーは、プログラムのエントリポイントに関わるため、非常に重要です。もし`main`関数に問題があれば、プログラムは実行できません。このような重要なエラーがテストで捕捉されないことは、コンパイラの品質保証において大きなギャップとなります。

この問題を解決し、テストが期待されるコンパイル時エラーを確実に検出できるようにするために、Goのテストフレームワークが提供する`errorcheck`ディレクティブを使用するように変更されました。これにより、テストはコンパイラからの特定のエラーメッセージの有無を明示的にチェックできるようになり、テストの意図が正確に検証されるようになりました。

## 前提知識の解説

このコミットを理解するためには、Go言語のテストにおける特定の慣習と、コンパイラエラーのテスト方法に関する知識が必要です。

1.  **Go言語のテストスイートの構造**: Go言語の公式リポジトリには、コンパイラやランタイムの動作を検証するための広範なテストスイートが含まれています。これらのテストは、Goプログラムの正しい動作だけでなく、コンパイラが不正なコードに対して適切なエラーを報告することも確認します。

2.  **`// ERROR "..."` ディレクティブ**: Goのテストファイル、特にコンパイラのエラーをテストする目的のファイルでは、特別なコメントディレクティブが使用されます。
    *   `// ERROR "expected error message"`: このディレクティブは、その行またはその近くで、指定された正規表現にマッチするエラーメッセージがコンパイラによって出力されることを期待することを示します。テストハーネスは、コンパイル結果を解析し、このディレクティブと実際のエラーメッセージが一致するかどうかを検証します。
    *   `// GCCGO_ERROR "expected error message"`: これは`// ERROR`と同様ですが、GCCGOコンパイラ（Go言語のフロントエンドを持つGCC）に特有のエラーメッセージをチェックするために使用されます。Goには公式のコンパイラ（gc）と、GCCをベースにしたコンパイラ（gccgo）が存在するため、両方のコンパイラでテストが機能するように、それぞれのエラーメッセージに対応するディレクティブが用意されています。

3.  **`// errorcheck` ディレクティブ**: これは、ファイル全体がコンパイラエラーのチェックを目的としていることを示すトップレベルのディレクティブです。このディレクティブが存在する場合、テストハーネスはファイル内の`// ERROR`や`// GCCGO_ERROR`コメントを解析し、それらに基づいてコンパイル結果のエラーメッセージを厳密に検証します。これにより、テストファイルが意図しないエラーを無視したり、期待されるエラーを報告しなかったりするのを防ぎます。

4.  **`errcheck`ツールとの混同回避**: Goコミュニティには、`errcheck`という名前のサードパーティ製静的解析ツールも存在します。このツールは、Goプログラム内でエラーが適切にチェックされていない箇所を検出することを目的としています。しかし、このコミットで言及されている`errorcheck`は、Go言語のテストスイート内で使用される特別なコメントディレクティブであり、コンパイラが特定のコードに対して期待されるエラーを報告するかどうかを検証するためのものです。両者は名前が似ていますが、目的と機能が異なります。このコミットは、Goのコンパイラテストの内部メカニズムに関するものであり、サードパーティの静的解析ツールとは直接関係ありません。

## 技術的詳細

このコミットの技術的な核心は、Goコンパイラのテストハーネスが`// errorcheck`ディレクティブと`// ERROR "..."`コメントをどのように解釈し、テストの検証に利用するかという点にあります。

Goのテストシステムは、`test/fixedbugs`ディレクトリ内のファイルのような特定のテストケースを処理する際に、ファイルの先頭行を解析します。もし`// errorcheck`というディレクティブが見つかった場合、テストハーネスは以下の動作を実行します。

1.  **コンパイルの実行**: テスト対象のGoファイルをコンパイラ（通常は`gc`、場合によっては`gccgo`）でコンパイルします。
2.  **エラーメッセージの捕捉**: コンパイラが出力するすべての標準エラー出力（コンパイルエラーや警告メッセージ）を捕捉します。
3.  **ディレクティブの解析**: テストファイル内のすべての`// ERROR "..."`および`// GCCGO_ERROR "..."`コメントをスキャンし、それぞれのコメントが期待するエラーメッセージの正規表現と、それが現れるべき行番号を記録します。
4.  **エラーの照合**: 捕捉したコンパイラのエラーメッセージと、テストファイル内で指定された`// ERROR`ディレクティブを照合します。
    *   **期待されるエラーの確認**: 各`// ERROR`ディレクティブに対して、対応するエラーメッセージがコンパイラ出力に存在し、かつ適切な行で報告されているかを確認します。
    *   **予期せぬエラーの検出**: `// ERROR`ディレクティブで指定されていないエラーメッセージがコンパイラから出力された場合、それはテストの失敗とみなされます。これは、テストが特定のバグを修正したことを確認するだけでなく、その修正が他の予期せぬエラーを引き起こしていないことも保証するために重要です。
    *   **エラーの欠落の検出**: `// ERROR`ディレクティブで指定されたエラーがコンパイラから報告されなかった場合も、テストの失敗とみなされます。これは、コンパイラが期待されるエラーを正しく検出していることを保証します。

このメカニズムにより、`bug040.go`のようなテストは、単にコンパイルが成功するか失敗するかをチェックするだけでなく、「特定の種類のコンパイルエラーが、特定の場所で、特定のメッセージで報告されること」を厳密に検証できるようになります。

今回のコミットでは、`main`関数における引数の再宣言エラーが、以前は`/dev/null`にリダイレクトされていたために見過ごされていました。`// errorcheck`と具体的な`// ERROR`コメントを導入することで、この再宣言エラーがコンパイラによって報告されることをテストが明示的に期待し、その期待が満たされない場合にテストが失敗するようになりました。これにより、コンパイラのバグ検出能力が向上し、テストの網羅性と信頼性が高まりました。

## コアとなるコードの変更箇所

```diff
--- a/test/fixedbugs/bug040.go
+++ b/test/fixedbugs/bug040.go
@@ -1,5 +1,4 @@
-// ! $G $D/$F.go >/dev/null
-// # ignoring error messages...
+// errorcheck
 
 // Copyright 2009 The Go Authors. All rights reserved.
 // Use of this source code is governed by a BSD-style
@@ -7,5 +6,6 @@
 
  package main
 
 -func main (x, x int) {  // BUG redeclaration error
 +func f (x,		// GCCGO_ERROR "previous"
 +	x int) {	// ERROR "redeclared|redefinition" "duplicate"
  }
```

## コアとなるコードの解説

このコミットにおける主要な変更点は以下の通りです。

1.  **テストディレクティブの変更**:
    *   削除された行: `// ! $G $D/$F.go >/dev/null` および `// # ignoring error messages...`
        これらは、テストのコンパイル出力を破棄し、エラーメッセージを無視するための古い方法でした。この行が削除されたことで、テストハーネスはコンパイラの出力を捕捉し、解析するようになります。
    *   追加された行: `// errorcheck`
        この行は、このファイルがコンパイラエラーのチェックを目的としたテストであることをテストハーネスに明示的に伝えます。これにより、テストハーネスはファイル内の`// ERROR`コメントを期待されるエラーとして扱い、コンパイル結果と照合するようになります。

2.  **テスト対象関数の変更とエラーコメントの追加**:
    *   変更前: `func main (x, x int) { // BUG redeclaration error`
        `main`関数がテスト対象でしたが、引数`x`の再宣言エラーが無視されていました。
    *   変更後:
        ```go
        func f (x,		// GCCGO_ERROR "previous"
        	x int) {	// ERROR "redeclared|redefinition" "duplicate"
        }
        ```
        *   関数名が`main`から`f`に変更されました。これは、`main`関数に特有のコンパイル時チェック（例えば、`main`関数は引数を取らない、など）から切り離し、純粋に引数の再宣言エラーに焦点を当てるためと考えられます。
        *   `x`の最初の宣言の行に`// GCCGO_ERROR "previous"`が追加されました。これは、GCCGOコンパイラが「`x`が以前に宣言されている」という種類のエラーメッセージを報告することを期待します。
        *   `x`の2番目の宣言の行に`// ERROR "redeclared|redefinition" "duplicate"`が追加されました。これは、Goの標準コンパイラ（gc）が「`x`が再宣言されている」または「重複している」という種類のエラーメッセージを報告することを期待します。`|`は正規表現のORを意味し、複数の可能性のあるエラーメッセージパターンに対応しています。

これらの変更により、`bug040.go`は、引数の再宣言という特定のコンパイルエラーが、Goの主要なコンパイラ（gcとgccgo）によって正しく検出され、適切なエラーメッセージが報告されることを厳密に検証するテストに生まれ変わりました。これにより、コンパイラのバグ検出能力が向上し、テストの信頼性が大幅に向上しました。

## 関連リンク

*   Go CL 5675085: [https://golang.org/cl/5675085](https://golang.org/cl/5675085)

## 参考にした情報源リンク

*   Go言語のテストにおける`// ERROR`ディレクティブに関する情報:
    *   [https://go.dev/src/cmd/compile/internal/test/testdata/test.go](https://go.dev/src/cmd/compile/internal/test/testdata/test.go) (Goソースコード内のテストヘルパーファイル)
    *   [https://github.com/golang/go/wiki/CompilerTestDirectives](https://github.com/golang/go/wiki/CompilerTestDirectives) (非公式のWikiページだが、関連情報がある可能性)
*   `errcheck`静的解析ツールに関する情報（本コミットの`errorcheck`ディレクティブとは異なる点に注意）:
    *   [https://github.com/kisielk/errcheck](https://github.com/kisielk/errcheck)
    *   [https://golangci-lint.run/usage/linters/#errcheck](https://golangci-lint.run/usage/linters/#errcheck)
