commit c3a0854e31155de9baad65da70e8ffb653f3b721
Author: Austin Clements <austin@google.com>
Date:   Wed Nov 2 14:27:28 2022 -0400

    cmd/dist: introduce "go test" abstraction
    
    This introduces an abstraction for constructing and running "go test"
    commands. Currently, dist test is basically a shell script written in
    Go syntax: it mostly just invokes lots of subprocesses, almost all of
    which are "go test" invocations, and it constructs those command lines
    directly from strings all over the place.
    
    This CL raises the level of abstraction of invoking go test. The
    current level of abstraction is not serving us very well: it's
    conveniently terse, but the actual logic for constructing a command
    line is typically so spread out that it's difficult to predict what
    command will actually run. For example, the `gotest` function
    constructs the basic command, but many tests want to override at least
    some of these flags, so flattenCmdLine has logic specific to `go test`
    for eliminating duplicate flags that `go test` itself would reject. At
    the same time, the logic for constructing many common flags is
    conditional, leading to a bevy of helpers for constructing flags like
    `-short` and `-timeout` and `-run` that are scattered throughout
    test.go and very easy to forget to call.
    
    This CL centralizes and flattens all of this knowledge into a new
    `goTest` type. This type gives dist a single, unified point where we
    can change anything about how it invokes "go test".
    
    There's currently some "unnecessary" abstraction in the implementation
    of the goTest type to separate "build" and "run" flags. This will
    become important later when we convert host tests and to do separate
    build and run steps.
    
    The following CLs will convert dist test to use this type rather than
    directly constructing "go test" command lines. Finally, we'll strip
    out the scattered helper logic for building command lines.
    
    For #37486.
    
    Change-Id: I9f1633fe6c0921696419ce8127ed2ca7b7a4e01b
    Reviewed-on: https://go-review.googlesource.com/c/go/+/448802
    Reviewed-by: Dmitri Shuralyov <dmitshur@golang.org>
    Run-TryBot: Austin Clements <austin@google.com>
    Reviewed-by: Dmitri Shuralyov <dmitshur@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>

 src/cmd/dist/test.go | 184 +++++++++++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 178 insertions(+), 6 deletions(-)
