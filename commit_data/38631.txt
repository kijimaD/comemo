commit dc0be727dc6182fb258f9f1048e9a9eef966c563
Author: Filippo Valsorda <filippo@golang.org>
Date:   Sat Nov 3 20:04:44 2018 -0400

    crypto/tls: implement TLS 1.3 middlebox compatibility mode
    
    Looks like the introduction of CCS records in the client second flight
    gave time to s_server to send NewSessionTicket messages in between the
    client application data and close_notify. There seems to be no way of
    turning NewSessionTicket messages off, neither by not sending a
    psk_key_exchange_modes extension, nor by command line flag.
    
    Interleaving the client write like that tickled an issue akin to #18701:
    on Windows, the client reaches Close() before the last record is drained
    from the send buffer, the kernel notices and resets the connection,
    cutting short the last flow. There is no good way of synchronizing this,
    so we sleep for a RTT before calling close, like in CL 75210. Sigh.
    
    Updates #9671
    
    Change-Id: I44dc1cca17b373695b5a18c2741f218af2990bd1
    Reviewed-on: https://go-review.googlesource.com/c/147419
    Run-TryBot: Filippo Valsorda <filippo@golang.org>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Adam Langley <agl@golang.org>

 src/crypto/tls/conn.go                             |   2 +-
 src/crypto/tls/handshake_client_test.go            |  14 +-
 src/crypto/tls/handshake_client_tls13.go           |  22 ++-
 src/crypto/tls/handshake_server_tls13.go           |  21 ++
 .../tls/testdata/Client-TLSv13-AES128-SHA256       | 169 +++++++++-------
 .../tls/testdata/Client-TLSv13-AES256-SHA384       | 173 ++++++++++-------
 src/crypto/tls/testdata/Client-TLSv13-ALPN         | 171 ++++++++++-------
 .../tls/testdata/Client-TLSv13-CHACHA20-SHA256     | 169 +++++++++-------
 src/crypto/tls/testdata/Client-TLSv13-ECDSA        | 159 +++++++++-------
 .../testdata/Client-TLSv13-ExportKeyingMaterial    | 169 +++++++++-------
 .../tls/testdata/Client-TLSv13-HelloRetryRequest   | 205 +++++++++++---------
 src/crypto/tls/testdata/Client-TLSv13-KeyUpdate    | 212 +++++++++++----------
 src/crypto/tls/testdata/Client-TLSv13-P256-ECDHE   | 171 ++++++++++-------
 src/crypto/tls/testdata/Client-TLSv13-X25519-ECDHE | 167 +++++++++-------
 .../tls/testdata/Server-TLSv13-AES128-SHA256       | 150 +++++++--------
 .../tls/testdata/Server-TLSv13-AES256-SHA384       | 154 +++++++--------
 src/crypto/tls/testdata/Server-TLSv13-ALPN         | 156 +++++++--------
 src/crypto/tls/testdata/Server-TLSv13-ALPN-NoMatch | 154 +++++++--------
 .../tls/testdata/Server-TLSv13-CHACHA20-SHA256     | 150 +++++++--------
 .../tls/testdata/Server-TLSv13-ECDHE-ECDSA-AES     | 142 +++++++-------
 .../testdata/Server-TLSv13-ExportKeyingMaterial    | 154 +++++++--------
 .../tls/testdata/Server-TLSv13-HelloRetryRequest   | 181 +++++++++---------
 src/crypto/tls/testdata/Server-TLSv13-P256         | 156 +++++++--------
 src/crypto/tls/testdata/Server-TLSv13-RSA-RSAPSS   | 154 +++++++--------
 src/crypto/tls/testdata/Server-TLSv13-X25519       | 154 +++++++--------
 25 files changed, 1935 insertions(+), 1594 deletions(-)
