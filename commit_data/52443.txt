commit f52b4ec63d6ce5c4eb9edcb81c3a0661e6f53da0
Author: fanzha02 <fannie.zhang@arm.com>
Date:   Thu Apr 29 17:02:53 2021 +0800

    cmd/compile: enable Asan check for global variables
    
    With this patch, -asan option can detect the error memory
    access to global variables.
    
    So this patch makes a few changes:
    
    1. Add the asanregisterglobals runtime support function,
    which calls asan runtime function _asan_register_globals
    to register global variables.
    
    2. Create a new initialization function for the package
    being compiled. This function initializes an array of
    instrumented global variables and pass it to function
    runtime.asanregisterglobals. An instrumented global
    variable has trailing redzone.
    
    3. Writes the new size of instrumented global variables
    that have trailing redzones into object file.
    
    4. Notice that the current implementation is only compatible with
    the ASan library from version v7 to v9. Therefore, using the
    -asan option requires that the gcc version is not less than 7
    and the clang version is less than 4, otherwise a segmentation
    fault will occur. So this patch adds a check on whether the compiler
    being used is a supported version in cmd/go.
    
    Updates #44853.
    
    Change-Id: Ib877a817209ab2be68a8e22c418fe4a4a20880fc
    Reviewed-on: https://go-review.googlesource.com/c/go/+/401775
    Reviewed-by: Ian Lance Taylor <iant@google.com>
    Reviewed-by: Bryan Mills <bcmills@google.com>
    Run-TryBot: Bryan Mills <bcmills@google.com>
    Auto-Submit: Bryan Mills <bcmills@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>

 misc/cgo/testsanitizers/asan_test.go               |   8 +
 misc/cgo/testsanitizers/cc_test.go                 |  25 ++-
 src/cmd/compile/internal/base/base.go              |   1 +
 src/cmd/compile/internal/gc/obj.go                 |  17 +-
 src/cmd/compile/internal/noder/noder.go            |   2 +-
 src/cmd/compile/internal/noder/object.go           |   2 +-
 src/cmd/compile/internal/noder/reader.go           |   2 +-
 src/cmd/compile/internal/pkginit/init.go           |  53 +++++
 .../compile/internal/pkginit/initAsanGlobals.go    | 241 +++++++++++++++++++++
 src/cmd/go/alldocs.go                              |   2 +
 src/cmd/go/internal/work/build.go                  |   2 +
 src/cmd/go/internal/work/init.go                   | 100 +++++++++
 ...install_msan_and_race_and_asan_require_cgo.txt} |   2 +-
 src/runtime/asan.go                                |   4 +
 src/runtime/asan/asan.go                           |  38 ++++
 src/runtime/asan0.go                               |   9 +-
 src/runtime/asan_amd64.s                           |   8 +
 src/runtime/asan_arm64.s                           |   8 +
 18 files changed, 509 insertions(+), 15 deletions(-)
