commit cb12198de57db6f514d7ef11839d446189e38f4b
Author: Lance Yang <ioworker0@gmail.com>
Date:   Tue Mar 19 14:19:43 2024 +0000

    runtime: optimize permission changes with mprotect
    
    On Linux, both mprotect() and mmap() acquire the mmap_lock (in writer mode),
    posing scalability challenges.
    
    The mmap_lock (formerly called mmap_sem) is a reader/writer lock that controls
    access to a process's address space; before making changes there (mapping in a
    new range, for example), the kernel must acquire that lock.
    
    Page-fault handling must also acquire mmap_lock (in reader mode) to ensure that
    the address space doesn't change in surprising ways while a fault is being resolved.
    
    A process can have a large address space and many threads running (and incurring
    page faults) concurrently, turning mmap_lock into a significant bottleneck.
    
    While both mmap() and mprotect() are protected by the mmap_lock, the shorter
    duration of mprotect system call, due to their simpler nature, results in a reduced
    locking time for the mmap_lock.
    
    Change-Id: I7f929544904e31eab34d0d8a9e368abe4de64637
    GitHub-Last-Rev: 6f27a216b4fb789181d00316561b44358a118b19
    GitHub-Pull-Request: golang/go#65038
    Reviewed-on: https://go-review.googlesource.com/c/go/+/554935
    Reviewed-by: Michael Knyszek <mknyszek@google.com>
    Reviewed-by: Mauri de Souza Meneguzzo <mauri870@gmail.com>
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>
    Reviewed-by: Michael Pratt <mpratt@google.com>

 src/internal/runtime/syscall/defs_linux_386.go     | 1 +
 src/internal/runtime/syscall/defs_linux_amd64.go   | 1 +
 src/internal/runtime/syscall/defs_linux_arm.go     | 1 +
 src/internal/runtime/syscall/defs_linux_arm64.go   | 1 +
 src/internal/runtime/syscall/defs_linux_loong64.go | 1 +
 src/internal/runtime/syscall/defs_linux_mips64x.go | 1 +
 src/internal/runtime/syscall/defs_linux_mipsx.go   | 1 +
 src/internal/runtime/syscall/defs_linux_ppc64x.go  | 1 +
 src/internal/runtime/syscall/defs_linux_riscv64.go | 1 +
 src/internal/runtime/syscall/defs_linux_s390x.go   | 1 +
 src/runtime/mem_linux.go                           | 3 ++-
 src/runtime/os_linux.go                            | 6 ++++++
 12 files changed, 18 insertions(+), 1 deletion(-)
