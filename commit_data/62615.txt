commit 24b395119b4df7f16915b9f01a6aded647b79bbd
Author: Mark Ryan <markdryan@rivosinc.com>
Date:   Tue Dec 10 17:02:26 2024 +0100

    cmd/internal/obj/riscv: prevent duplicate error reports
    
    The riscv64 Go assembler can output certain errors, ones produced by
    instructionsForProg, multiple times.  These errors are guaranteed to
    be output at least twice and can appear three or more times if a
    rescan is needed to recompute branch addresses.  For example, the
    syntactically incorrect instruction
    
    MOV     (X10), $1
    
    will generate at least two identical errors
    
    asm: 86076 (asm.s:21524)        MOV     (X10), $1: unsupported MOV
    asm: 86076 (asm.s:21524)        MOV     (X10), $1: unsupported MOV
    asm: assembly failed
    
    In addition to confusing the user, these duplicate errors make it
    difficult to write negative tests for certain types of instructions,
    e.g., branches, whose duplicate errors are not always identical,
    and so not ignored by endtoend_test.go.
    
    We fix the issue by returning from preprocess if any errors have been
    generated by the time we reach the end of the rescan loop. One
    implication of this change is that validation errors will no longer
    be reported if an error is generated earlier in the preprocess stage.
    Negative test cases for validation errors are therefore moved to
    their own file as the existing riscv64error.s file contains errors
    generated by instructionsForProg that will now suppress the
    validation errors.
    
    Change-Id: Iffacdbefce28f44970dd5dda44990b822b8a23d4
    Reviewed-on: https://go-review.googlesource.com/c/go/+/637315
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>
    Reviewed-by: Joel Sing <joel@sing.id.au>
    Reviewed-by: David Chase <drchase@google.com>
    Reviewed-by: Cherry Mui <cherryyz@google.com>

 src/cmd/asm/internal/asm/endtoend_test.go          |  4 ++
 src/cmd/asm/internal/asm/testdata/riscv64error.s   | 34 ----------------
 .../asm/internal/asm/testdata/riscv64validation.s  | 46 ++++++++++++++++++++++
 src/cmd/internal/obj/riscv/obj.go                  |  5 +++
 4 files changed, 55 insertions(+), 34 deletions(-)
