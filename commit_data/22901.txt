commit 3b22ffc07ec0f4114362425ca004081fcdd708df
Author: David Crawshaw <crawshaw@golang.org>
Date:   Mon Apr 13 19:31:39 2015 -0400

    runtime: make cgocallback wait on package init
    
    With the new buildmodes c-archive and c-shared, it is possible for a
    cgo call to come in early in the lifecycle of a Go program. Calls
    before the runtime has been initialized are caught by
    _cgo_wait_runtime_init_done. However a call can come in after the
    runtime has initialized, but before the program's package init
    functions have finished running.
    
    To avoid this cgocallback checks m.ncgo to see if we are on a thread
    running Go. If not, we may be a foreign thread and it blocks until
    main_init is complete.
    
    Change-Id: I7a9f137fa2a40c322a0b93764261f9aa17fcf5b8
    Reviewed-on: https://go-review.googlesource.com/8897
    Reviewed-by: Ian Lance Taylor <iant@golang.org>
    Run-TryBot: David Crawshaw <crawshaw@golang.org>

 misc/cgo/testcarchive/main.c             |  8 ++++----
 misc/cgo/testcarchive/src/libgo/libgo.go | 32 +++++++++++++++++++++++++-------
 src/runtime/cgocall.go                   |  8 ++++++++
 src/runtime/proc.go                      |  8 ++++++++
 4 files changed, 45 insertions(+), 11 deletions(-)
