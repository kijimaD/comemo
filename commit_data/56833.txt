commit d4bd855cfb5319bfa560251d60a93369c0ce0763
Author: Filippo Valsorda <filippo@golang.org>
Date:   Wed May 24 15:49:56 2023 +0200

    crypto/tls: don't reverify but check certificate expiration on resumption
    
    We used to inconsistently run certificate verification on the server on
    resumption, but not on the client. This made TLS 1.3 resumption pretty
    much useless, as it didn't save bytes, CPU, or round-trips.
    
    This requires serializing the verified chains into the session ticket,
    so it's a tradeoff making the ticket bigger to save computation (and for
    consistency).
    
    The previous behavior also had a "stickyness" issue: if a ticket
    contained invalid certificates, they would be used even if the client
    had in the meantime configured valid certificates for a full handshake.
    
    We also didn't check expiration on the client side on resumption if
    InsecureSkipVerify was set. Again for consistency, we do that now.
    
    Also, we used to run VerifyPeerCertificates on resumption even if
    NoClientCerts was set.
    
    Fixes #31641
    
    Change-Id: Icc88269ea4adb544fa81158114aae76f3c91a15f
    Reviewed-on: https://go-review.googlesource.com/c/go/+/497895
    Reviewed-by: Damien Neil <dneil@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Run-TryBot: Filippo Valsorda <filippo@golang.org>
    Reviewed-by: Roland Shoemaker <roland@golang.org>
    Auto-Submit: Filippo Valsorda <filippo@golang.org>

 src/crypto/tls/common.go                           |  19 +-
 src/crypto/tls/handshake_client.go                 |  13 +-
 src/crypto/tls/handshake_messages_test.go          |  10 +-
 src/crypto/tls/handshake_server.go                 |  18 +-
 src/crypto/tls/handshake_server_tls13.go           |  14 +-
 .../testdata/Server-TLSv10-ExportKeyingMaterial    |  77 ++---
 src/crypto/tls/testdata/Server-TLSv12-ALPN         |  62 ++--
 .../tls/testdata/Server-TLSv12-ALPN-Fallback       |  64 ++--
 .../tls/testdata/Server-TLSv12-ALPN-NotConfigured  |  64 ++--
 .../testdata/Server-TLSv12-ExportKeyingMaterial    |  80 ++---
 src/crypto/tls/testdata/Server-TLSv12-IssueTicket  |  74 ++---
 .../testdata/Server-TLSv12-IssueTicketPreDisable   |  74 ++---
 src/crypto/tls/testdata/Server-TLSv12-Resume       |  87 +++---
 .../tls/testdata/Server-TLSv13-AES128-SHA256       | 166 +++++------
 .../tls/testdata/Server-TLSv13-AES256-SHA384       | 172 +++++------
 src/crypto/tls/testdata/Server-TLSv13-ALPN         | 168 +++++------
 .../tls/testdata/Server-TLSv13-ALPN-Fallback       | 164 +++++-----
 .../tls/testdata/Server-TLSv13-ALPN-NotConfigured  | 166 +++++------
 .../tls/testdata/Server-TLSv13-CHACHA20-SHA256     | 166 +++++------
 .../Server-TLSv13-ClientAuthRequestedAndECDSAGiven | 332 ++++++++++-----------
 ...erver-TLSv13-ClientAuthRequestedAndEd25519Given | 269 ++++++++---------
 .../Server-TLSv13-ClientAuthRequestedAndGiven      | 325 ++++++++++----------
 .../Server-TLSv13-ClientAuthRequestedNotGiven      | 178 +++++------
 .../tls/testdata/Server-TLSv13-ECDHE-ECDSA-AES     | 158 +++++-----
 src/crypto/tls/testdata/Server-TLSv13-Ed25519      | 122 ++++----
 .../testdata/Server-TLSv13-ExportKeyingMaterial    | 166 +++++------
 .../tls/testdata/Server-TLSv13-HelloRetryRequest   | 190 ++++++------
 src/crypto/tls/testdata/Server-TLSv13-IssueTicket  | 166 +++++------
 .../testdata/Server-TLSv13-IssueTicketPreDisable   | 166 +++++------
 src/crypto/tls/testdata/Server-TLSv13-P256         | 170 +++++------
 src/crypto/tls/testdata/Server-TLSv13-RSA-RSAPSS   | 166 +++++------
 src/crypto/tls/testdata/Server-TLSv13-Resume       |  85 +++---
 .../Server-TLSv13-Resume-HelloRetryRequest         | 132 ++++----
 src/crypto/tls/testdata/Server-TLSv13-X25519       | 166 +++++------
 src/crypto/tls/ticket.go                           | 102 +++----
 src/crypto/tls/tls_test.go                         | 144 +++++++++
 36 files changed, 2428 insertions(+), 2267 deletions(-)
