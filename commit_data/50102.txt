commit d5aa088d822bc8ef3ceb80c20184f40fcb9b8d2e
Author: Bryan C. Mills <bcmills@google.com>
Date:   Wed Aug 24 09:45:18 2022 -0400

    cmd/go: avoid registering AtExit handlers in tests
    
    Ever since 'go build' was added (in CL 5483069), it has used an atexit
    handler to clean up working directories.
    
    CL 154109 introduced 'cc' command to the script test framework that
    called Init on a builder once per invocation. Unfortunately, since
    base.AtExit is unsynchronized, the Init added there caused any script
    that invokes that command to be unsafe for concurrent use.
    
    This change fixes the race by having the 'cc' command pass in its
    working directory instead of allowing the Builder to allocate one.
    Following modern Go best practices, it also replaces the in-place Init
    method (which is prone to typestate and aliasing bugs) with a
    NewBuilder constructor function.
    
    Fixes #54423.
    
    Change-Id: I8fc2127a7d877bb39a1174e398736bb51d03d4d2
    Reviewed-on: https://go-review.googlesource.com/c/go/+/425205
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Run-TryBot: Bryan Mills <bcmills@google.com>
    Auto-Submit: Bryan Mills <bcmills@google.com>
    Reviewed-by: Than McIntosh <thanm@google.com>

 src/cmd/go/internal/envcmd/env.go  |  4 ++--
 src/cmd/go/internal/list/list.go   |  3 +--
 src/cmd/go/internal/run/run.go     |  3 +--
 src/cmd/go/internal/test/test.go   | 16 ++++++++++++----
 src/cmd/go/internal/vet/vet.go     |  3 +--
 src/cmd/go/internal/work/action.go | 14 ++++++++++++--
 src/cmd/go/internal/work/build.go  |  7 +++----
 src/cmd/go/script_test.go          |  4 +---
 8 files changed, 33 insertions(+), 21 deletions(-)
