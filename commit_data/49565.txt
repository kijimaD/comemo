commit 64ef16e77795957d47e3889bca9483d6f3099bbf
Author: Cherry Mui <cherryyz@google.com>
Date:   Wed Jun 15 15:09:24 2022 -0400

    cmd/internal/obj/arm64: save LR and SP in one instruction for small frames
    
    When we create a thread with signals blocked. But glibc's
    pthread_sigmask doesn't really allow us to block SIGSETXID. So we
    may get a signal early on before the signal stack is set. If we
    get a signal on the current stack, it will clobber anything below
    the SP. This CL makes it to save LR and decrement SP in a single
    MOVD.W instruction for small frames, so we don't write below the
    SP.
    
    We used to use a single MOVD.W instruction before CL 379075.
    CL 379075 changed to use an STP instruction to save the LR and FP,
    then decrementing the SP. This CL changes it back, just this part
    (epilogues and large frame prologues are unchanged). For small
    frames, it is the same number of instructions either way.
    
    This decreases the size of a "small" frame from 0x1f0 to 0xf0.
    For frame sizes in between, it could benefit from using an
    STP instruction instead of using the prologue for the "large"
    frame case. We don't bother it for now as this is a stop-gap
    solution anyway.
    
    This only addresses the issue with small frames. Luckily, all
    functions from thread entry to setting up the signal stack have
    samll frames.
    
    Other possible ideas:
    - Expand the unwind info metadata, separate SP delta and the
      location of the return address, so we can express "SP is
      decremented but the return address is in the LR register". Then
      we can always create the frame first then write the LR, without
      writing anything below the SP (except the frame pointer at SP-8,
      which is minor because it doesn't really affect program
      execution).
    - Set up the signal stack immediately in mstart in assembly.
    
    For Go 1.19 we do this simple fix. We plan to do the metadata fix
    in Go 1.20 ( #53609 ).
    
    Other LR architectures are addressed in CL 413428.
    
    Fix #53374.
    
    Change-Id: I9d6582ab14ccb06ac61ad43852943d9555e22ae5
    Reviewed-on: https://go-review.googlesource.com/c/go/+/412474
    Run-TryBot: Cherry Mui <cherryyz@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Reviewed-by: Austin Clements <austin@google.com>
    Reviewed-by: Eric Fang <eric.fang@arm.com>

 misc/cgo/test/cgo_linux_test.go    |  8 +++++
 misc/cgo/test/setgid2_linux.go     | 35 ++++++++++++++++++++
 src/cmd/internal/obj/arm64/obj7.go | 65 +++++++++++++++-----------------------
 3 files changed, 69 insertions(+), 39 deletions(-)
