commit d91d8325308a8ad6943bd46ab3396ae8decd8348
Author: Bryan C. Mills <bcmills@google.com>
Date:   Wed Apr 12 13:58:54 2023 +0000

    net/http: avoid leaking writer goroutines in tests
    
    In TestTransportPrefersResponseOverWriteError and TestMaxBytesHandler,
    the server may respond to an incoming request without ever reading the
    request body. The client's Do method will return as soon as the
    server's response headers are read, but the Transport will remain
    active until it notices that the server has closed the connection,
    which may be arbitrarily later.
    
    When the server has closed the connection, it will call the Close
    method on the request body (if it has such a method). So we can use
    that method to find out when the Transport is close enough to done for
    the test to complete without interfering too much with other tests.
    
    For #57612.
    For #59526.
    
    Change-Id: Iddc7a3b7b09429113ad76ccc1c090ebc9e1835a1
    Reviewed-on: https://go-review.googlesource.com/c/go/+/483895
    Run-TryBot: Bryan Mills <bcmills@google.com>
    Commit-Queue: Bryan Mills <bcmills@google.com>
    Auto-Submit: Bryan Mills <bcmills@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Reviewed-by: Michael Pratt <mpratt@google.com>

 src/net/http/serve_test.go     | 25 +++++++++++++++++++++++--
 src/net/http/transport_test.go | 34 +++++++++++++++++++++++++++++++++-
 2 files changed, 56 insertions(+), 3 deletions(-)
