commit b700cb4974c23a030775a311e6c60cf93b220a6f
Author: Russ Cox <rsc@golang.org>
Date:   Tue Apr 1 13:31:38 2014 -0400

    cmd/gc: shorten temporary lifetimes when possible
    
    The new channel and map runtime routines take pointers
    to values, typically temporaries. Without help, the compiler
    cannot tell when those temporaries stop being needed,
    because it isn't sure what happened to the pointer.
    Arrange to insert explicit VARKILL instructions for these
    temporaries so that the liveness analysis can avoid seeing
    them as "ambiguously live".
    
    The change is made in order.c, which was already in charge of
    introducing temporaries to preserve the order-of-evaluation
    guarantees. Now its job has expanded to include introducing
    temporaries as needed by runtime routines, and then also
    inserting the VARKILL annotations for all these temporaries,
    so that their lifetimes can be shortened.
    
    In order to do its job for the map runtime routines, order.c arranges
    that all map lookups or map assignments have the form:
    
            x = m[k]
            x, y = m[k]
            m[k] = x
    
    where x, y, and k are simple variables (often temporaries).
    Likewise, receiving from a channel is now always:
    
            x = <-c
    
    In order to provide the map guarantee, order.c is responsible for
    rewriting x op= y into x = x op y, so that m[k] += z becomes
    
            t = m[k]
            t2 = t + z
            m[k] = t2
    
    While here, fix a few bugs in order.c's traversal: it was failing to
    walk into select and switch case bodies, so order of evaluation
    guarantees were not preserved in those situations.
    Added tests to test/reorder2.go.
    
    Fixes #7671.
    
    In gc/popt's temporary-merging optimization, allow merging
    of temporaries with their address taken as long as the liveness
    ranges do not intersect. (There is a good chance of that now
    that we have VARKILL annotations to limit the liveness range.)
    
    Explicitly killing temporaries cuts the number of ambiguously
    live temporaries that must be zeroed in the godoc binary from
    860 to 711, or -17%. There is more work to be done, but this
    is a good checkpoint.
    
    Update #7345
    
    LGTM=khr
    R=khr
    CC=golang-codereviews
    https://golang.org/cl/81940043

 src/cmd/5g/ggen.c      |   4 +-
 src/cmd/5g/peep.c      |   3 +-
 src/cmd/5g/prog.c      |   1 +
 src/cmd/5g/reg.c       |   2 +-
 src/cmd/5l/5.out.h     |   1 +
 src/cmd/6g/ggen.c      |   4 +-
 src/cmd/6g/peep.c      |   4 +-
 src/cmd/6g/prog.c      |   1 +
 src/cmd/6g/reg.c       |   2 +-
 src/cmd/6l/6.out.h     |   1 +
 src/cmd/8g/ggen.c      |   4 +-
 src/cmd/8g/peep.c      |   4 +-
 src/cmd/8g/prog.c      |   1 +
 src/cmd/8g/reg.c       |   2 +-
 src/cmd/8l/8.out.h     |   1 +
 src/cmd/gc/gen.c       |   5 +
 src/cmd/gc/go.h        |   2 +
 src/cmd/gc/order.c     | 683 +++++++++++++++++++++++++++++++++++++++++--------
 src/cmd/gc/pgen.c      |  32 ++-
 src/cmd/gc/plive.c     |  30 ++-
 src/cmd/gc/popt.c      |  42 ++-
 src/cmd/gc/racewalk.c  |   1 +
 src/cmd/gc/range.c     |   3 +-
 src/cmd/gc/select.c    |   4 +-
 src/cmd/gc/sinit.c     |  39 ++-
 src/cmd/gc/typecheck.c |   3 +-
 src/cmd/gc/walk.c      | 200 ++++-----------
 test/live.go           | 118 +++++++++
 test/reorder2.go       | 169 ++++++++++++
 29 files changed, 1056 insertions(+), 310 deletions(-)
