commit 4af6b81d41c648f31ed8113151ed8f7fee6180c8
Author: Austin Clements <austin@google.com>
Date:   Fri Jan 13 13:23:41 2017 -0500

    runtime: fix confusion between _MaxMem and _MaxArena32
    
    Currently both _MaxMem and _MaxArena32 represent the maximum arena
    size on 32-bit hosts (except on MIPS32 where _MaxMem is confusingly
    smaller than _MaxArena32).
    
    Clean up sysAlloc so that it always uses _MaxMem, which is the maximum
    arena size on both 32- and 64-bit architectures and is the arena size
    we allocate auxiliary structures for. This lets us simplify and unify
    some code paths and eliminate _MaxArena32.
    
    Fixes #18651. mheap.sysAlloc currently assumes that if the arena is
    small, we must be on a 32-bit machine and can therefore grow the arena
    to _MaxArena32. This breaks down on darwin/arm64, where _MaxMem is
    only 2 GB. As a result, on darwin/arm64, we only reserve spans and
    bitmap space for a 2 GB heap, and if the application tries to allocate
    beyond that, sysAlloc takes the 32-bit path, tries to grow the arena
    beyond 2 GB, and panics when it tries to grow the spans array
    allocation past its reserved size. This has probably been a problem
    for several releases now, but was only noticed recently because
    mapSpans didn't check the bounds on the span reservation until
    recently. Most likely it corrupted the bitmap before. By using _MaxMem
    consistently, we avoid thinking that we can grow the arena larger than
    we have auxiliary structures for.
    
    Change-Id: Ifef28cb746a3ead4b31c1d7348495c2242fef520
    Reviewed-on: https://go-review.googlesource.com/35253
    Reviewed-by: David Crawshaw <crawshaw@golang.org>
    Reviewed-by: Elias Naur <elias.naur@gmail.com>
    Run-TryBot: Austin Clements <austin@google.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>

 src/runtime/malloc.go | 21 +++++++++------------
 1 file changed, 9 insertions(+), 12 deletions(-)
