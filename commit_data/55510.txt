commit 0af2c78c362481e45339b76d0a210bf462cfe65c
Author: Damien Neil <dneil@google.com>
Date:   Wed Jan 25 09:27:01 2023 -0800

    mime/multipart: limit memory/inode consumption of ReadForm
    
    Reader.ReadForm is documented as storing "up to maxMemory bytes + 10MB"
    in memory. Parsed forms can consume substantially more memory than
    this limit, since ReadForm does not account for map entry overhead
    and MIME headers.
    
    In addition, while the amount of disk memory consumed by ReadForm can
    be constrained by limiting the size of the parsed input, ReadForm will
    create one temporary file per form part stored on disk, potentially
    consuming a large number of inodes.
    
    Update ReadForm's memory accounting to include part names,
    MIME headers, and map entry overhead.
    
    Update ReadForm to store all on-disk file parts in a single
    temporary file.
    
    Files returned by FileHeader.Open are documented as having a concrete
    type of *os.File when a file is stored on disk. The change to use a
    single temporary file for all parts means that this is no longer the
    case when a form contains more than a single file part stored on disk.
    
    The previous behavior of storing each file part in a separate disk
    file may be reenabled with GODEBUG=multipartfiles=distinct.
    
    Update Reader.NextPart and Reader.NextRawPart to set a 10MiB cap
    on the size of MIME headers.
    
    Thanks to Jakob Ackermann (@das7pad) for reporting this issue.
    
    Fixes #58006
    Fixes CVE-2022-41725
    
    Change-Id: Ibd780a6c4c83ac8bcfd3cbe344f042e9940f2eab
    Reviewed-on: https://team-review.git.corp.google.com/c/golang/go-private/+/1714276
    Reviewed-by: Julie Qiu <julieqiu@google.com>
    TryBot-Result: Security TryBots <security-trybots@go-security-trybots.iam.gserviceaccount.com>
    Reviewed-by: Roland Shoemaker <bracewell@google.com>
    Run-TryBot: Damien Neil <dneil@google.com>
    Reviewed-on: https://go-review.googlesource.com/c/go/+/468124
    Auto-Submit: Michael Pratt <mpratt@google.com>
    Run-TryBot: Michael Pratt <mpratt@google.com>
    Reviewed-by: Than McIntosh <thanm@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>

 src/mime/multipart/formdata.go       | 133 ++++++++++++++++++++++++++-------
 src/mime/multipart/formdata_test.go  | 141 ++++++++++++++++++++++++++++++++++-
 src/mime/multipart/multipart.go      |  25 +++++--
 src/mime/multipart/readmimeheader.go |  14 ++++
 src/net/http/request_test.go         |   2 +-
 src/net/textproto/reader.go          |  20 ++++-
 6 files changed, 297 insertions(+), 38 deletions(-)
