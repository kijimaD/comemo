commit 3f834114ab617eb7b414cb12e7ca8085b5fe3a5c
Author: Austin Clements <austin@google.com>
Date:   Fri Sep 27 12:27:51 2019 -0400

    runtime: add general suspendG/resumeG
    
    Currently, the process of suspending a goroutine is tied to stack
    scanning. In preparation for non-cooperative preemption, this CL
    abstracts this into general purpose suspendG/resumeG functions.
    
    suspendG and resumeG closely follow the existing scang and restartg
    functions with one exception: the addition of a _Gpreempted status.
    Currently, preemption tasks (stack scanning) are carried out by the
    target goroutine if it's in _Grunning. In this new approach, the task
    is always carried out by the goroutine that called suspendG. Thus, we
    need a reliable way to drive the target goroutine out of _Grunning
    until the requesting goroutine is ready to resume it. The new
    _Gpreempted state provides the handshake: when a runnable goroutine
    responds to a preemption request, it now parks itself and enters
    _Gpreempted. The requesting goroutine races to put it in _Gwaiting,
    which gives it ownership, but also the responsibility to start it
    again.
    
    This CL adds several TODOs about improving the synchronization on the
    G status. The existing code already has these problems; we're just
    taking note of them.
    
    The next CL will remove the now-dead scang and preemptscan.
    
    For #10958, #24543.
    
    Change-Id: I16dbf87bea9d50399cc86719c156f48e67198f16
    Reviewed-on: https://go-review.googlesource.com/c/go/+/201137
    Run-TryBot: Austin Clements <austin@google.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Cherry Zhang <cherryyz@google.com>

 src/runtime/mgcmark.go   |  16 +++-
 src/runtime/preempt.go   | 225 +++++++++++++++++++++++++++++++++++++++++++++++
 src/runtime/proc.go      |  56 +++++++++++-
 src/runtime/runtime2.go  |  21 +++--
 src/runtime/stack.go     |   5 ++
 src/runtime/traceback.go |   1 +
 6 files changed, 313 insertions(+), 11 deletions(-)
