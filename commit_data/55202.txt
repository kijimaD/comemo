commit c29444ef39a44ad56ddf7b3d2aa8a51df1163e04
Author: Russ Cox <rsc@golang.org>
Date:   Sun Aug 6 13:26:28 2023 +1000

    math/rand, math/rand/v2: use ChaCha8 for global rand
    
    Move ChaCha8 code into internal/chacha8rand and use it to implement
    runtime.rand, which is used for the unseeded global source for
    both math/rand and math/rand/v2. This also affects the calculation of
    the start point for iteration over very very large maps (when the
    32-bit fastrand is not big enough).
    
    The benefit is that misuse of the global random number generators
    in math/rand and math/rand/v2 in contexts where non-predictable
    randomness is important for security reasons is no longer a
    security problem, removing a common mistake among programmers
    who are unaware of the different kinds of randomness.
    
    The cost is an extra 304 bytes per thread stored in the m struct
    plus 2-3ns more per random uint64 due to the more sophisticated
    algorithm. Using PCG looks like it would cost about the same,
    although I haven't benchmarked that.
    
    Before this, the math/rand and math/rand/v2 global generator
    was wyrand (https://github.com/wangyi-fudan/wyhash).
    For math/rand, using wyrand instead of the Mitchell/Reeds/Thompson
    ALFG was justifiable, since the latter was not any better.
    But for math/rand/v2, the global generator really should be
    at least as good as one of the well-studied, specific algorithms
    provided directly by the package, and it's not.
    
    (Wyrand is still reasonable for scheduling and cache decisions.)
    
    Good randomness does have a cost: about twice wyrand.
    
    Also rationalize the various runtime rand references.
    
    goos: linux
    goarch: amd64
    pkg: math/rand/v2
    cpu: AMD Ryzen 9 7950X 16-Core Processor
                            │ bbb48afeb7.amd64 │           5cf807d1ea.amd64           │
                            │      sec/op      │    sec/op     vs base                │
    ChaCha8-32                     1.862n ± 2%    1.861n ± 2%        ~ (p=0.825 n=20)
    PCG_DXSM-32                    1.471n ± 1%    1.460n ± 2%        ~ (p=0.153 n=20)
    SourceUint64-32                1.636n ± 2%    1.582n ± 1%   -3.30% (p=0.000 n=20)
    GlobalInt64-32                 2.087n ± 1%    3.663n ± 1%  +75.54% (p=0.000 n=20)
    GlobalInt64Parallel-32        0.1042n ± 1%   0.2026n ± 1%  +94.48% (p=0.000 n=20)
    GlobalUint64-32                2.263n ± 2%    3.724n ± 1%  +64.57% (p=0.000 n=20)
    GlobalUint64Parallel-32       0.1019n ± 1%   0.1973n ± 1%  +93.67% (p=0.000 n=20)
    Int64-32                       1.771n ± 1%    1.774n ± 1%        ~ (p=0.449 n=20)
    Uint64-32                      1.863n ± 2%    1.866n ± 1%        ~ (p=0.364 n=20)
    GlobalIntN1000-32              3.134n ± 3%    4.730n ± 2%  +50.95% (p=0.000 n=20)
    IntN1000-32                    2.489n ± 1%    2.489n ± 1%        ~ (p=0.683 n=20)
    Int64N1000-32                  2.521n ± 1%    2.516n ± 1%        ~ (p=0.394 n=20)
    Int64N1e8-32                   2.479n ± 1%    2.478n ± 2%        ~ (p=0.743 n=20)
    Int64N1e9-32                   2.530n ± 2%    2.514n ± 2%        ~ (p=0.193 n=20)
    Int64N2e9-32                   2.501n ± 1%    2.494n ± 1%        ~ (p=0.616 n=20)
    Int64N1e18-32                  3.227n ± 1%    3.205n ± 1%        ~ (p=0.101 n=20)
    Int64N2e18-32                  3.647n ± 1%    3.599n ± 1%        ~ (p=0.019 n=20)
    Int64N4e18-32                  5.135n ± 1%    5.069n ± 2%        ~ (p=0.034 n=20)
    Int32N1000-32                  2.657n ± 1%    2.637n ± 1%        ~ (p=0.180 n=20)
    Int32N1e8-32                   2.636n ± 1%    2.636n ± 1%        ~ (p=0.763 n=20)
    Int32N1e9-32                   2.660n ± 2%    2.638n ± 1%        ~ (p=0.358 n=20)
    Int32N2e9-32                   2.662n ± 2%    2.618n ± 2%        ~ (p=0.064 n=20)
    Float32-32                     2.272n ± 2%    2.239n ± 2%        ~ (p=0.194 n=20)
    Float64-32                     2.272n ± 1%    2.286n ± 2%        ~ (p=0.763 n=20)
    ExpFloat64-32                  3.762n ± 1%    3.744n ± 1%        ~ (p=0.171 n=20)
    NormFloat64-32                 3.706n ± 1%    3.655n ± 2%        ~ (p=0.066 n=20)
    Perm3-32                       32.93n ± 3%    34.62n ± 1%   +5.13% (p=0.000 n=20)
    Perm30-32                      202.9n ± 1%    204.0n ± 1%        ~ (p=0.482 n=20)
    Perm30ViaShuffle-32            115.0n ± 1%    114.9n ± 1%        ~ (p=0.358 n=20)
    ShuffleOverhead-32             112.8n ± 1%    112.7n ± 1%        ~ (p=0.692 n=20)
    Concurrent-32                  2.107n ± 0%    3.725n ± 1%  +76.75% (p=0.000 n=20)
    
    goos: darwin
    goarch: arm64
    pkg: math/rand/v2
                           │ bbb48afeb7.arm64 │           5cf807d1ea.arm64            │
                           │      sec/op      │    sec/op     vs base                 │
    ChaCha8-8                     2.480n ± 0%    2.429n ± 0%    -2.04% (p=0.000 n=20)
    PCG_DXSM-8                    2.531n ± 0%    2.530n ± 0%         ~ (p=0.877 n=20)
    SourceUint64-8                2.534n ± 0%    2.533n ± 0%         ~ (p=0.732 n=20)
    GlobalInt64-8                 2.172n ± 1%    4.794n ± 0%  +120.67% (p=0.000 n=20)
    GlobalInt64Parallel-8        0.4320n ± 0%   0.9605n ± 0%  +122.32% (p=0.000 n=20)
    GlobalUint64-8                2.182n ± 0%    4.770n ± 0%  +118.58% (p=0.000 n=20)
    GlobalUint64Parallel-8       0.4307n ± 0%   0.9583n ± 0%  +122.51% (p=0.000 n=20)
    Int64-8                       4.107n ± 0%    4.104n ± 0%         ~ (p=0.416 n=20)
    Uint64-8                      4.080n ± 0%    4.080n ± 0%         ~ (p=0.052 n=20)
    GlobalIntN1000-8              2.814n ± 2%    5.643n ± 0%  +100.50% (p=0.000 n=20)
    IntN1000-8                    4.141n ± 0%    4.139n ± 0%         ~ (p=0.140 n=20)
    Int64N1000-8                  4.140n ± 0%    4.140n ± 0%         ~ (p=0.313 n=20)
    Int64N1e8-8                   4.140n ± 0%    4.139n ± 0%         ~ (p=0.103 n=20)
    Int64N1e9-8                   4.139n ± 0%    4.140n ± 0%         ~ (p=0.761 n=20)
    Int64N2e9-8                   4.140n ± 0%    4.140n ± 0%         ~ (p=0.636 n=20)
    Int64N1e18-8                  5.266n ± 0%    5.326n ± 1%    +1.14% (p=0.001 n=20)
    Int64N2e18-8                  6.052n ± 0%    6.167n ± 0%    +1.90% (p=0.000 n=20)
    Int64N4e18-8                  8.826n ± 0%    9.051n ± 0%    +2.55% (p=0.000 n=20)
    Int32N1000-8                  4.127n ± 0%    4.132n ± 0%    +0.12% (p=0.000 n=20)
    Int32N1e8-8                   4.126n ± 0%    4.131n ± 0%    +0.12% (p=0.000 n=20)
    Int32N1e9-8                   4.127n ± 0%    4.132n ± 0%    +0.12% (p=0.000 n=20)
    Int32N2e9-8                   4.132n ± 0%    4.131n ± 0%         ~ (p=0.017 n=20)
    Float32-8                     4.109n ± 0%    4.105n ± 0%         ~ (p=0.379 n=20)
    Float64-8                     4.107n ± 0%    4.106n ± 0%         ~ (p=0.867 n=20)
    ExpFloat64-8                  5.339n ± 0%    5.383n ± 0%    +0.82% (p=0.000 n=20)
    NormFloat64-8                 5.735n ± 0%    5.737n ± 1%         ~ (p=0.856 n=20)
    Perm3-8                       26.65n ± 0%    26.80n ± 1%    +0.58% (p=0.000 n=20)
    Perm30-8                      194.8n ± 1%    197.0n ± 0%    +1.18% (p=0.000 n=20)
    Perm30ViaShuffle-8            156.6n ± 0%    157.6n ± 1%    +0.61% (p=0.000 n=20)
    ShuffleOverhead-8             124.9n ± 0%    125.5n ± 0%    +0.52% (p=0.000 n=20)
    Concurrent-8                  2.434n ± 3%    5.066n ± 0%  +108.09% (p=0.000 n=20)
    
    goos: linux
    goarch: 386
    pkg: math/rand/v2
    cpu: AMD Ryzen 9 7950X 16-Core Processor
                            │ bbb48afeb7.386 │            5cf807d1ea.386             │
                            │     sec/op     │    sec/op     vs base                 │
    ChaCha8-32                  11.295n ± 1%    4.748n ± 2%   -57.96% (p=0.000 n=20)
    PCG_DXSM-32                  7.693n ± 1%    7.738n ± 2%         ~ (p=0.542 n=20)
    SourceUint64-32              7.658n ± 2%    7.622n ± 2%         ~ (p=0.344 n=20)
    GlobalInt64-32               3.473n ± 2%    7.526n ± 2%  +116.73% (p=0.000 n=20)
    GlobalInt64Parallel-32      0.3198n ± 0%   0.5444n ± 0%   +70.22% (p=0.000 n=20)
    GlobalUint64-32              3.612n ± 0%    7.575n ± 1%  +109.69% (p=0.000 n=20)
    GlobalUint64Parallel-32     0.3168n ± 0%   0.5403n ± 0%   +70.51% (p=0.000 n=20)
    Int64-32                     7.673n ± 2%    7.789n ± 1%         ~ (p=0.122 n=20)
    Uint64-32                    7.773n ± 1%    7.827n ± 2%         ~ (p=0.920 n=20)
    GlobalIntN1000-32            6.268n ± 1%    9.581n ± 1%   +52.87% (p=0.000 n=20)
    IntN1000-32                  10.33n ± 2%    10.45n ± 1%         ~ (p=0.233 n=20)
    Int64N1000-32                10.98n ± 2%    11.01n ± 1%         ~ (p=0.401 n=20)
    Int64N1e8-32                 11.19n ± 2%    10.97n ± 1%         ~ (p=0.033 n=20)
    Int64N1e9-32                 11.06n ± 1%    11.08n ± 1%         ~ (p=0.498 n=20)
    Int64N2e9-32                 11.10n ± 1%    11.01n ± 2%         ~ (p=0.995 n=20)
    Int64N1e18-32                15.23n ± 2%    15.04n ± 1%         ~ (p=0.973 n=20)
    Int64N2e18-32                15.89n ± 1%    15.85n ± 1%         ~ (p=0.409 n=20)
    Int64N4e18-32                18.96n ± 2%    19.34n ± 2%         ~ (p=0.048 n=20)
    Int32N1000-32                10.46n ± 2%    10.44n ± 2%         ~ (p=0.480 n=20)
    Int32N1e8-32                 10.46n ± 2%    10.49n ± 2%         ~ (p=0.951 n=20)
    Int32N1e9-32                 10.28n ± 2%    10.26n ± 1%         ~ (p=0.431 n=20)
    Int32N2e9-32                 10.50n ± 2%    10.44n ± 2%         ~ (p=0.249 n=20)
    Float32-32                   13.80n ± 2%    13.80n ± 2%         ~ (p=0.751 n=20)
    Float64-32                   23.55n ± 2%    23.87n ± 0%         ~ (p=0.408 n=20)
    ExpFloat64-32                15.36n ± 1%    15.29n ± 2%         ~ (p=0.316 n=20)
    NormFloat64-32               13.57n ± 1%    13.79n ± 1%    +1.66% (p=0.005 n=20)
    Perm3-32                     45.70n ± 2%    46.99n ± 2%    +2.81% (p=0.001 n=20)
    Perm30-32                    399.0n ± 1%    403.8n ± 1%    +1.19% (p=0.006 n=20)
    Perm30ViaShuffle-32          349.0n ± 1%    350.4n ± 1%         ~ (p=0.909 n=20)
    ShuffleOverhead-32           322.3n ± 1%    323.8n ± 1%         ~ (p=0.410 n=20)
    Concurrent-32                3.331n ± 1%    7.312n ± 1%  +119.50% (p=0.000 n=20)
    
    For #61716.
    
    Change-Id: Ibdddeed85c34d9ae397289dc899e04d4845f9ed2
    Reviewed-on: https://go-review.googlesource.com/c/go/+/516860
    Reviewed-by: Michael Pratt <mpratt@google.com>
    Reviewed-by: Filippo Valsorda <filippo@golang.org>
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>

 src/cmd/compile/internal/test/inl_test.go          |   2 +-
 .../compile/internal/typecheck/_builtin/runtime.go |   2 +-
 src/cmd/compile/internal/typecheck/builtin.go      |   2 +-
 src/cmd/compile/internal/walk/builtin.go           |   4 +-
 src/cmd/internal/goobj/builtinlist.go              |   2 +-
 src/cmd/internal/objabi/pkgspecial.go              |   2 +
 src/cmd/link/internal/ld/data.go                   |   9 +-
 src/hash/maphash/maphash_runtime.go                |   6 +-
 src/internal/chacha8rand/chacha8.go                |  19 ++
 src/internal/chacha8rand/chacha8_amd64.s           |   5 +-
 src/internal/chacha8rand/chacha8_arm64.s           |   6 +-
 src/internal/chacha8rand/export_test.go            |   4 +
 src/internal/chacha8rand/rand_test.go              |  10 +
 src/internal/coverage/pkid.go                      |   1 +
 src/math/rand/rand.go                              |  30 +--
 src/math/rand/v2/rand.go                           |  18 +-
 src/net/dnsclient.go                               |   6 +-
 src/os/tempfile.go                                 |   8 +-
 src/runtime/alg.go                                 |  17 +-
 src/runtime/export_test.go                         |   8 +-
 src/runtime/iface.go                               |   8 +-
 src/runtime/malloc.go                              |   4 +-
 src/runtime/map.go                                 |  23 +--
 src/runtime/map_fast32.go                          |   2 +-
 src/runtime/map_fast64.go                          |   2 +-
 src/runtime/map_faststr.go                         |   2 +-
 src/runtime/mbitmap_allocheaders.go                |   4 +-
 src/runtime/mgcpacer.go                            |   2 +-
 src/runtime/mprof.go                               |  12 +-
 src/runtime/os3_solaris.go                         |   4 +-
 src/runtime/os_aix.go                              |   4 +-
 src/runtime/os_darwin.go                           |   4 +-
 src/runtime/os_darwin_arm64.go                     |   1 -
 src/runtime/os_dragonfly.go                        |   4 +-
 src/runtime/os_freebsd.go                          |   4 +-
 src/runtime/os_freebsd_arm.go                      |   1 -
 src/runtime/os_freebsd_arm64.go                    |   1 -
 src/runtime/os_js.go                               |   5 +
 src/runtime/os_linux.go                            |  17 +-
 src/runtime/os_linux_arm.go                        |   1 -
 src/runtime/os_linux_arm64.go                      |   1 -
 src/runtime/os_linux_mips64x.go                    |   1 -
 src/runtime/os_linux_mipsx.go                      |   1 -
 src/runtime/os_netbsd.go                           |   4 +-
 src/runtime/os_netbsd_arm.go                       |   1 -
 src/runtime/os_netbsd_arm64.go                     |   1 -
 src/runtime/os_openbsd.go                          |   4 +-
 src/runtime/os_openbsd_arm.go                      |   1 -
 src/runtime/os_openbsd_arm64.go                    |   1 -
 src/runtime/os_openbsd_mips64.go                   |   1 -
 src/runtime/os_plan9.go                            |  20 +-
 src/runtime/os_plan9_arm.go                        |   1 -
 src/runtime/os_wasip1.go                           |   5 +-
 src/runtime/os_wasm.go                             |   2 -
 src/runtime/os_windows.go                          |   9 +-
 src/runtime/proc.go                                |  34 +---
 src/runtime/rand.go                                | 225 +++++++++++++++++++++
 src/runtime/rand_test.go                           |  11 +
 src/runtime/runtime2.go                            |  26 +--
 src/runtime/select.go                              |   2 +-
 src/runtime/sema.go                                |   2 +-
 src/runtime/stubs.go                               |  90 ---------
 src/runtime/symtab.go                              |   2 +-
 src/sync/pool.go                                   |   5 +-
 test/live.go                                       |   2 +-
 test/live_regabi.go                                |   2 +-
 66 files changed, 415 insertions(+), 305 deletions(-)
