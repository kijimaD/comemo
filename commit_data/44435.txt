commit 987ce938245566f8a8568cb3b7f43ff8442c2353
Author: Cherry Zhang <cherryyz@google.com>
Date:   Fri Jun 26 16:35:49 2020 -0400

    [dev.link] cmd/link: emit ELF relocations in mmap
    
    Currently, ELF relocations are generated sequentially in the heap
    and flushed to output file periodically. In fact, in some cases,
    the output size of the relocation records can be easily computed,
    as a relocation entry has fixed size. We only need to count the
    number of relocation records to compute the size.
    
    Once the size is computed, we can mmap the output with the proper
    size, and directly write relocation records in the mapped memory.
    It also opens the possibility of writing relocations in parallel
    (not done in this CL).
    
    Note: on some architectures, a Go relocation may turn into
    multiple ELF relocations, which makes size calculation harder.
    This CL does not handle those cases, and it still writes
    sequentially in the heap there.
    
    Linking cmd/compile with external linking,
    
    name          old time/op    new time/op    delta
    Asmb2            190ms ± 2%     141ms ± 4%  -25.74%  (p=0.000 n=10+10)
    
    name          old alloc/op   new alloc/op   delta
    Asmb2_GC        66.8MB ± 0%     8.2MB ± 0%  -87.79%  (p=0.008 n=5+5)
    
    name          old live-B     new live-B     delta
    Asmb2_GC         66.9M ± 0%     55.2M ± 0%  -17.58%  (p=0.008 n=5+5)
    
    Change-Id: If7056bbe909dc90033eef6b9c4891fcca310602c
    Reviewed-on: https://go-review.googlesource.com/c/go/+/240399
    Run-TryBot: Cherry Zhang <cherryyz@google.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Than McIntosh <thanm@google.com>

 src/cmd/link/internal/amd64/obj.go         |  1 +
 src/cmd/link/internal/arm/obj.go           |  1 +
 src/cmd/link/internal/ld/data.go           |  2 ++
 src/cmd/link/internal/ld/elf.go            | 25 ++++++++++++++++++++++++-
 src/cmd/link/internal/ld/lib.go            | 15 +++++++++------
 src/cmd/link/internal/ld/outbuf.go         |  5 +----
 src/cmd/link/internal/ld/outbuf_mmap.go    | 20 +++++++++++++++++++-
 src/cmd/link/internal/ld/outbuf_nommap.go  |  7 +++++++
 src/cmd/link/internal/ld/outbuf_windows.go | 15 +++++++++++++++
 src/cmd/link/internal/mips/obj.go          |  1 +
 src/cmd/link/internal/mips64/obj.go        |  1 +
 src/cmd/link/internal/s390x/obj.go         |  1 +
 src/cmd/link/internal/sym/segment.go       | 10 ++++++++--
 13 files changed, 90 insertions(+), 14 deletions(-)
