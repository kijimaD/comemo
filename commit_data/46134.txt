commit 4090af83c57c857de600ada68e7a27dffd37d8b1
Author: Russ Cox <rsc@golang.org>
Date:   Sun Dec 6 15:17:05 2020 -0500

    [dev.regabi] cmd/compile: use reflection in ir.Dump
    
    ir.Dump is the final (I think!) piece of the compiler that was walking
    nodes using Left, Right etc without knowing what they meant.
    This CL uses reflection to walk nodes without knowing what they mean instead.
    One benefit is that we can print actual meanings (field names).
    
    While we are here, I could not resist fixing a long-standing mental TODO:
    make the line number more clearly a line number. I've forgotten where the
    line number is in the dumps far too many times in the last decade.
    
    As a small example, here is a fragment of go tool compile -W test/235.go:
    
    .   FOR l(28) tc(1)
    .   .   LT-init
    .   .   .   AS l(28) tc(1)
    .   .   .   .   NAME-main..autotmp_4 l(28) x(0) class(PAUTO) esc(N) tc(1) assigned used int
    .   .   .   .   LEN l(28) tc(1) int
    .   .   .   .   .   NAME-main.xs g(2) l(26) x(0) class(PPARAM) esc(no) tc(1) used SLICE-[]uint64
    .   .   LT l(28) tc(1) hascall bool
    .   .   .   NAME-main.i g(4) l(28) x(0) class(PAUTO) esc(no) tc(1) assigned used int
    .   .   .   NAME-main..autotmp_4 l(28) x(0) class(PAUTO) esc(N) tc(1) assigned used int
    .   .   BLOCK l(28)
    .   .   BLOCK-list
    .   .   .   ASOP-ADD l(28) tc(1) implicit(true) int
    .   .   .   .   NAME-main.i g(4) l(28) x(0) class(PAUTO) esc(no) tc(1) assigned used int
    .   .   .   .   LITERAL-1 l(28) tc(1) int
    .   FOR-body
    .   .   VARKILL l(28) tc(1)
    .   .   .   NAME-main..autotmp_4 l(28) x(0) class(PAUTO) esc(N) tc(1) assigned used int
    .   .   IF l(29) tc(1)
    .   .   .   LT l(29) tc(1) bool
    .   .   .   .   INDEX l(29) tc(1) uint64
    .   .   .   .   .   NAME-main.xs g(2) l(26) x(0) class(PPARAM) esc(no) tc(1) used SLICE-[]uint64
    .   .   .   .   .   NAME-main.i g(4) l(28) x(0) class(PAUTO) esc(no) tc(1) assigned used int
    .   .   .   .   NAME-main.m g(3) l(27) x(0) class(PAUTO) esc(no) tc(1) assigned used uint64
    .   .   IF-body
    .   .   .   AS l(30) tc(1)
    .   .   .   .   NAME-main.m g(3) l(27) x(0) class(PAUTO) esc(no) tc(1) assigned used uint64
    .   .   .   .   INDEX l(30) tc(1) uint64
    .   .   .   .   .   NAME-main.xs g(2) l(26) x(0) class(PPARAM) esc(no) tc(1) used SLICE-[]uint64
    .   .   .   .   .   NAME-main.i g(4) l(28) x(0) class(PAUTO) esc(no) tc(1) assigned used int
    
    and here it is after this CL:
    
    .   FOR tc(1) # 235.go:28
    .   FOR-Cond
    .   .   LT-init
    .   .   .   AS tc(1) # 235.go:28
    .   .   .   .   NAME-main..autotmp_4 x(0) class(PAUTO) esc(N) tc(1) assigned used int # 235.go:28
    .   .   .   .   LEN tc(1) int # 235.go:28 int
    .   .   .   .   .   NAME-main.xs g(2) x(0) class(PPARAM) esc(no) tc(1) used SLICE-[]uint64 # 235.go:26
    .   .   LT tc(1) hascall bool # 235.go:28 bool
    .   .   .   NAME-main.i g(4) x(0) class(PAUTO) esc(no) tc(1) assigned used int # 235.go:28
    .   .   .   NAME-main..autotmp_4 x(0) class(PAUTO) esc(N) tc(1) assigned used int # 235.go:28
    .   FOR-Post
    .   .   BLOCK # 235.go:28
    .   .   BLOCK-List
    .   .   .   ASOP-ADD tc(1) implicit(true) int # 235.go:28 int
    .   .   .   .   NAME-main.i g(4) x(0) class(PAUTO) esc(no) tc(1) assigned used int # 235.go:28
    .   .   .   .   LITERAL-1 tc(1) int # 235.go:28
    .   FOR-Body
    .   .   VARKILL tc(1) # 235.go:28
    .   .   .   NAME-main..autotmp_4 x(0) class(PAUTO) esc(N) tc(1) assigned used int # 235.go:28
    .   .   IF tc(1) # 235.go:29
    .   .   IF-Cond
    .   .   .   LT tc(1) bool # 235.go:29 bool
    .   .   .   .   INDEX tc(1) uint64 # 235.go:29 uint64
    .   .   .   .   .   NAME-main.xs g(2) x(0) class(PPARAM) esc(no) tc(1) used SLICE-[]uint64 # 235.go:26
    .   .   .   .   .   NAME-main.i g(4) x(0) class(PAUTO) esc(no) tc(1) assigned used int # 235.go:28
    .   .   .   .   NAME-main.m g(3) x(0) class(PAUTO) esc(no) tc(1) assigned used uint64 # 235.go:27
    .   .   IF-Body
    .   .   .   AS tc(1) # 235.go:30
    .   .   .   .   NAME-main.m g(3) x(0) class(PAUTO) esc(no) tc(1) assigned used uint64 # 235.go:27
    .   .   .   .   INDEX tc(1) uint64 # 235.go:30 uint64
    .   .   .   .   .   NAME-main.xs g(2) x(0) class(PPARAM) esc(no) tc(1) used SLICE-[]uint64 # 235.go:26
    .   .   .   .   .   NAME-main.i g(4) x(0) class(PAUTO) esc(no) tc(1) assigned used int # 235.go:28
    
    Note in particular the clear marking of FOR-Cond, FOR-Post, FOR-Body compared to the original.
    
    The only changes to a few test files are the improved field name lines, and of course the line numbers.
    
    Passes buildall w/ toolstash -cmp.
    
    Change-Id: I5b654d9d8ee898976d4c387742ea688a082bac78
    Reviewed-on: https://go-review.googlesource.com/c/go/+/275785
    Trust: Russ Cox <rsc@golang.org>
    Run-TryBot: Russ Cox <rsc@golang.org>
    TryBot-Result: Go Bot <gobot@golang.org>
    Reviewed-by: Matthew Dempsky <mdempsky@google.com>

 src/cmd/compile/internal/ir/fmt.go | 149 ++++++++++++++++++++++++-------------
 1 file changed, 97 insertions(+), 52 deletions(-)
