commit bc874ec0dd0c803b5dd0ea96f9394bad39a20a74
Author: Russ Cox <rsc@golang.org>
Date:   Wed Feb 2 15:35:54 2011 -0500

    runtime: correct runtime.GOOS, runtime.GOARCH
    
    If the same directory was used for multiple builds,
    it was possible for a stale version.go to contain the
    wrong definitions for $GOOS and $GOARCH, because
    they can change even if the hg version does not.
    Split into multiple files to fix.
    
    R=r, r2
    CC=golang-dev
    https://golang.org/cl/4124050
---
 src/pkg/runtime/Makefile    | 10 ++++++++++
 src/pkg/runtime/mkversion.c |  6 ++----
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/pkg/runtime/Makefile b/src/pkg/runtime/Makefile
index e9488cfb50..3a2d313976 100644
--- a/src/pkg/runtime/Makefile
+++ b/src/pkg/runtime/Makefile
@@ -26,8 +26,12 @@ GOFILES=\
 	softfloat64.go\
 	type.go\
 	version.go\
+	version_$(GOOS).go\
+	version_$(GOARCH).go\
 	runtime_defs.go\
 
+CLEANFILES+=version.go version_*.go
+
 OFILES_windows=\
 	syscall.$O\
 
@@ -127,6 +131,12 @@ mkversion: mkversion.c
 version.go: mkversion
 	./mkversion >version.go
 
+version_$(GOARCH).go:
+	(echo 'package runtime'; echo 'const theGoarch = "$(GOARCH)"') >$@
+
+version_$(GOOS).go:
+	(echo 'package runtime'; echo 'const theGoos = "$(GOOS)"') >$@
+
 %.c:	%.goc goc2c
 	./goc2c `pwd`/$< > $@.tmp
 	mv -f $@.tmp $@
diff --git a/src/pkg/runtime/mkversion.c b/src/pkg/runtime/mkversion.c
index 9790d3f093..56afa1892e 100644
--- a/src/pkg/runtime/mkversion.c
+++ b/src/pkg/runtime/mkversion.c
@@ -5,13 +5,11 @@ char *template =
 	"// generated by mkversion.c; do not edit.\n"
 	"package runtime\n"
 	"const defaultGoroot = \"%s\"\n"
-	"const theVersion = \"%s\"\n"
-	"const theGoarch = \"%s\"\n"
-	"const theGoos = \"%s\"\n";
+	"const theVersion = \"%s\"\n";
 
 void
 main(void)
 {
-	print(template, getgoroot(), getgoversion(), getgoarch(), getgoos());
+	print(template, getgoroot(), getgoversion());
 	exits(0);
 }
