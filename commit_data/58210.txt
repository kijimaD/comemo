commit bfb8924653526d4c154c678f0d0bc491f60f7fce
Author: Michael Pratt <mpratt@google.com>
Date:   Mon May 15 18:00:57 2023 -0400

    cmd/compile: lookup indirect callees from export data for devirtualization
    
    Today, the PGO IR graph only contains entries for ir.Func loaded into
    the package. This can include functions from transitive dependencies,
    but only if they happen to be referenced by something in the current
    package. If they are not referenced, noder never bothers to load them.
    
    This leads to a deficiency in PGO devirtualization: some callee methods
    are available in transitive dependencies but do not devirtualize because
    they happen to not get loaded from export data.
    
    Resolve this by adding an explicit lookup from export data of callees
    mentioned in the profile.
    
    I have chosen to do this during loading of the profile for simplicity:
    the PGO IR graph always contains all of the functions we might need.
    That said, it isn't strictly necessary. PGO devirtualization could do
    the lookup lazily if it decides it actually needs a method. This saves
    work at the expense of a bit more complexity, but I've chosen the
    simpler approach for now as I measured the cost of this as significantly
    less than the rest of PGO loading.
    
    For #61577.
    
    Change-Id: Ieafb2a549510587027270ee6b4c3aefd149a901f
    Reviewed-on: https://go-review.googlesource.com/c/go/+/497175
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>
    Reviewed-by: Matthew Dempsky <mdempsky@google.com>
    Reviewed-by: Cherry Mui <cherryyz@google.com>

 src/cmd/compile/internal/inline/inl.go             |  27 +-----
 src/cmd/compile/internal/ir/expr.go                |  45 +++++++++
 src/cmd/compile/internal/ir/func.go                |  62 ++++++++++++
 src/cmd/compile/internal/ir/func_test.go           |  82 ++++++++++++++++
 src/cmd/compile/internal/noder/unified.go          |  62 ++++++++++++
 src/cmd/compile/internal/pgo/irgraph.go            | 106 +++++++++++++++++----
 .../compile/internal/test/pgo_devirtualize_test.go |  10 +-
 .../test/testdata/pgo/devirtualize/devirt.go       |  17 ++--
 .../test/testdata/pgo/devirtualize/devirt.pprof    | Bin 699 -> 890 bytes
 .../test/testdata/pgo/devirtualize/devirt_test.go  |   2 +-
 .../pgo/devirtualize/{mult => mult.pkg}/mult.go    |   0
 src/cmd/compile/internal/types/pkg.go              |  12 +++
 12 files changed, 367 insertions(+), 58 deletions(-)
