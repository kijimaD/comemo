commit 9f8f8c27dca1b27e9567df4f3aa4e7d8c31f3ec2
Author: Josh Bleecher Snyder <josharian@gmail.com>
Date:   Sat Aug 22 19:38:12 2015 -0700

    [dev.ssa] cmd/compile: support spilling and loading flags
    
    This CL takes a simple approach to spilling and loading flags.
    We never spill. When a load is needed, we recalculate,
    loading the arguments as needed.
    
    This is simple and architecture-independent.
    It is not very efficient, but as of this CL,
    there are fewer than 200 flag spills during make.bash.
    
    This was tested by manually reverting CLs 13813 and 13843,
    causing SETcc, MOV, and LEA instructions to clobber flags,
    which dramatically increases the number of flags spills.
    With that done, all stdlib tests that used to pass
    still pass.
    
    For future reference, here are some other, more efficient
    amd64-only schemes that we could adapt in the future if needed.
    
    (1) Spill exactly the flags needed.
    
    For example, if we know that the flags will be needed
    by a SETcc or Jcc op later, we could use SETcc to
    extract just the relevant flag. When needed,
    we could use TESTB and change the op to JNE/SETNE.
    (Alternatively, we could leave the op unaltered
    and prepare an appropriate CMPB instruction
    to produce the desired flag.)
    
    However, this requires separate handling for every
    instruction that uses the flags register,
    including (say) SBBQcarrymask.
    
    We could enable this on an ad hoc basis for common cases
    and fall back to recalculation for other cases.
    
    (2) Spill all flags with PUSHF and POPF
    
    This modifies SP, which the runtime won't like.
    It also requires coordination with stackalloc to
    make sure that we have a stack slot ready for use.
    
    (3) Spill almost all flags with LAHF, SETO, and SAHF
    
    See http://blog.freearrow.com/archives/396
    for details. This would handle all the flags we currently
    use. However, LAHF and SAHF are not universally available
    and it requires arranging for AX to be free.
    
    Change-Id: Ie36600fd8e807ef2bee83e2e2ae3685112a7f276
    Reviewed-on: https://go-review.googlesource.com/13844
    Reviewed-by: Keith Randall <khr@golang.org>

 src/cmd/compile/internal/ssa/regalloc.go | 52 +++++++++++++++++++++++++++-----
 1 file changed, 44 insertions(+), 8 deletions(-)
