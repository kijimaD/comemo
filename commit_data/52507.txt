commit 4a5711c3cf944b3ff51af261166ef34b2ed22b8a
Author: Paul E. Murphy <murp@ibm.com>
Date:   Thu Oct 21 15:25:14 2021 -0500

    cmd/compile,cmd/asm: fix ppc64 usage of BI argument of BC opcode
    
    Avoid coercing the CR bit into a GPR register type argument, and
    move the existing usage to CRx_y register types. And, update the
    compiler usage to this. This transformation is done internally,
    so it should not alter existing assembly code.
    
    Likewise, add assembly tests for all optab entries of BC/BR. This
    found some cases which were not possible to realize with handwritten
    asm, or assemble to something very unexpected if generated by the
    compiler. The following optab entries are removed, and the cases
    simplified or removed:
    
    {as: ABR, a3: C_SCON, a6: C_LR, type_: 18, size: 4}
    
      This existed only to pass the BH hint to JMP (LR) from compiler
      generated code. It cannot be matched with asm. Instead, add and
      support 4-operand form "BC{,L} $BO, $BI, $BH, (LR)".
    
    {as: ABR, a1: C_REG, a6: C_CTR, type_: 18, size: 4}
    
      Could be used like  "BR R1, (CTR)", but always compiles to bctr
      irrespective of arg 1. Any usage should be rewritten as "JMP (CTR)",
      or rewritten if this was not the intended behavior.
    
    {as: ABR, a6: C_ZOREG, type_: 15, size: 8}:
    {as: ABC, a6: C_ZOREG, type_: 15, size: 8},
    
      Not reachable: 0(reg) is coerced to reg in assembler frontend.
    
    {as: ABC, a2: C_REG, a6: C_LR, type_: 18, size: 4}
    {as: ABC, a2: C_REG, a6: C_CTR, type_: 18, size: 4}
    
      Only usable from the compiler. However, the compiler does not
      generate this form today. Without a BO operand (usually in a1), it
      is not clear what this should assemble to.
    
    Change-Id: I1b5151f884a5877e4a610e6fd41261e8e64c5454
    Reviewed-on: https://go-review.googlesource.com/c/go/+/357775
    Reviewed-by: Lynn Boger <laboger@linux.vnet.ibm.com>
    Run-TryBot: Paul Murphy <murp@ibm.com>
    Reviewed-by: Than McIntosh <thanm@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Reviewed-by: David Chase <drchase@google.com>

 src/cmd/asm/internal/asm/asm.go           | 49 +++++++++++++++++++------
 src/cmd/asm/internal/asm/testdata/ppc64.s | 61 +++++++++++++++++++++++++------
 src/cmd/compile/internal/ppc64/ssa.go     | 17 ++++++---
 src/cmd/internal/obj/ppc64/a.out.go       |  3 ++
 src/cmd/internal/obj/ppc64/asm9.go        | 39 +++++---------------
 src/cmd/internal/obj/ppc64/asm_test.go    | 21 +++++------
 src/cmd/internal/obj/ppc64/list9.go       |  6 +++
 7 files changed, 127 insertions(+), 69 deletions(-)
