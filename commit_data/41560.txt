commit cd9fd640db419ec81026945eb4f22bfe5ff5a27f
Author: Keith Randall <khr@golang.org>
Date:   Tue Mar 3 17:56:20 2020 +0000

    cmd/compile: don't allow NaNs in floating-point constant ops
    
    Trying this CL again, with a fixed test that allows platforms
    to disagree on the exact behavior of converting NaNs.
    
    We store 32-bit floating point constants in a 64-bit field, by
    converting that 32-bit float to 64-bit float to store it, and convert
    it back to use it.
    
    That works for *almost* all floating-point constants. The exception is
    signaling NaNs. The round trip described above means we can't represent
    a 32-bit signaling NaN, because conversions strip the signaling bit.
    
    To fix this issue, just forbid NaNs as floating-point constants in SSA
    form. This shouldn't affect any real-world code, as people seldom
    constant-propagate NaNs (except in test code).
    
    Additionally, NaNs are somewhat underspecified (which of the many NaNs
    do you get when dividing 0/0?), so when cross-compiling there's a
    danger of using the compiler machine's NaN regime for some math, and
    the target machine's NaN regime for other math. Better to use the
    target machine's NaN regime always.
    
    Update #36400
    
    Change-Id: Idf203b688a15abceabbd66ba290d4e9f63619ecb
    Reviewed-on: https://go-review.googlesource.com/c/go/+/221790
    Run-TryBot: Keith Randall <khr@golang.org>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Josh Bleecher Snyder <josharian@gmail.com>

 src/cmd/compile/internal/gc/float_test.go      | 58 ++++++++++++++++++++++++++
 src/cmd/compile/internal/ssa/check.go          | 10 ++++-
 src/cmd/compile/internal/ssa/gen/PPC64.rules   |  2 +-
 src/cmd/compile/internal/ssa/gen/Wasm.rules    | 21 +++++-----
 src/cmd/compile/internal/ssa/gen/generic.rules | 14 +++----
 src/cmd/compile/internal/ssa/gen/genericOps.go |  7 +++-
 src/cmd/compile/internal/ssa/rewrite.go        |  6 +++
 src/cmd/compile/internal/ssa/rewritePPC64.go   |  4 ++
 src/cmd/compile/internal/ssa/rewriteWasm.go    | 41 ++++++++++++++++++
 src/cmd/compile/internal/ssa/rewritegeneric.go | 28 +++++++++++--
 test/codegen/math.go                           | 33 ++++++++++++++-
 11 files changed, 198 insertions(+), 26 deletions(-)
