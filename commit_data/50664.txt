commit 53773a5d0892be4489b4d5e91bbc8ae61000ada7
Author: Than McIntosh <thanm@google.com>
Date:   Mon Oct 11 11:26:19 2021 -0400

    cmd/go: support new hybrid coverage instrumentation
    
    If GOEXPERIMENT=coverageredesign is in effect, introduce a new
    top-level '-cover' option to "go build" to turn on new-style hybrid
    code coverage instrumentation. Similarly, use the new instrumentation
    for "go test -cover".
    
    The main effects of "-cover" under the hood are to instrument files at
    the package level using cmd/cover and to pass additional options to
    the compiler when building instrumented packages.
    
    The previous workflow for "go tool -cover mypkg" would expand to a
    series of "go tool cover" commands (one per file) followed by a single
    package compilation command to build the rewritten sources.
    
    With the new workflow, the Go command will pass all of the Go files in
    a package to the cover tool as a chunk (along with a config file
    containing other parameters), then the cover tool will write
    instrumented versions of the sources along with another "output"
    config with info on coverage variable names for the the compiler. The
    Go command will then kick off the compiler on the modified source
    files, also passing in the config file generated by cmd/cover.
    
    Updates #51430.
    
    Change-Id: Id65621ff6a8c70a30168c1412c2d6f805ff3b9e7
    Reviewed-on: https://go-review.googlesource.com/c/go/+/355452
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Run-TryBot: Than McIntosh <thanm@google.com>
    Reviewed-by: Bryan Mills <bcmills@google.com>

 src/cmd/go/alldocs.go                              |  16 ++
 src/cmd/go/go_test.go                              |   1 +
 src/cmd/go/internal/cfg/cfg.go                     |   3 +
 src/cmd/go/internal/help/helpdoc.go                |   7 +
 src/cmd/go/internal/load/pkg.go                    | 212 +++++++++++++++++++++
 src/cmd/go/internal/load/test.go                   | 159 +++++++++++++---
 src/cmd/go/internal/run/run.go                     |   7 +
 src/cmd/go/internal/test/cover.go                  |   7 +-
 src/cmd/go/internal/test/flagdefs_test.go          |   3 +-
 src/cmd/go/internal/test/test.go                   | 170 +++--------------
 src/cmd/go/internal/test/testflag.go               |  68 +------
 src/cmd/go/internal/work/build.go                  |  97 ++++++++++
 src/cmd/go/internal/work/exec.go                   |  98 +++++++++-
 src/cmd/go/internal/work/gc.go                     |   3 +
 src/cmd/go/internal/work/init.go                   |  13 ++
 src/cmd/go/script_test.go                          |   1 +
 src/cmd/go/testdata/script/README                  |   1 +
 .../go/testdata/script/cover_build_pkg_select.txt  | 114 +++++++++++
 src/cmd/go/testdata/script/cover_build_simple.txt  | 149 +++++++++++++++
 .../go/testdata/script/cover_test_pkgselect.txt    |  80 ++++++++
 src/testing/cover.go                               |   5 +
 src/testing/newcover.go                            |  41 ++++
 src/testing/testing.go                             |  14 +-
 23 files changed, 1027 insertions(+), 242 deletions(-)
