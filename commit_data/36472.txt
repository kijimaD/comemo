commit b1d1ec9183590f43ea180e101a4f53ab29779e9c
Author: Elias Naur <elias.naur@gmail.com>
Date:   Sun Apr 29 16:29:43 2018 +0200

    runtime: perform crashes outside systemstack
    
    CL 93658 moved stack trace printing inside a systemstack call to
    sidestep complexity in case the runtime is in a inconsistent state.
    
    Unfortunately, debuggers generating backtraces for a Go panic
    will be confused and come up with a technical correct but useless
    stack. This CL moves just the crash performing - typically a SIGABRT
    signal - outside the systemstack call to improve backtraces.
    
    Unfortunately, the crash function now needs to be marked nosplit and
    that triggers the no split stackoverflow check. To work around that,
    split fatalpanic in two: fatalthrow for runtime.throw and fatalpanic for
    runtime.gopanic. Only Go panics really needs crashes on the right stack
    and there is enough stack for gopanic.
    
    Example program:
    
    package main
    
    import "runtime/debug"
    
    func main() {
            debug.SetTraceback("crash")
            crash()
    }
    
    func crash() {
            panic("panic!")
    }
    
    Before:
    (lldb) bt
    * thread #1, name = 'simple', stop reason = signal SIGABRT
      * frame #0: 0x000000000044ffe4 simple`runtime.raise at <autogenerated>:1
        frame #1: 0x0000000000438cfb simple`runtime.dieFromSignal(sig=<unavailable>) at signal_unix.go:424
        frame #2: 0x0000000000438ec9 simple`runtime.crash at signal_unix.go:525
        frame #3: 0x00000000004268f5 simple`runtime.dopanic_m(gp=<unavailable>, pc=<unavailable>, sp=<unavailable>) at panic.go:758
        frame #4: 0x000000000044bead simple`runtime.fatalpanic.func1 at panic.go:657
        frame #5: 0x000000000044d066 simple`runtime.systemstack at <autogenerated>:1
        frame #6: 0x000000000042a980 simple at proc.go:1094
        frame #7: 0x0000000000438ec9 simple`runtime.crash at signal_unix.go:525
        frame #8: 0x00000000004268f5 simple`runtime.dopanic_m(gp=<unavailable>, pc=<unavailable>, sp=<unavailable>) at panic.go:758
        frame #9: 0x000000000044bead simple`runtime.fatalpanic.func1 at panic.go:657
        frame #10: 0x000000000044d066 simple`runtime.systemstack at <autogenerated>:1
        frame #11: 0x000000000042a980 simple at proc.go:1094
        frame #12: 0x00000000004268f5 simple`runtime.dopanic_m(gp=<unavailable>, pc=<unavailable>, sp=<unavailable>) at panic.go:758
        frame #13: 0x000000000044bead simple`runtime.fatalpanic.func1 at panic.go:657
        frame #14: 0x000000000044d066 simple`runtime.systemstack at <autogenerated>:1
        frame #15: 0x000000000042a980 simple at proc.go:1094
        frame #16: 0x000000000044bead simple`runtime.fatalpanic.func1 at panic.go:657
        frame #17: 0x000000000044d066 simple`runtime.systemstack at <autogenerated>:1
    
    After:
    (lldb) bt
    * thread #7, stop reason = signal SIGABRT
      * frame #0: 0x0000000000450024 simple`runtime.raise at <autogenerated>:1
        frame #1: 0x0000000000438d1b simple`runtime.dieFromSignal(sig=<unavailable>) at signal_unix.go:424
        frame #2: 0x0000000000438ee9 simple`runtime.crash at signal_unix.go:525
        frame #3: 0x00000000004264e3 simple`runtime.fatalpanic(msgs=<unavailable>) at panic.go:664
        frame #4: 0x0000000000425f1b simple`runtime.gopanic(e=<unavailable>) at panic.go:537
        frame #5: 0x0000000000470c62 simple`main.crash at simple.go:11
        frame #6: 0x0000000000470c00 simple`main.main at simple.go:6
        frame #7: 0x0000000000427be7 simple`runtime.main at proc.go:198
        frame #8: 0x000000000044ef91 simple`runtime.goexit at <autogenerated>:1
    
    Updates #22716
    
    Change-Id: Ib5fa35c13662c1dac2f1eac8b59c4a5824b98d92
    Reviewed-on: https://go-review.googlesource.com/110065
    Run-TryBot: Elias Naur <elias.naur@gmail.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Austin Clements <austin@google.com>

 src/runtime/os_nacl.go          |  1 +
 src/runtime/os_plan9.go         |  1 +
 src/runtime/panic.go            | 59 ++++++++++++++++++++++++++++--------
 src/runtime/runtime-gdb_test.go | 66 +++++++++++++++++++++++++++++++++++++++++
 src/runtime/signal_unix.go      |  1 +
 src/runtime/signal_windows.go   |  1 +
 6 files changed, 116 insertions(+), 13 deletions(-)
