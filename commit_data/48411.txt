commit b9417ffd2797753219aa404abcb848e7c7c8bfd8
Author: Roland Shoemaker <roland@golang.org>
Date:   Sat May 15 18:46:05 2021 -0700

    [dev.fuzz] internal/fuzz: move coverage capture closer to function
    
    When instrumented packages intersect with the packages used by the
    testing or internal/fuzz packages the coverage counters become noisier,
    as counters will be triggered by non-fuzzed harness code.
    
    Ideally counters would be deterministic, as there are many advanced
    fuzzing strategies that require mutating the input while maintaining
    static coverage.
    
    The simplest way to mitigate this noise is to capture the coverage
    counters as closely as possible to the invocation of the fuzz target
    in the testing package. In order to do this add a new function which
    captures the current values of the counters, SnapshotCoverage. This
    function copies the current counters into a static buffer,
    coverageSnapshot, which workerServer.fuzz can then inspect when it
    comes time to check if new coverage has been found.
    
    This method is not foolproof. As the fuzz target is called in a
    goroutine, harness code can still cause counters to be incremented
    while the target is being executed. Despite this we do see
    significant reduction in churn via this approach. For example,
    running a  basic target that causes strconv to be instrumented for
    500,000 iterations causes ~800 unique sets of coverage counters,
    whereas by capturing the counters closer to the target we get ~40
    unique sets.
    
    It may be possible to make counters completely deterministic, but
    likely this would require rewriting testing/F.Fuzz to not use tRunner
    in a goroutine, and instead use it in a blocking manner (which I
    couldn't figure out an obvious way to do), or by doing something even
    more complex.
    
    Change-Id: I95c2f3b1d7089c3e6885fc7628a0d3a8ac1a99cf
    Reviewed-on: https://go-review.googlesource.com/c/go/+/320329
    Trust: Roland Shoemaker <roland@golang.org>
    Trust: Katie Hockman <katie@golang.org>
    Reviewed-by: Jay Conrod <jayconrod@google.com>
    Reviewed-by: Katie Hockman <katie@golang.org>

 src/internal/fuzz/coverage.go         | 26 ++++++++++++++------------
 src/internal/fuzz/fuzz.go             |  6 +++---
 src/internal/fuzz/worker.go           | 16 +++++-----------
 src/testing/fuzz.go                   | 16 ++++++++++++----
 src/testing/internal/testdeps/deps.go |  8 ++++++++
 src/testing/testing.go                |  4 ++++
 6 files changed, 46 insertions(+), 30 deletions(-)
