commit 94764d093822721337243de77aeba72df1f9b230
Author: Michael Matloob <matloob@golang.org>
Date:   Fri May 30 18:20:05 2025 -0400

    cmd/doc: build cmd/doc directly into the go command
    
    There are a couple of places where our tests expect that 'go doc'
    doesn't need to do a build. Invoke the cmd/doc code directly by the go
    command instead of starting the doc tool in a separate process so we can
    preserve that property.
    
    This change moves most of the doc code into the package
    cmd/internal/doc, and exposes a Main function from that function that's
    called both by the cmd/doc package, and by go doc.
    
    This change makes couple of additional changes to intergrate doc into
    the go command:
    
    The counter.Open call and the increment of invocations counter are only
    needed by cmd/doc. The go command will open the counters file and
    increment a counter for the doc subcommand.
    
    We add a cmd_go_bootstrap tagged variant of the file that defines go doc
    so that we don't end up linking net into the bootstrap version of the go
    command. We don't need doc in that version of the command.
    
    We create a new flagSet rather than using flag.CommandLine because when
    running as part of the go command, the flags to "go doc" won't be the top
    level flags.
    
    We change TestGoListTest in go_test.go to use gofmt instead of doc as an
    example of a main package in cmd with an in-package test.
    
    For #71867
    
    Change-Id: I3e3df83e5fa266559606fdc086b461165e09f037
    Reviewed-on: https://go-review.googlesource.com/c/go/+/677775
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>
    Reviewed-by: Michael Pratt <mpratt@google.com>
    Reviewed-by: Michael Matloob <matloob@google.com>

 src/cmd/doc/doc.go                                 | 55 ++++++++++++++++++
 src/cmd/go/go_test.go                              |  6 +-
 src/cmd/go/internal/doc/doc.go                     | 18 ++----
 src/cmd/go/internal/doc/doc_bootstrap.go           | 13 +++++
 src/cmd/{ => internal}/doc/dirs.go                 |  2 +-
 src/cmd/{ => internal}/doc/doc_test.go             |  6 +-
 src/cmd/{ => internal}/doc/main.go                 | 67 +++++-----------------
 src/cmd/{ => internal}/doc/pkg.go                  |  2 +-
 src/cmd/{ => internal}/doc/signal_notunix.go       |  2 +-
 src/cmd/{ => internal}/doc/signal_unix.go          |  2 +-
 src/cmd/{ => internal}/doc/testdata/merge/aa.go    |  0
 src/cmd/{ => internal}/doc/testdata/merge/bb.go    |  0
 .../doc/testdata/nested/empty/empty.go             |  0
 .../{ => internal}/doc/testdata/nested/ignore.go   |  0
 .../doc/testdata/nested/nested/real.go             |  0
 src/cmd/{ => internal}/doc/testdata/pkg.go         |  0
 16 files changed, 97 insertions(+), 76 deletions(-)
