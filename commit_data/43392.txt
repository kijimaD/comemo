commit 8114242359a32dbbfe44cf6cc83c48cca7d6c126
Author: Josh Bleecher Snyder <josharian@gmail.com>
Date:   Tue Mar 24 22:14:02 2020 -0700

    cmd/compile, runtime: use more registers for amd64 write barrier calls
    
    The compiler-inserted write barrier calls use a special ABI
    for speed and to minimize the binary size impact.
    
    runtime.gcWriteBarrier takes its args in DI and AX.
    This change adds gcWriteBarrier wrapper functions,
    varying only in the register used for the second argument.
    (Allowing variation in the first argument doesn't offer improvements,
    which is convenient, as it avoids quadratic API growth.)
    This reduces the number of register copies.
    
    The goals are reduced binary size via reduced register pressure/copies.
    
    One downside to this change is that when the write barrier is on,
    we may bounce through several different write barrier wrappers,
    which is bad for the instruction cache.
    
    Package runtime write barrier benchmarks for this change:
    
    name                old time/op  new time/op  delta
    WriteBarrier-8      16.6ns ± 6%  15.6ns ± 6%  -5.73%  (p=0.000 n=97+99)
    BulkWriteBarrier-8  4.37ns ± 7%  4.22ns ± 8%  -3.45%  (p=0.000 n=96+99)
    
    However, I don't particularly trust these numbers.
    I ran runtime.BenchmarkWriteBarrier multiple times as I rebased
    this change, and noticed that the results have high variance
    depending on the parent change, perhaps due to aligment.
    
    This change was stress tested with GOGC=1 GODEBUG=gccheckmark=1 go test std.
    
    This change reduces binary sizes:
    
    file      before    after     Δ       %
    addr2line 4308720   4296688   -12032  -0.279%
    api       5965592   5945368   -20224  -0.339%
    asm       5148088   5025464   -122624 -2.382%
    buildid   2848760   2844904   -3856   -0.135%
    cgo       4828968   4812840   -16128  -0.334%
    compile   19754720  19529744  -224976 -1.139%
    cover     5256840   5236600   -20240  -0.385%
    dist      3670312   3658264   -12048  -0.328%
    doc       4669608   4657576   -12032  -0.258%
    fix       3377976   3365944   -12032  -0.356%
    link      6614888   6586472   -28416  -0.430%
    nm        4258368   4254528   -3840   -0.090%
    objdump   4656336   4644304   -12032  -0.258%
    pack      2295176   2295432   +256    +0.011%
    pprof     14762356  14709364  -52992  -0.359%
    test2json 2824456   2820600   -3856   -0.137%
    trace     11684404  11643700  -40704  -0.348%
    vet       8284760   8252248   -32512  -0.392%
    total     115210328 114580040 -630288 -0.547%
    
    This change improves compiler performance:
    
    name        old time/op       new time/op       delta
    Template          208ms ± 3%        207ms ± 3%  -0.40%  (p=0.030 n=43+44)
    Unicode          80.2ms ± 3%       81.3ms ± 3%  +1.25%  (p=0.000 n=41+44)
    GoTypes           699ms ± 3%        694ms ± 2%  -0.71%  (p=0.016 n=42+37)
    Compiler          3.26s ± 2%        3.23s ± 2%  -0.86%  (p=0.000 n=43+45)
    SSA               6.97s ± 1%        6.93s ± 1%  -0.63%  (p=0.000 n=43+45)
    Flate             134ms ± 3%        133ms ± 2%    ~     (p=0.139 n=45+42)
    GoParser          165ms ± 2%        164ms ± 1%  -0.79%  (p=0.000 n=45+40)
    Reflect           434ms ± 4%        435ms ± 4%    ~     (p=0.937 n=44+44)
    Tar               181ms ± 2%        181ms ± 2%    ~     (p=0.702 n=43+45)
    XML               244ms ± 2%        244ms ± 2%    ~     (p=0.237 n=45+44)
    [Geo mean]        403ms             402ms       -0.29%
    
    name        old user-time/op  new user-time/op  delta
    Template          271ms ± 2%        268ms ± 1%  -1.40%  (p=0.000 n=42+42)
    Unicode           117ms ± 3%        116ms ± 5%    ~     (p=0.066 n=45+45)
    GoTypes           948ms ± 2%        936ms ± 2%  -1.30%  (p=0.000 n=41+40)
    Compiler          4.26s ± 1%        4.21s ± 2%  -1.25%  (p=0.000 n=37+45)
    SSA               9.52s ± 2%        9.41s ± 1%  -1.18%  (p=0.000 n=44+45)
    Flate             167ms ± 2%        165ms ± 2%  -1.15%  (p=0.000 n=44+41)
    GoParser          201ms ± 2%        198ms ± 1%  -1.40%  (p=0.000 n=43+43)
    Reflect           563ms ± 8%        560ms ± 7%    ~     (p=0.206 n=45+44)
    Tar               224ms ± 2%        222ms ± 2%  -0.81%  (p=0.000 n=45+45)
    XML               308ms ± 2%        304ms ± 1%  -1.17%  (p=0.000 n=42+43)
    [Geo mean]        525ms             519ms       -1.08%
    
    name        old alloc/op      new alloc/op      delta
    Template         36.3MB ± 0%       36.3MB ± 0%    ~     (p=0.421 n=5+5)
    Unicode          28.4MB ± 0%       28.3MB ± 0%    ~     (p=0.056 n=5+5)
    GoTypes           121MB ± 0%        121MB ± 0%  -0.14%  (p=0.008 n=5+5)
    Compiler          567MB ± 0%        567MB ± 0%  -0.06%  (p=0.016 n=4+5)
    SSA              1.26GB ± 0%       1.26GB ± 0%  -0.07%  (p=0.008 n=5+5)
    Flate            22.9MB ± 0%       22.8MB ± 0%    ~     (p=0.310 n=5+5)
    GoParser         28.0MB ± 0%       27.9MB ± 0%  -0.09%  (p=0.008 n=5+5)
    Reflect          78.4MB ± 0%       78.4MB ± 0%  -0.03%  (p=0.008 n=5+5)
    Tar              34.2MB ± 0%       34.2MB ± 0%  -0.05%  (p=0.008 n=5+5)
    XML              44.4MB ± 0%       44.4MB ± 0%  -0.04%  (p=0.016 n=5+5)
    [Geo mean]       76.4MB            76.3MB       -0.05%
    
    name        old allocs/op     new allocs/op     delta
    Template           356k ± 0%         356k ± 0%  -0.13%  (p=0.008 n=5+5)
    Unicode            326k ± 0%         326k ± 0%  -0.07%  (p=0.008 n=5+5)
    GoTypes           1.24M ± 0%        1.24M ± 0%  -0.24%  (p=0.008 n=5+5)
    Compiler          5.30M ± 0%        5.28M ± 0%  -0.34%  (p=0.008 n=5+5)
    SSA               11.9M ± 0%        11.9M ± 0%  -0.16%  (p=0.008 n=5+5)
    Flate              226k ± 0%         225k ± 0%  -0.12%  (p=0.008 n=5+5)
    GoParser           287k ± 0%         286k ± 0%  -0.29%  (p=0.008 n=5+5)
    Reflect            930k ± 0%         929k ± 0%  -0.05%  (p=0.008 n=5+5)
    Tar                332k ± 0%         331k ± 0%  -0.12%  (p=0.008 n=5+5)
    XML                411k ± 0%         411k ± 0%  -0.12%  (p=0.008 n=5+5)
    [Geo mean]         771k              770k       -0.16%
    
    For some packages, this change significantly reduces the size of executable text.
    Examples:
    
    file                                   before   after    Δ       %
    cmd/internal/obj/arm.s                 68658    66855    -1803   -2.626%
    cmd/internal/obj/mips.s                57486    56272    -1214   -2.112%
    cmd/internal/obj/arm64.s               152107   147163   -4944   -3.250%
    cmd/internal/obj/ppc64.s               125544   120456   -5088   -4.053%
    cmd/vendor/golang.org/x/tools/go/cfg.s 31699    30742    -957    -3.019%
    
    Full listing:
    
    file                                                                     before   after    Δ       %
    container/ring.s                                                         1890     1870     -20     -1.058%
    container/list.s                                                         5366     5390     +24     +0.447%
    internal/cpu.s                                                           3298     3295     -3      -0.091%
    internal/testlog.s                                                       1507     1501     -6      -0.398%
    image/color.s                                                            8281     8248     -33     -0.399%
    runtime.s                                                                480970   480075   -895    -0.186%
    sync.s                                                                   16497    16408    -89     -0.539%
    internal/singleflight.s                                                  2591     2577     -14     -0.540%
    math/rand.s                                                              10456    10438    -18     -0.172%
    cmd/go/internal/par.s                                                    2801     2790     -11     -0.393%
    internal/reflectlite.s                                                   28477    28417    -60     -0.211%
    errors.s                                                                 2750     2736     -14     -0.509%
    internal/oserror.s                                                       446      434      -12     -2.691%
    sort.s                                                                   17061    17046    -15     -0.088%
    io.s                                                                     17063    16999    -64     -0.375%
    vendor/golang.org/x/crypto/hkdf.s                                        1962     1936     -26     -1.325%
    text/tabwriter.s                                                         9617     9574     -43     -0.447%
    hash/crc64.s                                                             3414     3408     -6      -0.176%
    hash/crc32.s                                                             6657     6651     -6      -0.090%
    bytes.s                                                                  31932    31863    -69     -0.216%
    strconv.s                                                                53158    52799    -359    -0.675%
    strings.s                                                                42829    42665    -164    -0.383%
    encoding/ascii85.s                                                       4833     4791     -42     -0.869%
    vendor/golang.org/x/text/transform.s                                     16810    16724    -86     -0.512%
    path.s                                                                   6848     6845     -3      -0.044%
    encoding/base32.s                                                        9658     9592     -66     -0.683%
    bufio.s                                                                  23051    22908    -143    -0.620%
    compress/bzip2.s                                                         11773    11764    -9      -0.076%
    image.s                                                                  37565    37502    -63     -0.168%
    syscall.s                                                                82359    82279    -80     -0.097%
    regexp/syntax.s                                                          83573    82930    -643    -0.769%
    image/jpeg.s                                                             36535    36490    -45     -0.123%
    regexp.s                                                                 64396    64214    -182    -0.283%
    time.s                                                                   82724    82622    -102    -0.123%
    plugin.s                                                                 6539     6536     -3      -0.046%
    context.s                                                                10959    10865    -94     -0.858%
    internal/poll.s                                                          24286    24270    -16     -0.066%
    reflect.s                                                                168304   167927   -377    -0.224%
    internal/fmtsort.s                                                       7416     7376     -40     -0.539%
    os.s                                                                     52465    51787    -678    -1.292%
    cmd/go/internal/lockedfile/internal/filelock.s                           2326     2317     -9      -0.387%
    os/signal.s                                                              4657     4648     -9      -0.193%
    runtime/debug.s                                                          6040     5998     -42     -0.695%
    encoding/binary.s                                                        30838    30801    -37     -0.120%
    vendor/golang.org/x/net/route.s                                          23694    23491    -203    -0.857%
    path/filepath.s                                                          17895    17889    -6      -0.034%
    cmd/vendor/golang.org/x/sys/unix.s                                       78125    78109    -16     -0.020%
    io/ioutil.s                                                              6999     6996     -3      -0.043%
    encoding/base64.s                                                        12094    12007    -87     -0.719%
    crypto/cipher.s                                                          20466    20372    -94     -0.459%
    cmd/go/internal/robustio.s                                               2672     2669     -3      -0.112%
    encoding/pem.s                                                           9302     9286     -16     -0.172%
    internal/obscuretestdata.s                                               1719     1695     -24     -1.396%
    crypto/aes.s                                                             11014    11002    -12     -0.109%
    os/exec.s                                                                29388    29231    -157    -0.534%
    cmd/internal/browser.s                                                   2266     2260     -6      -0.265%
    internal/goroot.s                                                        4601     4592     -9      -0.196%
    vendor/golang.org/x/crypto/chacha20poly1305.s                            8945     8942     -3      -0.034%
    cmd/vendor/golang.org/x/crypto/ssh/terminal.s                            27226    27195    -31     -0.114%
    index/suffixarray.s                                                      36431    36411    -20     -0.055%
    fmt.s                                                                    77017    76709    -308    -0.400%
    encoding/hex.s                                                           6241     6154     -87     -1.394%
    compress/lzw.s                                                           7133     7069     -64     -0.897%
    database/sql/driver.s                                                    18888    18877    -11     -0.058%
    net/url.s                                                                29838    29739    -99     -0.332%
    debug/plan9obj.s                                                         8329     8279     -50     -0.600%
    encoding/csv.s                                                           12986    12902    -84     -0.647%
    debug/gosym.s                                                            25403    25330    -73     -0.287%
    compress/flate.s                                                         51192    50970    -222    -0.434%
    vendor/golang.org/x/net/dns/dnsmessage.s                                 86769    86208    -561    -0.647%
    compress/gzip.s                                                          9791     9758     -33     -0.337%
    compress/zlib.s                                                          7310     7277     -33     -0.451%
    archive/zip.s                                                            42356    42166    -190    -0.449%
    debug/dwarf.s                                                            108259   107730   -529    -0.489%
    encoding/json.s                                                          106378   105910   -468    -0.440%
    os/user.s                                                                14751    14724    -27     -0.183%
    database/sql.s                                                           99011    98404    -607    -0.613%
    log.s                                                                    9466     9423     -43     -0.454%
    debug/pe.s                                                               31272    31182    -90     -0.288%
    debug/macho.s                                                            32764    32608    -156    -0.476%
    encoding/gob.s                                                           136976   136517   -459    -0.335%
    vendor/golang.org/x/text/unicode/bidi.s                                  27318    27276    -42     -0.154%
    archive/tar.s                                                            71416    70975    -441    -0.618%
    vendor/golang.org/x/net/http2/hpack.s                                    23892    23848    -44     -0.184%
    vendor/golang.org/x/text/secure/bidirule.s                               3354     3351     -3      -0.089%
    mime/quotedprintable.s                                                   5960     5925     -35     -0.587%
    net/http/internal.s                                                      5874     5853     -21     -0.358%
    math/big.s                                                               184147   183692   -455    -0.247%
    debug/elf.s                                                              63775    63567    -208    -0.326%
    mime.s                                                                   39802    39709    -93     -0.234%
    encoding/xml.s                                                           111038   110713   -325    -0.293%
    crypto/dsa.s                                                             6044     6029     -15     -0.248%
    go/token.s                                                               12139    12077    -62     -0.511%
    crypto/rand.s                                                            6889     6866     -23     -0.334%
    go/scanner.s                                                             19030    19008    -22     -0.116%
    flag.s                                                                   22320    22236    -84     -0.376%
    vendor/golang.org/x/text/unicode/norm.s                                  66652    66391    -261    -0.392%
    crypto/rsa.s                                                             31671    31650    -21     -0.066%
    crypto/elliptic.s                                                        51553    51403    -150    -0.291%
    internal/xcoff.s                                                         22950    22822    -128    -0.558%
    go/constant.s                                                            43750    43689    -61     -0.139%
    encoding/asn1.s                                                          57086    57035    -51     -0.089%
    runtime/trace.s                                                          2609     2603     -6      -0.230%
    crypto/x509/pkix.s                                                       10458    10471    +13     +0.124%
    image/gif.s                                                              27544    27385    -159    -0.577%
    vendor/golang.org/x/net/idna.s                                           24558    24502    -56     -0.228%
    image/png.s                                                              42775    42685    -90     -0.210%
    vendor/golang.org/x/crypto/cryptobyte.s                                  33616    33493    -123    -0.366%
    go/ast.s                                                                 80684    80449    -235    -0.291%
    net/internal/socktest.s                                                  16571    16535    -36     -0.217%
    crypto/ecdsa.s                                                           11948    11936    -12     -0.100%
    text/template/parse.s                                                    95138    94002    -1136   -1.194%
    runtime/pprof.s                                                          59702    59639    -63     -0.106%
    testing.s                                                                68427    68088    -339    -0.495%
    internal/testenv.s                                                       5620     5596     -24     -0.427%
    testing/internal/testdeps.s                                              3312     3294     -18     -0.543%
    internal/trace.s                                                         78473    78239    -234    -0.298%
    testing/iotest.s                                                         4968     4908     -60     -1.208%
    os/signal/internal/pty.s                                                 3011     2990     -21     -0.697%
    testing/quick.s                                                          12179    12125    -54     -0.443%
    cmd/internal/bio.s                                                       9286     9274     -12     -0.129%
    cmd/internal/src.s                                                       17684    17663    -21     -0.119%
    cmd/internal/goobj2.s                                                    12588    12558    -30     -0.238%
    cmd/internal/objabi.s                                                    16408    16390    -18     -0.110%
    go/printer.s                                                             77417    77308    -109    -0.141%
    go/parser.s                                                              80045    79113    -932    -1.164%
    go/format.s                                                              5434     5419     -15     -0.276%
    cmd/internal/goobj.s                                                     26146    25954    -192    -0.734%
    runtime/pprof/internal/profile.s                                         102518   102178   -340    -0.332%
    text/template.s                                                          95343    94935    -408    -0.428%
    cmd/internal/dwarf.s                                                     31718    31572    -146    -0.460%
    cmd/vendor/golang.org/x/arch/arm/armasm.s                                45240    45151    -89     -0.197%
    internal/lazytemplate.s                                                  1470     1457     -13     -0.884%
    cmd/vendor/golang.org/x/arch/ppc64/ppc64asm.s                            37253    37220    -33     -0.089%
    cmd/asm/internal/flags.s                                                 2593     2590     -3      -0.116%
    cmd/asm/internal/lex.s                                                   25068    24921    -147    -0.586%
    cmd/internal/buildid.s                                                   18536    18263    -273    -1.473%
    cmd/vendor/golang.org/x/arch/x86/x86asm.s                                80209    80105    -104    -0.130%
    go/doc.s                                                                 75140    74585    -555    -0.739%
    cmd/internal/edit.s                                                      3893     3899     +6      +0.154%
    html/template.s                                                          89377    88809    -568    -0.636%
    cmd/vendor/golang.org/x/arch/arm64/arm64asm.s                            117998   117824   -174    -0.147%
    cmd/internal/obj.s                                                       115015   114290   -725    -0.630%
    go/build.s                                                               69379    68862    -517    -0.745%
    cmd/internal/objfile.s                                                   48106    47982    -124    -0.258%
    cmd/cover.s                                                              46239    46113    -126    -0.272%
    cmd/addr2line.s                                                          2845     2833     -12     -0.422%
    cmd/internal/obj/arm.s                                                   68658    66855    -1803   -2.626%
    cmd/internal/obj/mips.s                                                  57486    56272    -1214   -2.112%
    cmd/internal/obj/riscv.s                                                 63834    63006    -828    -1.297%
    cmd/compile/internal/syntax.s                                            146582   145456   -1126   -0.768%
    cmd/internal/obj/wasm.s                                                  44117    44066    -51     -0.116%
    cmd/cgo.s                                                                242645   241653   -992    -0.409%
    cmd/internal/obj/arm64.s                                                 152107   147163   -4944   -3.250%
    net.s                                                                    295972   292010   -3962   -1.339%
    go/types.s                                                               321371   319432   -1939   -0.603%
    vendor/golang.org/x/net/http/httpproxy.s                                 9450     9423     -27     -0.286%
    net/textproto.s                                                          19455    19406    -49     -0.252%
    cmd/internal/obj/ppc64.s                                                 125544   120456   -5088   -4.053%
    go/internal/srcimporter.s                                                6475     6409     -66     -1.019%
    log/syslog.s                                                             8017     7929     -88     -1.098%
    cmd/compile/internal/logopt.s                                            10183    10162    -21     -0.206%
    net/mail.s                                                               24085    23948    -137    -0.569%
    mime/multipart.s                                                         21527    21420    -107    -0.497%
    cmd/internal/obj/s390x.s                                                 127610   127757   +147    +0.115%
    go/internal/gcimporter.s                                                 34913    34548    -365    -1.045%
    vendor/golang.org/x/net/nettest.s                                        28103    28016    -87     -0.310%
    cmd/go/internal/cfg.s                                                    9967     9916     -51     -0.512%
    cmd/api.s                                                                39703    39603    -100    -0.252%
    go/internal/gccgoimporter.s                                              56470    56120    -350    -0.620%
    go/importer.s                                                            2077     2056     -21     -1.011%
    cmd/compile/internal/types.s                                             48202    47282    -920    -1.909%
    cmd/go/internal/str.s                                                    4341     4320     -21     -0.484%
    cmd/internal/obj/x86.s                                                   89440    88625    -815    -0.911%
    cmd/go/internal/base.s                                                   12667    12580    -87     -0.687%
    cmd/go/internal/cache.s                                                  30754    30571    -183    -0.595%
    cmd/doc.s                                                                62976    62755    -221    -0.351%
    cmd/go/internal/search.s                                                 20114    19993    -121    -0.602%
    cmd/vendor/golang.org/x/xerrors.s                                        17923    17855    -68     -0.379%
    cmd/go/internal/lockedfile.s                                             16451    16415    -36     -0.219%
    cmd/vendor/golang.org/x/mod/sumdb/note.s                                 18200    18150    -50     -0.275%
    cmd/vendor/golang.org/x/mod/module.s                                     17869    17851    -18     -0.101%
    cmd/asm/internal/arch.s                                                  37533    37482    -51     -0.136%
    cmd/fix.s                                                                87728    87492    -236    -0.269%
    cmd/vendor/golang.org/x/mod/sumdb/tlog.s                                 36394    36367    -27     -0.074%
    cmd/vendor/golang.org/x/mod/sumdb/dirhash.s                              4990     4963     -27     -0.541%
    cmd/go/internal/imports.s                                                16499    16469    -30     -0.182%
    cmd/vendor/golang.org/x/mod/zip.s                                        18816    18745    -71     -0.377%
    cmd/go/internal/cmdflag.s                                                5126     5123     -3      -0.059%
    cmd/internal/test2json.s                                                 9540     9452     -88     -0.922%
    cmd/go/internal/tool.s                                                   3629     3623     -6      -0.165%
    cmd/go/internal/version.s                                                11232    11220    -12     -0.107%
    cmd/go/internal/mvs.s                                                    25383    25179    -204    -0.804%
    cmd/nm.s                                                                 5815     5803     -12     -0.206%
    cmd/dist.s                                                               210146   209140   -1006   -0.479%
    cmd/asm/internal/asm.s                                                   68655    68549    -106    -0.154%
    cmd/vendor/golang.org/x/mod/modfile.s                                    72974    72510    -464    -0.636%
    cmd/go/internal/load.s                                                   107548   106861   -687    -0.639%
    cmd/link/internal/sym.s                                                  18708    18581    -127    -0.679%
    cmd/asm.s                                                                3367     3343     -24     -0.713%
    cmd/gofmt.s                                                              30795    30698    -97     -0.315%
    cmd/link/internal/objfile.s                                              21828    21630    -198    -0.907%
    cmd/pack.s                                                               14878    14869    -9      -0.060%
    cmd/vendor/github.com/google/pprof/internal/elfexec.s                    6788     6782     -6      -0.088%
    cmd/test2json.s                                                          1647     1641     -6      -0.364%
    cmd/link/internal/loader.s                                               48677    48483    -194    -0.399%
    cmd/vendor/golang.org/x/tools/go/analysis/internal/analysisflags.s       16783    16773    -10     -0.060%
    cmd/link/internal/loadelf.s                                              35464    35126    -338    -0.953%
    cmd/link/internal/loadmacho.s                                            29438    29180    -258    -0.876%
    cmd/link/internal/loadpe.s                                               16440    16371    -69     -0.420%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/internal/analysisutil.s 2106     2100     -6      -0.285%
    cmd/link/internal/loadxcoff.s                                            11711    11615    -96     -0.820%
    cmd/vendor/golang.org/x/tools/go/analysis/internal/facts.s               14954    14883    -71     -0.475%
    cmd/vendor/golang.org/x/tools/go/ast/inspector.s                         5394     5374     -20     -0.371%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/asmdecl.s               37029    36822    -207    -0.559%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/inspect.s               340      337      -3      -0.882%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/cgocall.s               9919     9858     -61     -0.615%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/bools.s                 6705     6690     -15     -0.224%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/copylock.s              9783     9741     -42     -0.429%
    cmd/vendor/golang.org/x/tools/go/cfg.s                                   31699    30742    -957    -3.019%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/ifaceassert.s           2768     2762     -6      -0.217%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/loopclosure.s           3031     2998     -33     -1.089%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/shift.s                 4382     4376     -6      -0.137%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/stdmethods.s            8654     8642     -12     -0.139%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/stringintconv.s         3458     3446     -12     -0.347%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/structtag.s             8011     7995     -16     -0.200%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/tests.s                 6205     6193     -12     -0.193%
    cmd/vendor/golang.org/x/tools/go/ast/astutil.s                           66183    65861    -322    -0.487%
    cmd/vendor/github.com/google/pprof/profile.s                             150844   150261   -583    -0.386%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/unreachable.s           8057     8054     -3      -0.037%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/unusedresult.s          3670     3667     -3      -0.082%
    cmd/vendor/github.com/google/pprof/internal/measurement.s                10464    10440    -24     -0.229%
    cmd/vendor/golang.org/x/tools/go/types/typeutil.s                        12319    12274    -45     -0.365%
    cmd/vendor/golang.org/x/tools/go/analysis/unitchecker.s                  13503    13342    -161    -1.192%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/ctrlflow.s              5261     5218     -43     -0.817%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/errorsas.s              1462     1459     -3      -0.205%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/lostcancel.s            9594     9582     -12     -0.125%
    cmd/vendor/golang.org/x/tools/go/analysis/passes/printf.s                34397    34338    -59     -0.172%
    cmd/vendor/github.com/google/pprof/internal/graph.s                      53225    52936    -289    -0.543%
    cmd/vendor/github.com/ianlancetaylor/demangle.s                          177450   175329   -2121   -1.195%
    crypto/x509.s                                                            147892   147388   -504    -0.341%
    cmd/go/internal/work.s                                                   306465   304950   -1515   -0.494%
    cmd/go/internal/run.s                                                    4664     4657     -7      -0.150%
    crypto/tls.s                                                             313130   311833   -1297   -0.414%
    net/http/httptrace.s                                                     3979     3905     -74     -1.860%
    net/smtp.s                                                               14413    14344    -69     -0.479%
    cmd/link/internal/ld.s                                                   545343   542279   -3064   -0.562%
    cmd/link/internal/mips.s                                                 6218     6215     -3      -0.048%
    cmd/link/internal/mips64.s                                               6108     6103     -5      -0.082%
    cmd/link/internal/amd64.s                                                18154    18112    -42     -0.231%
    cmd/link/internal/arm64.s                                                22527    22494    -33     -0.146%
    cmd/link/internal/arm.s                                                  22574    22494    -80     -0.354%
    cmd/link/internal/s390x.s                                                20779    20746    -33     -0.159%
    cmd/link/internal/wasm.s                                                 16531    16493    -38     -0.230%
    cmd/link/internal/x86.s                                                  18906    18849    -57     -0.301%
    cmd/link/internal/ppc64.s                                                26856    26778    -78     -0.290%
    net/http.s                                                               559101   556513   -2588   -0.463%
    net/http/cookiejar.s                                                     15912    15885    -27     -0.170%
    expvar.s                                                                 9531     9525     -6      -0.063%
    net/http/httptest.s                                                      16616    16475    -141    -0.849%
    net/http/cgi.s                                                           23624    23458    -166    -0.703%
    cmd/go/internal/web.s                                                    16546    16489    -57     -0.344%
    cmd/vendor/golang.org/x/mod/sumdb.s                                      33197    33117    -80     -0.241%
    net/http/fcgi.s                                                          19266    19169    -97     -0.503%
    net/http/httputil.s                                                      39875    39728    -147    -0.369%
    cmd/vendor/github.com/google/pprof/internal/symbolz.s                    5888     5867     -21     -0.357%
    net/rpc.s                                                                34154    34003    -151    -0.442%
    cmd/vendor/github.com/google/pprof/internal/transport.s                  2746     2716     -30     -1.092%
    cmd/vendor/github.com/google/pprof/internal/binutils.s                   35999    35875    -124    -0.344%
    net/rpc/jsonrpc.s                                                        6637     6598     -39     -0.588%
    cmd/vendor/github.com/google/pprof/internal/symbolizer.s                 11533    11458    -75     -0.650%
    cmd/go/internal/get.s                                                    62921    62803    -118    -0.188%
    cmd/vendor/github.com/google/pprof/internal/report.s                     80364    80058    -306    -0.381%
    cmd/go/internal/modfetch/codehost.s                                      89680    89066    -614    -0.685%
    cmd/trace.s                                                              117171   116701   -470    -0.401%
    cmd/vendor/github.com/google/pprof/internal/driver.s                     144268   143297   -971    -0.673%
    cmd/go/internal/modfetch.s                                               126299   125860   -439    -0.348%
    cmd/vendor/github.com/google/pprof/driver.s                              9042     9000     -42     -0.464%
    cmd/go/internal/modconv.s                                                17947    17889    -58     -0.323%
    cmd/pprof.s                                                              12399    12326    -73     -0.589%
    cmd/go/internal/modload.s                                                151182   150389   -793    -0.525%
    cmd/go/internal/generate.s                                               11738    11636    -102    -0.869%
    cmd/go/internal/help.s                                                   6571     6531     -40     -0.609%
    cmd/go/internal/clean.s                                                  11174    11142    -32     -0.286%
    cmd/go/internal/vet.s                                                    7897     7867     -30     -0.380%
    cmd/go/internal/envcmd.s                                                 22176    22095    -81     -0.365%
    cmd/go/internal/list.s                                                   15216    15067    -149    -0.979%
    cmd/go/internal/modget.s                                                 38698    38519    -179    -0.463%
    cmd/go/internal/modcmd.s                                                 46674    46441    -233    -0.499%
    cmd/go/internal/test.s                                                   64664    64456    -208    -0.322%
    cmd/go.s                                                                 6730     6703     -27     -0.401%
    cmd/compile/internal/ssa.s                                               3592565  3582500  -10065  -0.280%
    cmd/compile/internal/gc.s                                                1549123  1537123  -12000  -0.775%
    cmd/compile/internal/riscv64.s                                           14579    14483    -96     -0.658%
    cmd/compile/internal/mips.s                                              20578    20419    -159    -0.773%
    cmd/compile/internal/ppc64.s                                             25524    25359    -165    -0.646%
    cmd/compile/internal/mips64.s                                            19795    19636    -159    -0.803%
    cmd/compile/internal/wasm.s                                              13329    13290    -39     -0.293%
    cmd/compile/internal/s390x.s                                             28097    27892    -205    -0.730%
    cmd/compile/internal/arm.s                                               31489    31321    -168    -0.534%
    cmd/compile/internal/arm64.s                                             29803    29590    -213    -0.715%
    cmd/compile/internal/amd64.s                                             32961    33221    +260    +0.789%
    cmd/compile/internal/x86.s                                               31029    30878    -151    -0.487%
    total                                                                    18534966 18440341 -94625  -0.511%
    
    Change-Id: I830d37364f14f0297800adc42c99f60a74c51aca
    Reviewed-on: https://go-review.googlesource.com/c/go/+/226367
    Run-TryBot: Josh Bleecher Snyder <josharian@gmail.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Keith Randall <khr@golang.org>
---
 src/cmd/compile/internal/amd64/ssa.go        |  3 +-
 src/cmd/compile/internal/gc/go.go            |  3 ++
 src/cmd/compile/internal/gc/ssa.go           | 15 +++++++++
 src/cmd/compile/internal/ssa/gen/AMD64Ops.go |  2 +-
 src/cmd/compile/internal/ssa/opGen.go        |  2 +-
 src/runtime/asm_amd64.s                      | 49 ++++++++++++++++++++++++++++
 src/runtime/stubs_amd64.go                   |  9 +++++
 test/codegen/structs.go                      |  2 +-
 8 files changed, 81 insertions(+), 4 deletions(-)

diff --git a/src/cmd/compile/internal/amd64/ssa.go b/src/cmd/compile/internal/amd64/ssa.go
index b6c1039d9e..5d79095025 100644
--- a/src/cmd/compile/internal/amd64/ssa.go
+++ b/src/cmd/compile/internal/amd64/ssa.go
@@ -947,7 +947,8 @@ func ssaGenValue(s *gc.SSAGenState, v *ssa.Value) {
 		p := s.Prog(obj.ACALL)
 		p.To.Type = obj.TYPE_MEM
 		p.To.Name = obj.NAME_EXTERN
-		p.To.Sym = v.Aux.(*obj.LSym)
+		// arg0 is in DI. Set sym to match where regalloc put arg1.
+		p.To.Sym = gc.GCWriteBarrierReg[v.Args[1].Reg()]
 
 	case ssa.OpAMD64LoweredPanicBoundsA, ssa.OpAMD64LoweredPanicBoundsB, ssa.OpAMD64LoweredPanicBoundsC:
 		p := s.Prog(obj.ACALL)
diff --git a/src/cmd/compile/internal/gc/go.go b/src/cmd/compile/internal/gc/go.go
index 85c857c214..d2a1b21cbd 100644
--- a/src/cmd/compile/internal/gc/go.go
+++ b/src/cmd/compile/internal/gc/go.go
@@ -334,3 +334,6 @@ var (
 	WasmTruncU,
 	SigPanic *obj.LSym
 )
+
+// GCWriteBarrierReg maps from registers to gcWriteBarrier implementation LSyms.
+var GCWriteBarrierReg map[int16]*obj.LSym
diff --git a/src/cmd/compile/internal/gc/ssa.go b/src/cmd/compile/internal/gc/ssa.go
index b7dc511fd3..00587aa3bf 100644
--- a/src/cmd/compile/internal/gc/ssa.go
+++ b/src/cmd/compile/internal/gc/ssa.go
@@ -16,6 +16,7 @@ import (
 	"cmd/compile/internal/ssa"
 	"cmd/compile/internal/types"
 	"cmd/internal/obj"
+	"cmd/internal/obj/x86"
 	"cmd/internal/objabi"
 	"cmd/internal/src"
 	"cmd/internal/sys"
@@ -104,6 +105,20 @@ func initssaconfig() {
 	writeBarrier = sysvar("writeBarrier") // struct { bool; ... }
 	zerobaseSym = sysvar("zerobase")
 
+	// asm funcs with special ABI
+	if thearch.LinkArch.Name == "amd64" {
+		GCWriteBarrierReg = map[int16]*obj.LSym{
+			x86.REG_AX: sysvar("gcWriteBarrier"),
+			x86.REG_CX: sysvar("gcWriteBarrierCX"),
+			x86.REG_DX: sysvar("gcWriteBarrierDX"),
+			x86.REG_BX: sysvar("gcWriteBarrierBX"),
+			x86.REG_BP: sysvar("gcWriteBarrierBP"),
+			x86.REG_SI: sysvar("gcWriteBarrierSI"),
+			x86.REG_R8: sysvar("gcWriteBarrierR8"),
+			x86.REG_R9: sysvar("gcWriteBarrierR9"),
+		}
+	}
+
 	if thearch.LinkArch.Family == sys.Wasm {
 		BoundsCheckFunc[ssa.BoundsIndex] = sysvar("goPanicIndex")
 		BoundsCheckFunc[ssa.BoundsIndexU] = sysvar("goPanicIndexU")
diff --git a/src/cmd/compile/internal/ssa/gen/AMD64Ops.go b/src/cmd/compile/internal/ssa/gen/AMD64Ops.go
index 08aa65b0a8..74cdf0283b 100644
--- a/src/cmd/compile/internal/ssa/gen/AMD64Ops.go
+++ b/src/cmd/compile/internal/ssa/gen/AMD64Ops.go
@@ -717,7 +717,7 @@ func init() {
 		{name: "LoweredNilCheck", argLength: 2, reg: regInfo{inputs: []regMask{gpsp}}, clobberFlags: true, nilCheck: true, faultOnNilArg0: true},
 		// LoweredWB invokes runtime.gcWriteBarrier. arg0=destptr, arg1=srcptr, arg2=mem, aux=runtime.gcWriteBarrier
 		// It saves all GP registers if necessary, but may clobber others.
-		{name: "LoweredWB", argLength: 3, reg: regInfo{inputs: []regMask{buildReg("DI"), ax}, clobbers: callerSave &^ gp}, clobberFlags: true, aux: "Sym", symEffect: "None"},
+		{name: "LoweredWB", argLength: 3, reg: regInfo{inputs: []regMask{buildReg("DI"), buildReg("AX CX DX BX BP SI R8 R9")}, clobbers: callerSave &^ gp}, clobberFlags: true, aux: "Sym", symEffect: "None"},
 
 		// There are three of these functions so that they can have three different register inputs.
 		// When we check 0 <= c <= cap (A), then 0 <= b <= c (B), then 0 <= a <= b (C), we want the
diff --git a/src/cmd/compile/internal/ssa/opGen.go b/src/cmd/compile/internal/ssa/opGen.go
index e2b83e20b3..5e91856e48 100644
--- a/src/cmd/compile/internal/ssa/opGen.go
+++ b/src/cmd/compile/internal/ssa/opGen.go
@@ -11420,7 +11420,7 @@ var opcodeTable = [...]opInfo{
 		reg: regInfo{
 			inputs: []inputInfo{
 				{0, 128}, // DI
-				{1, 1},   // AX
+				{1, 879}, // AX CX DX BX BP SI R8 R9
 			},
 			clobbers: 4294901760, // X0 X1 X2 X3 X4 X5 X6 X7 X8 X9 X10 X11 X12 X13 X14 X15
 		},
diff --git a/src/runtime/asm_amd64.s b/src/runtime/asm_amd64.s
index b872b8834d..ed7cec7233 100644
--- a/src/runtime/asm_amd64.s
+++ b/src/runtime/asm_amd64.s
@@ -1475,6 +1475,55 @@ flush:
 	MOVQ	96(SP), R15
 	JMP	ret
 
+// gcWriteBarrierCX is gcWriteBarrier, but with args in DI and CX.
+TEXT runtime·gcWriteBarrierCX(SB),NOSPLIT,$0
+	XCHGQ CX, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ CX, AX
+	RET
+
+// gcWriteBarrierDX is gcWriteBarrier, but with args in DI and DX.
+TEXT runtime·gcWriteBarrierDX(SB),NOSPLIT,$0
+	XCHGQ DX, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ DX, AX
+	RET
+
+// gcWriteBarrierBX is gcWriteBarrier, but with args in DI and BX.
+TEXT runtime·gcWriteBarrierBX(SB),NOSPLIT,$0
+	XCHGQ BX, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ BX, AX
+	RET
+
+// gcWriteBarrierBP is gcWriteBarrier, but with args in DI and BP.
+TEXT runtime·gcWriteBarrierBP(SB),NOSPLIT,$0
+	XCHGQ BP, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ BP, AX
+	RET
+
+// gcWriteBarrierSI is gcWriteBarrier, but with args in DI and SI.
+TEXT runtime·gcWriteBarrierSI(SB),NOSPLIT,$0
+	XCHGQ SI, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ SI, AX
+	RET
+
+// gcWriteBarrierR8 is gcWriteBarrier, but with args in DI and R8.
+TEXT runtime·gcWriteBarrierR8(SB),NOSPLIT,$0
+	XCHGQ R8, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ R8, AX
+	RET
+
+// gcWriteBarrierR9 is gcWriteBarrier, but with args in DI and R9.
+TEXT runtime·gcWriteBarrierR9(SB),NOSPLIT,$0
+	XCHGQ R9, AX
+	CALL runtime·gcWriteBarrier(SB)
+	XCHGQ R9, AX
+	RET
+
 DATA	debugCallFrameTooLarge<>+0x00(SB)/20, $"call frame too large"
 GLOBL	debugCallFrameTooLarge<>(SB), RODATA, $20	// Size duplicated below
 
diff --git a/src/runtime/stubs_amd64.go b/src/runtime/stubs_amd64.go
index 5b79d66762..8c14bc2271 100644
--- a/src/runtime/stubs_amd64.go
+++ b/src/runtime/stubs_amd64.go
@@ -4,6 +4,15 @@
 
 package runtime
 
+// Called from compiled code; declared for vet; do NOT call from Go.
+func gcWriteBarrierCX()
+func gcWriteBarrierDX()
+func gcWriteBarrierBX()
+func gcWriteBarrierBP()
+func gcWriteBarrierSI()
+func gcWriteBarrierR8()
+func gcWriteBarrierR9()
+
 // stackcheck checks that SP is in range [g->stack.lo, g->stack.hi).
 func stackcheck()
 
diff --git a/test/codegen/structs.go b/test/codegen/structs.go
index b81ad67c44..9eddc5b16e 100644
--- a/test/codegen/structs.go
+++ b/test/codegen/structs.go
@@ -28,7 +28,7 @@ type Z2 struct {
 
 func Zero2(t *Z2) {
 	// amd64:`XORPS\tX., X`,`MOVUPS\tX., \(.*\)`,`MOVQ\t\$0, 16\(.*\)`
-	// amd64:`.*runtime[.]gcWriteBarrier\(SB\)`
+	// amd64:`.*runtime[.]gcWriteBarrier.*\(SB\)`
 	*t = Z2{}
 }
 
