commit 8c5917cd76905b1ab16d41eadc8786e190eeecce
Author: Matthew Dempsky <mdempsky@google.com>
Date:   Fri Apr 29 10:47:57 2022 -0700

    cmd/compile: consistent unified IR handling of package unsafe
    
    Within the unified IR export format, I was treating package unsafe as
    a normal package, but expecting importers to correctly handle
    deduplicating it against their respective representation of package
    unsafe.
    
    However, the surrounding importer logic differs slightly between
    cmd/compile/internal/noder (which unified IR was originally
    implemented against) and go/importer (which it was more recently
    ported to). In particular, noder initializes its packages map as
    `map[string]*types2.Package{"unsafe": types2.Unsafe}`, whereas
    go/importer initializes it as just `make(map[string]*types.Package)`.
    
    This CL makes them all consistent. In particular, it:
    
    1. changes noder to initialize packages to an empty map to prevent
    further latent issues from the discrepency,
    
    2. adds the same special handling of package unsafe already present in
    go/internal/gcimporter's unified IR reader to both of cmd/compile's
    implementations, and
    
    3. changes the unified IR writer to treat package unsafe as a builtin
    package, to force that readers similarly handle it correctly.
    
    Fixes #52623.
    
    Change-Id: Ibbab9b0a1d2a52d4cc91b56c5df49deedf81295a
    Reviewed-on: https://go-review.googlesource.com/c/go/+/403196
    Auto-Submit: Matthew Dempsky <mdempsky@google.com>
    Run-TryBot: Matthew Dempsky <mdempsky@google.com>
    Reviewed-by: Russ Cox <rsc@golang.org>
    TryBot-Result: Gopher Robot <gobot@golang.org>

 src/cmd/compile/internal/importer/ureader.go | 12 +++++++-----
 src/cmd/compile/internal/noder/irgen.go      |  2 +-
 src/cmd/compile/internal/noder/reader.go     | 10 ++++++----
 src/cmd/compile/internal/noder/writer.go     | 14 +++++++++++---
 src/go/internal/gcimporter/ureader.go        | 11 +++++------
 5 files changed, 30 insertions(+), 19 deletions(-)
