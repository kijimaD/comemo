commit 41b1f88efab9d263408448bf139659119002ea50
Author: Filippo Valsorda <filippo@golang.org>
Date:   Thu Sep 12 12:37:36 2019 -0400

    net/textproto: don't normalize headers with spaces before the colon
    
    RFC 7230 is clear about headers with a space before the colon, like
    
    X-Answer : 42
    
    being invalid, but we've been accepting and normalizing them for compatibility
    purposes since CL 5690059 in 2012.
    
    On the client side, this is harmless and indeed most browsers behave the same
    to this day. On the server side, this becomes a security issue when the
    behavior doesn't match that of a reverse proxy sitting in front of the server.
    
    For example, if a WAF accepts them without normalizing them, it might be
    possible to bypass its filters, because the Go server would interpret the
    header differently. Worse, if the reverse proxy coalesces requests onto a
    single HTTP/1.1 connection to a Go server, the understanding of the request
    boundaries can get out of sync between them, allowing an attacker to tack an
    arbitrary method and path onto a request by other clients, including
    authentication headers unknown to the attacker.
    
    This was recently presented at multiple security conferences:
    https://portswigger.net/blog/http-desync-attacks-request-smuggling-reborn
    
    net/http servers already reject header keys with invalid characters.
    Simply stop normalizing extra spaces in net/textproto, let it return them
    unchanged like it does for other invalid headers, and let net/http enforce
    RFC 7230, which is HTTP specific. This loses us normalization on the client
    side, but there's no right answer on the client side anyway, and hiding the
    issue sounds worse than letting the application decide.
    
    Fixes CVE-2019-16276
    Fixes #34540
    
    Change-Id: I6d272de827e0870da85d93df770d6a0e161bbcf1
    Reviewed-on: https://team-review.git.corp.google.com/c/golang/go-private/+/549719
    Reviewed-by: Brad Fitzpatrick <bradfitz@google.com>
    Reviewed-on: https://go-review.googlesource.com/c/go/+/197503
    Run-TryBot: Filippo Valsorda <filippo@golang.org>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Dmitri Shuralyov <dmitshur@golang.org>

 src/net/http/serve_test.go       |  4 ++++
 src/net/http/transport_test.go   | 27 +++++++++++++++++++++++++++
 src/net/textproto/reader.go      | 10 ++--------
 src/net/textproto/reader_test.go | 13 ++++++-------
 4 files changed, 39 insertions(+), 15 deletions(-)
