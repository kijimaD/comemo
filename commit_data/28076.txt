commit 23aeb34df172b17b7bfaa85fb59ca64bef9073bb
Merge: 1354b32cd7 d3c79d324a
Author: Rick Hudson <rlh@golang.org>
Date:   Wed Apr 27 18:19:16 2016 -0400

    [dev.garbage] Merge remote-tracking branch 'origin/master' into HEAD
    
    Change-Id: I282fd9ce9db435dfd35e882a9502ab1abc185297

 .gitignore                                         |    1 -
 CONTRIBUTORS                                       |    2 +-
 api/next.txt                                       |  184 +
 doc/contribute.html                                |    4 +
 doc/devel/release.html                             |   23 +
 doc/go1.6.html                                     |    2 +-
 doc/go1.7.txt                                      |    2 +
 doc/go_faq.html                                    |    5 +-
 doc/go_spec.html                                   |   12 +-
 doc/install-source.html                            |   15 +-
 misc/cgo/test/cgo_linux_test.go                    |    9 +-
 misc/cgo/test/cgo_unix_test.go                     |    1 +
 .../test/{sigprocmask_linux.c => sigprocmask.c}    |    2 +
 .../test/{sigprocmask_linux.go => sigprocmask.go}  |    4 +-
 misc/cgo/testcarchive/carchive_test.go             |    8 +-
 misc/cgo/testshared/shared_test.go                 |   10 +-
 misc/nacl/testzip.proto                            |    4 +
 misc/trace/README.md                               |   12 +-
 misc/trace/trace_viewer_lean.html                  | 8773 ++++++++++++++------
 src/archive/tar/reader.go                          |   23 +-
 src/archive/tar/writer.go                          |    2 +-
 src/archive/zip/reader.go                          |    2 +-
 src/bufio/bufio.go                                 |    2 +-
 src/bytes/bytes.go                                 |   10 +
 src/bytes/bytes_test.go                            |   51 +
 src/bytes/reader.go                                |    5 +-
 src/bytes/reader_test.go                           |   41 +-
 src/cmd/api/goapi.go                               |    5 +
 src/cmd/asm/internal/asm/asm.go                    |   53 +-
 src/cmd/asm/internal/asm/endtoend_test.go          |    5 +-
 src/cmd/asm/internal/asm/parse.go                  |   16 +-
 src/cmd/asm/internal/asm/testdata/s390x.s          |    4 +
 src/cmd/asm/main.go                                |   31 +-
 src/cmd/cgo/ast.go                                 |   10 +-
 src/cmd/cgo/gcc.go                                 |    2 +-
 src/cmd/cgo/main.go                                |    2 +-
 src/cmd/cgo/out.go                                 |    2 +-
 src/cmd/compile/internal/amd64/galign.go           |   12 +-
 src/cmd/compile/internal/amd64/gsubr.go            |    2 +-
 src/cmd/compile/internal/amd64/ssa.go              |  261 +-
 src/cmd/compile/internal/arm/cgen64.go             |    6 +-
 src/cmd/compile/internal/arm/galign.go             |    7 +-
 src/cmd/compile/internal/arm/gsubr.go              |    4 +-
 src/cmd/compile/internal/arm/ssa.go                |    8 +-
 src/cmd/compile/internal/arm64/galign.go           |    9 +-
 src/cmd/compile/internal/arm64/ggen.go             |   47 +
 src/cmd/compile/internal/arm64/gsubr.go            |   18 +-
 src/cmd/compile/internal/arm64/peep.go             |    3 +
 src/cmd/compile/internal/arm64/prog.go             |    3 +
 src/cmd/compile/internal/gc/alg.go                 |   20 +-
 src/cmd/compile/internal/gc/align.go               |   54 +-
 src/cmd/compile/internal/gc/bexport.go             |  301 +-
 src/cmd/compile/internal/gc/bimport.go             |  363 +-
 src/cmd/compile/internal/gc/builtin.go             |  231 +-
 src/cmd/compile/internal/gc/builtin/runtime.go     |    2 +
 src/cmd/compile/internal/gc/cgen.go                |  239 +-
 src/cmd/compile/internal/gc/closure.go             |    4 +-
 src/cmd/compile/internal/gc/const.go               |  179 +-
 src/cmd/compile/internal/gc/cplx.go                |    9 +-
 src/cmd/compile/internal/gc/dcl.go                 |  107 +-
 src/cmd/compile/internal/gc/esc.go                 |   30 +-
 src/cmd/compile/internal/gc/export.go              |   32 +-
 src/cmd/compile/internal/gc/fmt.go                 |  190 +-
 src/cmd/compile/internal/gc/gen.go                 |   20 +-
 src/cmd/compile/internal/gc/go.go                  |  219 +-
 src/cmd/compile/internal/gc/gsubr.go               |   51 +-
 src/cmd/compile/internal/gc/init.go                |    2 -
 src/cmd/compile/internal/gc/inl.go                 |   60 +-
 src/cmd/compile/internal/gc/lex.go                 |  238 +-
 src/cmd/compile/internal/gc/lex_test.go            |   79 +
 src/cmd/compile/internal/gc/main.go                |  151 +-
 src/cmd/compile/internal/gc/obj.go                 |   79 +-
 src/cmd/compile/internal/gc/opnames.go             |    8 +-
 src/cmd/compile/internal/gc/order.go               |   46 +-
 src/cmd/compile/internal/gc/parser.go              |   39 +-
 src/cmd/compile/internal/gc/pgen.go                |   18 +-
 src/cmd/compile/internal/gc/pgen_test.go           |   20 +-
 src/cmd/compile/internal/gc/plive.go               |   24 +-
 src/cmd/compile/internal/gc/popt.go                |   28 +
 src/cmd/compile/internal/gc/racewalk.go            |   30 +-
 src/cmd/compile/internal/gc/range.go               |   18 +-
 src/cmd/compile/internal/gc/reflect.go             |  490 +-
 src/cmd/compile/internal/gc/reg.go                 |   17 +-
 src/cmd/compile/internal/gc/select.go              |    8 +-
 src/cmd/compile/internal/gc/sinit.go               |  111 +-
 src/cmd/compile/internal/gc/sizeof_test.go         |   15 +-
 src/cmd/compile/internal/gc/ssa.go                 |  377 +-
 src/cmd/compile/internal/gc/ssa_test.go            |    4 +
 src/cmd/compile/internal/gc/subr.go                |  134 +-
 src/cmd/compile/internal/gc/swt.go                 |    2 +-
 src/cmd/compile/internal/gc/syntax.go              |    1 +
 src/cmd/compile/internal/gc/testdata/dupLoad.go    |   83 +
 .../compile/internal/gc/testdata/namedReturn.go    |  105 +
 src/cmd/compile/internal/gc/type.go                |  520 +-
 src/cmd/compile/internal/gc/typecheck.go           |  309 +-
 src/cmd/compile/internal/gc/universe.go            |   13 +-
 src/cmd/compile/internal/gc/unsafe.go              |    4 +-
 src/cmd/compile/internal/gc/walk.go                |  193 +-
 src/cmd/compile/internal/mips64/galign.go          |   10 +-
 src/cmd/compile/internal/mips64/gsubr.go           |    6 +-
 src/cmd/compile/internal/ppc64/galign.go           |   13 +-
 src/cmd/compile/internal/ppc64/gsubr.go            |    6 +-
 src/cmd/compile/internal/ppc64/reg.go              |    2 +-
 src/cmd/compile/internal/s390x/cgen.go             |  178 +
 src/cmd/compile/internal/s390x/galign.go           |   66 +
 src/cmd/compile/internal/s390x/ggen.go             |  577 ++
 src/cmd/compile/internal/s390x/gsubr.go            | 1115 +++
 src/cmd/compile/internal/s390x/peep.go             | 1664 ++++
 src/cmd/compile/internal/s390x/prog.go             |  179 +
 src/cmd/compile/internal/s390x/reg.go              |  130 +
 src/cmd/compile/internal/ssa/TODO                  |    2 -
 src/cmd/compile/internal/ssa/check.go              |   20 +-
 src/cmd/compile/internal/ssa/compile.go            |   13 +-
 src/cmd/compile/internal/ssa/config.go             |    7 +
 src/cmd/compile/internal/ssa/cse.go                |   60 +-
 src/cmd/compile/internal/ssa/cse_test.go           |    1 +
 src/cmd/compile/internal/ssa/decompose.go          |   29 +-
 src/cmd/compile/internal/ssa/dom.go                |  294 +-
 src/cmd/compile/internal/ssa/dom_test.go           |  208 +-
 src/cmd/compile/internal/ssa/export_test.go        |    3 +
 src/cmd/compile/internal/ssa/func.go               |   15 +-
 src/cmd/compile/internal/ssa/gen/AMD64.rules       |  781 +-
 src/cmd/compile/internal/ssa/gen/AMD64Ops.go       |   56 +-
 src/cmd/compile/internal/ssa/gen/ARMOps.go         |    6 +-
 src/cmd/compile/internal/ssa/gen/generic.rules     |   71 +-
 src/cmd/compile/internal/ssa/gen/genericOps.go     |    9 +-
 src/cmd/compile/internal/ssa/gen/main.go           |    8 +-
 src/cmd/compile/internal/ssa/gen/rulegen.go        |  127 +-
 src/cmd/compile/internal/ssa/id.go                 |    2 +-
 src/cmd/compile/internal/ssa/likelyadjust.go       |  142 +-
 src/cmd/compile/internal/ssa/loopbce.go            |   57 +-
 src/cmd/compile/internal/ssa/nilcheck.go           |    4 +-
 src/cmd/compile/internal/ssa/nilcheck_test.go      |   12 +-
 src/cmd/compile/internal/ssa/op.go                 |    5 +-
 src/cmd/compile/internal/ssa/opGen.go              |  839 +-
 src/cmd/compile/internal/ssa/phielim.go            |    6 +-
 src/cmd/compile/internal/ssa/phiopt.go             |   70 +-
 src/cmd/compile/internal/ssa/prove.go              |    9 +-
 src/cmd/compile/internal/ssa/regalloc.go           |  843 +-
 src/cmd/compile/internal/ssa/regalloc_test.go      |    4 +-
 src/cmd/compile/internal/ssa/rewrite.go            |   70 +-
 src/cmd/compile/internal/ssa/rewriteAMD64.go       | 4477 +++++-----
 src/cmd/compile/internal/ssa/rewritegeneric.go     | 1148 ++-
 src/cmd/compile/internal/ssa/sparsemap.go          |   16 +
 src/cmd/compile/internal/ssa/sparsetree.go         |   12 +
 src/cmd/compile/internal/ssa/stackalloc.go         |   25 +-
 src/cmd/compile/internal/ssa/type.go               |   67 +-
 src/cmd/compile/internal/ssa/type_test.go          |   49 +-
 src/cmd/compile/internal/ssa/value.go              |    1 +
 src/cmd/compile/internal/x86/cgen64.go             |    6 +-
 src/cmd/compile/internal/x86/galign.go             |    7 +-
 src/cmd/compile/internal/x86/ggen.go               |    2 +-
 src/cmd/compile/internal/x86/gsubr.go              |    6 +-
 src/cmd/compile/internal/x86/reg.go                |    2 +-
 src/cmd/compile/main.go                            |    3 +
 src/cmd/dist/buildgo.go                            |   16 +-
 src/cmd/dist/buildtool.go                          |    3 +
 src/cmd/dist/test.go                               |    4 +-
 src/cmd/doc/pkg.go                                 |   34 +-
 src/cmd/go/alldocs.go                              |   14 +-
 src/cmd/go/build.go                                |  114 +-
 src/cmd/go/get.go                                  |    8 +-
 src/cmd/go/go_test.go                              |  125 +-
 src/cmd/go/http.go                                 |    2 +-
 src/cmd/go/list.go                                 |    1 +
 src/cmd/go/pkg.go                                  |   66 +-
 src/cmd/go/test.go                                 |   16 +-
 src/cmd/go/vcs.go                                  |   17 +-
 src/cmd/go/vcs_test.go                             |   35 +
 src/cmd/go/vendor_test.go                          |   26 +
 src/cmd/gofmt/simplify.go                          |   28 +-
 src/cmd/gofmt/testdata/slices2.golden              |   63 -
 src/cmd/gofmt/testdata/slices2.input               |   63 -
 src/cmd/internal/bio/buf.go                        |   99 +
 src/cmd/internal/bio/must.go                       |   43 +
 src/cmd/internal/goobj/read.go                     |    7 +-
 src/cmd/internal/obj/arm/asm5.go                   |    8 +-
 src/cmd/internal/obj/arm/obj5.go                   |   15 +-
 src/cmd/internal/obj/arm64/asm7.go                 |    8 +-
 src/cmd/internal/obj/arm64/list7.go                |    2 +-
 src/cmd/internal/obj/arm64/obj7.go                 |   19 +-
 src/cmd/internal/obj/data.go                       |   38 +-
 src/cmd/internal/obj/link.go                       |   78 +-
 src/cmd/internal/obj/mips/asm0.go                  |    8 +-
 src/cmd/internal/obj/mips/obj0.go                  |   22 +-
 src/cmd/internal/obj/objfile.go                    |  204 +-
 src/cmd/internal/obj/pcln.go                       |   23 +-
 src/cmd/internal/obj/plist.go                      |  218 +
 src/cmd/internal/obj/ppc64/asm9.go                 |   24 +-
 src/cmd/internal/obj/ppc64/obj9.go                 |   26 +-
 src/cmd/internal/obj/s390x/a.out.go                |    1 +
 src/cmd/internal/obj/s390x/anames.go               |    1 +
 src/cmd/internal/obj/s390x/asmz.go                 |   38 +-
 src/cmd/internal/obj/s390x/objz.go                 |   15 +-
 src/cmd/internal/obj/sym.go                        |    3 +-
 src/cmd/internal/obj/util.go                       |  142 +-
 src/cmd/internal/obj/x86/a.out.go                  |    2 +
 src/cmd/internal/obj/x86/anames.go                 |    1 +
 src/cmd/internal/obj/x86/asm6.go                   |   49 +-
 src/cmd/internal/obj/x86/obj6.go                   |   59 +-
 src/cmd/internal/obj/x86/obj6_test.go              |    1 -
 src/cmd/internal/objfile/pe.go                     |    2 -
 src/cmd/internal/objfile/plan9obj.go               |    2 +-
 .../pprof}/commands/commands.go                    |    8 +-
 .../internal => internal/pprof}/driver/driver.go   |   10 +-
 .../pprof}/driver/interactive.go                   |    6 +-
 .../internal => internal/pprof}/fetch/fetch.go     |    4 +-
 .../internal => internal/pprof}/plugin/plugin.go   |    2 +-
 .../internal => internal/pprof}/profile/encode.go  |    0
 .../internal => internal/pprof}/profile/filter.go  |    0
 .../pprof}/profile/legacy_profile.go               |   51 +-
 .../internal => internal/pprof}/profile/profile.go |    0
 .../pprof}/profile/profile_test.go                 |    0
 .../internal => internal/pprof}/profile/proto.go   |    0
 .../pprof}/profile/proto_test.go                   |    0
 .../internal => internal/pprof}/profile/prune.go   |    0
 .../internal => internal/pprof}/report/report.go   |    4 +-
 .../internal => internal/pprof}/report/source.go   |    4 +-
 .../pprof}/report/source_html.go                   |    0
 .../{pprof/internal => internal/pprof}/svg/svg.go  |    0
 .../internal => internal/pprof}/svg/svgpan.go      |    0
 .../pprof}/symbolizer/symbolizer.go                |    4 +-
 .../internal => internal/pprof}/symbolz/symbolz.go |    2 +-
 .../pprof}/tempfile/tempfile.go                    |    0
 src/cmd/internal/sys/arch.go                       |  148 +
 .../golang.org/x/arch/arm/armasm/decode.go         |    8 +-
 .../golang.org/x/arch/x86/x86asm/decode.go         |    2 +-
 src/cmd/link/internal/amd64/asm.go                 |   55 +-
 src/cmd/link/internal/amd64/l.go                   |    5 -
 src/cmd/link/internal/amd64/obj.go                 |   11 +-
 src/cmd/link/internal/amd64/z.go                   |    1 -
 src/cmd/link/internal/arm/asm.go                   |   77 +-
 src/cmd/link/internal/arm/l.go                     |    2 -
 src/cmd/link/internal/arm/obj.go                   |    9 +-
 src/cmd/link/internal/arm64/asm.go                 |   48 +-
 src/cmd/link/internal/arm64/l.go                   |    2 -
 src/cmd/link/internal/arm64/obj.go                 |    9 +-
 src/cmd/link/internal/ld/ar.go                     |   23 +-
 src/cmd/link/internal/ld/arch.go                   |   97 -
 src/cmd/link/internal/ld/data.go                   | 1032 ++-
 src/cmd/link/internal/ld/deadcode.go               |   63 +-
 src/cmd/link/internal/ld/decodesym.go              |  126 +-
 src/cmd/link/internal/ld/dwarf.go                  | 1596 ++--
 src/cmd/link/internal/ld/elf.go                    |  146 +-
 src/cmd/link/internal/ld/go.go                     |   36 +-
 src/cmd/link/internal/ld/ldelf.go                  |  220 +-
 src/cmd/link/internal/ld/ldmacho.go                |   85 +-
 src/cmd/link/internal/ld/ldpe.go                   |   46 +-
 src/cmd/link/internal/ld/lib.go                    |  302 +-
 src/cmd/link/internal/ld/link.go                   |   45 +-
 src/cmd/link/internal/ld/macho.go                  |  126 +-
 src/cmd/link/internal/ld/macho_combine_dwarf.go    |    4 +-
 src/cmd/link/internal/ld/objfile.go                |   74 +-
 src/cmd/link/internal/ld/pcln.go                   |  146 +-
 src/cmd/link/internal/ld/pe.go                     |   51 +-
 src/cmd/link/internal/ld/pobj.go                   |   26 +-
 src/cmd/link/internal/ld/sym.go                    |   33 +-
 src/cmd/link/internal/ld/symtab.go                 |  121 +-
 src/cmd/link/internal/mips64/asm.go                |   39 +-
 src/cmd/link/internal/mips64/l.go                  |    2 -
 src/cmd/link/internal/mips64/obj.go                |   15 +-
 src/cmd/link/internal/ppc64/asm.go                 |   69 +-
 src/cmd/link/internal/ppc64/l.go                   |    2 -
 src/cmd/link/internal/ppc64/obj.go                 |   17 +-
 src/cmd/link/internal/s390x/asm.go                 |   27 +-
 src/cmd/link/internal/s390x/l.go                   |    5 -
 src/cmd/link/internal/s390x/obj.go                 |    9 +-
 src/cmd/link/internal/x86/asm.go                   |   58 +-
 src/cmd/link/internal/x86/l.go                     |    3 -
 src/cmd/link/internal/x86/obj.go                   |    9 +-
 src/cmd/link/link_test.go                          |   30 +
 src/cmd/link/main.go                               |    3 +
 src/cmd/objdump/objdump_test.go                    |    4 +
 src/cmd/pprof/pprof.go                             |   14 +-
 src/cmd/trace/main.go                              |    7 +-
 src/cmd/trace/pprof.go                             |   78 +-
 src/cmd/trace/trace.go                             |   91 +-
 src/cmd/vet/asmdecl.go                             |    5 +
 src/cmd/vet/atomic.go                              |    3 +
 src/cmd/vet/composite.go                           |    6 +-
 src/cmd/vet/doc.go                                 |   20 +-
 src/cmd/vet/internal/whitelist/whitelist.go        |    3 +-
 src/cmd/vet/main.go                                |    3 +-
 src/cmd/vet/print.go                               |  104 +-
 src/cmd/vet/structtag.go                           |    2 +-
 src/cmd/vet/testdata/asm.go                        |    2 +
 src/cmd/vet/testdata/asm1.s                        |   11 +
 src/cmd/vet/testdata/atomic.go                     |    9 +
 src/cmd/vet/testdata/composite.go                  |    8 +-
 src/cmd/vet/testdata/print.go                      |   38 +-
 src/cmd/vet/types.go                               |   66 -
 src/cmp.bash                                       |   61 +
 src/compress/bzip2/bzip2.go                        |    8 +-
 src/compress/flate/deflate.go                      |   37 +-
 src/compress/flate/huffman_bit_writer.go           |  174 +-
 src/compress/flate/huffman_code.go                 |   10 +-
 src/compress/flate/reverse_bits.go                 |    2 +-
 .../flate/testdata/huffman-rand-1k.dyn.expect      |  Bin 1054 -> 1005 bytes
 src/compress/flate/writer_test.go                  |   12 +-
 src/compress/gzip/gunzip.go                        |  121 +-
 src/compress/gzip/gunzip_test.go                   |   47 +
 src/compress/gzip/gzip.go                          |   21 +-
 src/compress/lzw/writer.go                         |    2 +-
 src/container/heap/heap_test.go                    |    2 +-
 src/context/context.go                             |   10 +-
 src/context/context_test.go                        |   65 +-
 src/context/withtimeout_test.go                    |    4 +-
 src/crypto/aes/aes_gcm.go                          |    2 +-
 src/crypto/aes/aes_test.go                         |   36 -
 src/crypto/aes/asm_s390x.s                         |   35 +
 src/crypto/aes/cipher.go                           |   18 +-
 src/crypto/aes/cipher_amd64.go                     |   83 +
 src/crypto/aes/cipher_asm.go                       |   48 -
 src/crypto/aes/cipher_generic.go                   |   27 +-
 src/crypto/aes/cipher_s390x.go                     |   90 +
 src/crypto/aes/gcm_amd64.s                         |   32 +-
 src/crypto/cipher/xor.go                           |    2 +-
 src/crypto/des/block.go                            |    2 +-
 src/crypto/ecdsa/ecdsa.go                          |   11 +-
 src/crypto/md5/md5block_decl.go                    |    2 +-
 src/crypto/md5/md5block_generic.go                 |    2 +-
 src/crypto/md5/md5block_ppc64le.s                  |  192 +
 src/crypto/rsa/rsa.go                              |    5 +-
 src/crypto/sha1/fallback_test.go                   |   34 +
 src/crypto/sha1/sha1_test.go                       |    2 +-
 src/crypto/sha1/sha1block_decl.go                  |    2 +-
 src/crypto/sha1/sha1block_generic.go               |    2 +-
 src/crypto/sha1/sha1block_s390x.go                 |   12 +
 src/crypto/sha1/sha1block_s390x.s                  |   34 +
 src/crypto/sha256/fallback_test.go                 |   35 +
 src/crypto/sha256/sha256_test.go                   |   13 +
 src/crypto/sha256/sha256block.go                   |    4 +-
 src/crypto/sha256/sha256block_decl.go              |    2 +-
 src/crypto/sha256/sha256block_generic.go           |    9 +
 src/crypto/sha256/sha256block_s390x.go             |   12 +
 src/crypto/sha256/sha256block_s390x.s              |   34 +
 src/crypto/sha512/fallback_test.go                 |   37 +
 src/crypto/sha512/sha512_test.go                   |   13 +
 src/crypto/sha512/sha512block.go                   |    4 +-
 src/crypto/sha512/sha512block_decl.go              |    2 +-
 src/crypto/sha512/sha512block_generic.go           |    9 +
 src/crypto/sha512/sha512block_s390x.go             |   12 +
 src/crypto/sha512/sha512block_s390x.s              |   34 +
 src/crypto/tls/alert.go                            |    4 +-
 src/crypto/tls/common.go                           |    4 +-
 src/crypto/tls/conn.go                             |    2 +-
 src/crypto/tls/handshake_client.go                 |   16 +-
 src/crypto/tls/handshake_messages.go               |    4 +-
 src/crypto/tls/handshake_server.go                 |   12 +-
 src/crypto/tls/key_agreement.go                    |   20 +-
 src/crypto/tls/prf.go                              |    2 +-
 src/crypto/tls/tls.go                              |   26 +-
 src/crypto/x509/pkcs8.go                           |    6 +-
 src/crypto/x509/sec1.go                            |    4 +-
 src/crypto/x509/x509.go                            |   16 +-
 src/crypto/x509/x509_test.go                       |  105 +-
 src/debug/dwarf/buf.go                             |    2 +-
 src/debug/dwarf/line.go                            |    2 +-
 src/debug/dwarf/typeunit.go                        |    4 +-
 src/debug/elf/elf.go                               |    4 +-
 src/debug/elf/file.go                              |   40 +-
 src/debug/gosym/pclntab.go                         |    6 +-
 src/debug/gosym/symtab.go                          |    4 +-
 src/debug/pe/file.go                               |  199 +-
 src/debug/pe/pe.go                                 |   24 -
 src/debug/pe/section.go                            |  111 +
 src/debug/pe/string.go                             |   63 +
 src/debug/pe/symbol.go                             |   95 +
 src/encoding/asn1/asn1.go                          |    2 +-
 src/encoding/asn1/marshal.go                       |    6 +-
 src/encoding/binary/binary.go                      |    2 +-
 src/encoding/gob/doc.go                            |    6 +
 src/encoding/gob/encode.go                         |    2 +-
 src/encoding/json/decode.go                        |    2 +-
 src/encoding/json/encode.go                        |  155 +-
 src/encoding/json/encode_test.go                   |  111 +-
 src/encoding/json/stream.go                        |   23 +-
 src/encoding/json/stream_test.go                   |   33 +
 src/expvar/expvar.go                               |    6 +-
 src/expvar/expvar_test.go                          |   10 +-
 src/flag/flag_test.go                              |    2 +-
 src/fmt/doc.go                                     |   10 +-
 src/fmt/fmt_test.go                                |   64 +-
 src/fmt/format.go                                  |   73 +-
 src/fmt/print.go                                   |   19 +-
 src/go/ast/ast.go                                  |    2 +-
 src/go/build/build.go                              |    2 +-
 src/go/build/deps_test.go                          |    8 +-
 src/go/build/read.go                               |    3 +-
 src/go/importer/importer.go                        |    2 +-
 src/go/internal/gcimporter/bimport.go              |  195 +-
 src/go/scanner/scanner.go                          |    6 +-
 src/go/types/api_test.go                           |   42 +
 src/go/types/call.go                               |    9 +-
 src/go/types/predicates.go                         |    2 +
 src/go/types/return.go                             |    9 +-
 src/go/types/stmt.go                               |   10 +
 src/go/types/testdata/stmt0.src                    |   17 +-
 src/go/types/testdata/stmt1.src                    |   76 +
 src/hash/adler32/adler32.go                        |   13 +-
 src/hash/crc32/crc32_generic.go                    |    2 +-
 src/hash/crc32/crc32_s390x.go                      |  101 +
 src/hash/crc32/crc32_s390x.s                       |  245 +
 src/html/escape.go                                 |    2 +-
 src/html/template/css.go                           |    2 +-
 src/html/template/examplefiles_test.go             |  226 +
 src/html/template/template.go                      |   14 +
 src/html/template/url.go                           |    2 +-
 src/image/color/ycbcr.go                           |  110 +-
 src/image/color/ycbcr_test.go                      |   44 +
 src/image/draw/draw.go                             |    8 +-
 src/image/internal/imageutil/gen.go                |   59 +-
 src/image/internal/imageutil/impl.go               |  232 +-
 src/internal/testenv/testenv.go                    |    9 +
 src/internal/trace/order.go                        |  278 +
 src/internal/trace/parser.go                       |  487 +-
 src/internal/trace/parser_test.go                  |  113 +-
 src/internal/trace/testdata/http_1_5_good          |  Bin 0 -> 42218 bytes
 src/internal/trace/testdata/stress_1_5_good        |  Bin 0 -> 7446 bytes
 src/internal/trace/testdata/stress_1_5_unordered   |  Bin 0 -> 8194 bytes
 .../trace/testdata/stress_start_stop_1_5_good      |  Bin 0 -> 6997 bytes
 src/io/io.go                                       |   11 +
 src/math/big/arith_s390x.s                         |  565 ++
 src/math/big/float.go                              |    4 +-
 src/math/big/floatmarsh.go                         |   89 +-
 src/math/big/floatmarsh_test.go                    |   82 +
 src/math/big/gcd_test.go                           |   16 +-
 src/math/big/int.go                                |    4 +-
 src/math/big/nat.go                                |   29 +-
 src/math/big/natconv.go                            |    2 +-
 src/math/big/ratconv.go                            |    2 +-
 src/math/dim_s390x.s                               |  132 +
 src/math/sqrt_s390x.s                              |   12 +
 src/math/stubs_s390x.s                             |   77 +
 src/mime/encodedword.go                            |    2 +-
 src/naclmake.bash                                  |   48 +
 src/nacltest.bash                                  |   38 +-
 src/net/cgo_unix_test.go                           |    7 +-
 src/net/dial.go                                    |  297 +-
 src/net/dial_gen.go                                |   40 -
 src/net/dial_test.go                               |  100 +-
 src/net/dnsclient_unix.go                          |  166 +-
 src/net/dnsclient_unix_test.go                     |  217 +-
 src/net/dnsconfig_unix.go                          |   29 +-
 src/net/dnsconfig_unix_test.go                     |   54 +
 src/net/dnsmsg.go                                  |   20 +
 src/net/dnsmsg_test.go                             |  118 +
 src/net/dnsname_test.go                            |    2 +-
 src/net/error_test.go                              |   59 +-
 src/net/external_test.go                           |   11 +-
 src/net/fd_plan9.go                                |   13 +-
 src/net/fd_unix.go                                 |   54 +-
 src/net/fd_windows.go                              |   71 +-
 src/net/hook.go                                    |   16 +-
 src/net/http/client.go                             |    5 +-
 src/net/http/client_test.go                        |   28 +
 src/net/http/clientserver_test.go                  |   28 +
 src/net/http/cookiejar/punycode.go                 |    2 +-
 src/net/http/fs.go                                 |   10 +-
 src/net/http/fs_test.go                            |    6 +-
 src/net/http/http.go                               |   25 +
 src/net/http/httptest/httptest_test.go             |    4 +-
 src/net/http/httputil/dump.go                      |    1 -
 src/net/http/httputil/dump_test.go                 |   40 +
 src/net/http/httputil/example_test.go              |    2 +-
 src/net/http/httputil/persist.go                   |   10 +-
 src/net/http/main_test.go                          |   23 +-
 src/net/http/pprof/pprof.go                        |    9 +-
 src/net/http/request.go                            |   14 +-
 src/net/http/request_test.go                       |    2 +
 src/net/http/response.go                           |    2 +-
 src/net/http/serve_test.go                         |   86 +-
 src/net/http/server.go                             |   73 +-
 src/net/http/transfer.go                           |    4 +-
 src/net/http/transport.go                          |   80 +-
 src/net/http/transport_test.go                     |   51 +-
 src/net/interface.go                               |   81 +-
 src/net/interface_bsd.go                           |    5 +-
 src/net/interface_linux.go                         |    3 +
 src/net/interface_test.go                          |   21 +-
 src/net/interface_windows.go                       |    3 +
 src/net/ip.go                                      |   38 +-
 src/net/ip_test.go                                 |  134 +-
 src/net/iprawsock.go                               |   13 +-
 src/net/iprawsock_plan9.go                         |    6 +-
 src/net/iprawsock_posix.go                         |   14 +-
 src/net/ipsock.go                                  |   29 +-
 src/net/ipsock_plan9.go                            |   48 +-
 src/net/ipsock_posix.go                            |   41 +-
 src/net/listen_test.go                             |   19 +-
 src/net/lookup.go                                  |   64 +-
 src/net/lookup_plan9.go                            |   55 +-
 src/net/lookup_stub.go                             |   25 +-
 src/net/lookup_test.go                             |   62 +-
 src/net/lookup_unix.go                             |   48 +-
 src/net/lookup_windows.go                          |  205 +-
 src/net/lookup_windows_test.go                     |   17 +-
 src/net/mail/message.go                            |  170 +-
 src/net/mail/message_test.go                       |   56 +-
 src/net/main_test.go                               |    2 -
 src/net/mockserver_test.go                         |   10 +-
 src/net/net.go                                     |   17 +
 src/net/netgo_unix_test.go                         |    7 +-
 src/net/parse.go                                   |    4 +-
 src/net/platform_test.go                           |    3 +-
 src/net/port.go                                    |   62 +
 src/net/port_test.go                               |   52 +
 src/net/sendfile_dragonfly.go                      |    2 +-
 src/net/sendfile_freebsd.go                        |    2 +-
 src/net/sendfile_solaris.go                        |   11 +-
 src/net/sendfile_test.go                           |   90 +
 src/net/sock_posix.go                              |   10 +-
 src/net/tcpsock.go                                 |    7 +-
 src/net/tcpsock_plan9.go                           |   19 +-
 src/net/tcpsock_posix.go                           |   19 +-
 src/net/tcpsock_test.go                            |   10 +-
 src/net/testdata/Mark.Twain-Tom.Sawyer.txt         | 8465 +++++++++++++++++++
 src/net/timeout_test.go                            |    7 +-
 src/net/udpsock.go                                 |   13 +-
 src/net/udpsock_plan9.go                           |   15 +-
 src/net/udpsock_posix.go                           |   14 +-
 src/net/udpsock_test.go                            |   47 +-
 src/net/unixsock.go                                |    7 +-
 src/net/unixsock_plan9.go                          |    8 +-
 src/net/unixsock_posix.go                          |   18 +-
 src/net/unixsock_test.go                           |    4 +
 src/net/url/url.go                                 |    6 +-
 src/net/url/url_test.go                            |    6 +-
 src/os/exec/exec_test.go                           |    2 +-
 src/os/exec_windows.go                             |    2 +-
 src/os/file_windows.go                             |   14 +-
 src/os/stat_darwin.go                              |    2 +-
 src/os/stat_dragonfly.go                           |    4 +-
 src/os/stat_freebsd.go                             |    2 +-
 src/os/stat_linux.go                               |    2 +-
 src/os/stat_nacl.go                                |    2 +-
 src/os/stat_netbsd.go                              |    4 +-
 src/os/stat_openbsd.go                             |    4 +-
 src/os/stat_plan9.go                               |    2 +-
 src/os/stat_solaris.go                             |    4 +-
 src/os/stat_windows.go                             |    2 +-
 src/os/types_windows.go                            |    2 +-
 src/os/user/lookup_unix.go                         |    7 +-
 src/path/filepath/path_test.go                     |    2 +-
 src/reflect/all_test.go                            |   86 +-
 src/reflect/asm_s390x.s                            |   30 +
 src/reflect/export_test.go                         |   22 +-
 src/reflect/type.go                                |  572 +-
 src/reflect/value.go                               |   49 +-
 src/regexp/exec_test.go                            |   12 +
 src/regexp/onepass.go                              |    2 +-
 src/runtime/alg.go                                 |    8 +-
 src/runtime/append_test.go                         |  137 +
 src/runtime/asm_amd64.s                            |  157 +-
 src/runtime/asm_s390x.s                            | 1130 +++
 src/runtime/atomic_pointer.go                      |   14 +-
 src/runtime/cgo/asm_s390x.s                        |   44 +
 src/runtime/cgo/gcc_libinit.c                      |    1 -
 src/runtime/cgo/gcc_libinit_linux_ppc64x.c         |   26 -
 src/runtime/cgo/gcc_linux_s390x.c                  |   68 +
 src/runtime/cgo/gcc_s390x.S                        |   43 +
 src/runtime/cgo/signal_darwin_armx.go              |    6 +-
 src/runtime/cgocall.go                             |    6 +-
 src/runtime/chan.go                                |   14 +-
 src/runtime/crash_test.go                          |   46 +
 src/runtime/defs_linux_s390x.go                    |  167 +
 src/runtime/error.go                               |   15 +-
 src/runtime/export_windows_test.go                 |    7 +-
 src/runtime/extern.go                              |    6 +-
 src/runtime/gcinfo_test.go                         |    4 +-
 src/runtime/hash64.go                              |    2 +-
 src/runtime/hashmap.go                             |   77 +-
 src/runtime/hashmap_fast.go                        |   33 +-
 src/runtime/heapdump.go                            |    9 +-
 src/runtime/iface.go                               |   89 +-
 src/runtime/internal/atomic/asm_386.s              |    2 +-
 src/runtime/internal/atomic/asm_amd64.s            |    2 +-
 src/runtime/internal/atomic/asm_amd64p32.s         |    2 +-
 src/runtime/internal/atomic/asm_mips64x.s          |    2 +-
 src/runtime/internal/atomic/asm_ppc64x.s           |    2 +-
 src/runtime/internal/atomic/asm_s390x.s            |  174 +
 src/runtime/internal/atomic/atomic_386.go          |    2 +-
 src/runtime/internal/atomic/atomic_amd64x.go       |    5 +-
 src/runtime/internal/atomic/atomic_arm.go          |    2 +-
 src/runtime/internal/atomic/atomic_arm64.go        |    2 +-
 src/runtime/internal/atomic/atomic_arm64.s         |    2 +-
 src/runtime/internal/atomic/atomic_mips64x.go      |    2 +-
 src/runtime/internal/atomic/atomic_ppc64x.go       |    2 +-
 src/runtime/internal/atomic/atomic_s390x.go        |   73 +
 src/runtime/internal/sys/arch.go                   |   17 +
 src/runtime/internal/sys/arch_386.go               |    2 +-
 src/runtime/internal/sys/arch_amd64.go             |    2 +-
 src/runtime/internal/sys/arch_amd64p32.go          |    2 +-
 src/runtime/internal/sys/arch_arm.go               |    2 +-
 src/runtime/internal/sys/arch_arm64.go             |    2 +-
 src/runtime/internal/sys/arch_mips64.go            |    2 +-
 src/runtime/internal/sys/arch_mips64le.go          |    2 +-
 src/runtime/internal/sys/arch_ppc64.go             |    2 +-
 src/runtime/internal/sys/arch_ppc64le.go           |    2 +-
 src/runtime/internal/sys/arch_s390x.go             |    2 +-
 src/runtime/internal/sys/gengoos.go                |    4 +-
 src/runtime/internal/sys/intrinsics.go             |  135 +-
 src/runtime/internal/sys/intrinsics_test.go        |   54 +
 src/runtime/internal/sys/zgoarch_386.go            |    2 +-
 src/runtime/internal/sys/zgoarch_amd64.go          |    2 +-
 src/runtime/internal/sys/zgoarch_amd64p32.go       |    2 +-
 src/runtime/internal/sys/zgoarch_arm.go            |    2 +-
 src/runtime/internal/sys/zgoarch_arm64.go          |    2 +-
 src/runtime/internal/sys/zgoarch_mips64.go         |    2 +-
 src/runtime/internal/sys/zgoarch_mips64le.go       |    2 +-
 src/runtime/internal/sys/zgoarch_ppc64.go          |    2 +-
 src/runtime/internal/sys/zgoarch_ppc64le.go        |    2 +-
 src/runtime/internal/sys/zgoarch_s390x.go          |    2 +-
 src/runtime/internal/sys/zgoos_android.go          |    2 +-
 src/runtime/internal/sys/zgoos_darwin.go           |    2 +-
 src/runtime/internal/sys/zgoos_dragonfly.go        |    2 +-
 src/runtime/internal/sys/zgoos_freebsd.go          |    2 +-
 src/runtime/internal/sys/zgoos_linux.go            |    2 +-
 src/runtime/internal/sys/zgoos_nacl.go             |    2 +-
 src/runtime/internal/sys/zgoos_netbsd.go           |    2 +-
 src/runtime/internal/sys/zgoos_openbsd.go          |    2 +-
 src/runtime/internal/sys/zgoos_plan9.go            |    2 +-
 src/runtime/internal/sys/zgoos_solaris.go          |    2 +-
 src/runtime/internal/sys/zgoos_windows.go          |    2 +-
 src/runtime/lfstack.go                             |    7 +-
 src/runtime/lfstack_32bit.go                       |    6 +-
 src/runtime/lfstack_64bit.go                       |   48 +
 src/runtime/lfstack_amd64.go                       |   24 -
 src/runtime/lfstack_darwin_arm64.go                |   25 -
 src/runtime/lfstack_linux_arm64.go                 |   25 -
 src/runtime/lfstack_linux_mips64x.go               |   32 -
 src/runtime/lfstack_linux_ppc64x.go                |   32 -
 src/runtime/lock_futex.go                          |    6 +-
 src/runtime/malloc.go                              |   72 +-
 src/runtime/map_test.go                            |   16 +
 src/runtime/mbarrier.go                            |   19 +-
 src/runtime/mbitmap.go                             |   63 +-
 src/runtime/mem_linux.go                           |    7 +
 src/runtime/memclr_s390x.s                         |  122 +
 src/runtime/memmove_ppc64x.s                       |  117 +-
 src/runtime/memmove_s390x.s                        |  189 +
 src/runtime/mfinal.go                              |   12 +-
 src/runtime/mgc.go                                 |   84 +-
 src/runtime/mgcmark.go                             |  266 +-
 src/runtime/mheap.go                               |   34 +-
 src/runtime/mmap.go                                |    3 +
 src/runtime/mprof.go                               |    2 +-
 src/runtime/mstkbar.go                             |   32 +-
 src/runtime/noasm.go                               |    2 +-
 src/runtime/os1_darwin.go                          |  538 --
 src/runtime/os1_dragonfly.go                       |  270 -
 src/runtime/os1_linux.go                           |  393 -
 src/runtime/os1_linux_generic.go                   |   27 -
 src/runtime/os1_linux_mips64x.go                   |   26 -
 src/runtime/os1_netbsd.go                          |  275 -
 src/runtime/os1_plan9.go                           |    4 +-
 src/runtime/os1_windows.go                         |  703 --
 src/runtime/os2_darwin.go                          |   14 -
 src/runtime/os2_dragonfly.go                       |   15 -
 src/runtime/os2_linux_mips64x.go                   |   25 -
 src/runtime/os2_netbsd.go                          |   18 -
 src/runtime/os2_windows.go                         |   19 -
 src/runtime/os_darwin.go                           |  542 +-
 src/runtime/os_dragonfly.go                        |  273 +
 src/runtime/os_linux.go                            |  435 +-
 src/runtime/os_linux_386.go                        |   33 -
 src/runtime/os_linux_arm.go                        |   49 +-
 src/runtime/os_linux_arm64.go                      |   16 +-
 .../{os2_linux_generic.go => os_linux_generic.go}  |   19 +
 src/runtime/os_linux_mips64x.go                    |   37 +-
 src/runtime/os_linux_noauxv.go                     |   10 +
 src/runtime/os_linux_s390x.go                      |   46 +
 src/runtime/os_netbsd.go                           |  283 +-
 .../{os1_netbsd_386.go => os_netbsd_386.go}        |    0
 .../{os1_netbsd_amd64.go => os_netbsd_amd64.go}    |    0
 src/runtime/os_windows.go                          |  720 +-
 src/runtime/panic.go                               |    2 +-
 src/runtime/pprof/mprof_test.go                    |    2 +-
 src/runtime/pprof/pprof_test.go                    |   18 +-
 src/runtime/proc.go                                |  111 +-
 src/runtime/race/testdata/io_test.go               |   37 +-
 src/runtime/rdebug.go                              |    7 +-
 src/runtime/rt0_linux_s390x.s                      |   20 +
 src/runtime/runtime-gdb_test.go                    |  124 +-
 src/runtime/runtime1.go                            |   47 +-
 src/runtime/runtime2.go                            |  144 +-
 src/runtime/select.go                              |    4 +-
 src/runtime/signal_dragonfly.go                    |   14 +-
 src/runtime/signal_freebsd.go                      |   14 +-
 src/runtime/signal_linux_s390x.go                  |  208 +
 src/runtime/signal_openbsd.go                      |   14 +-
 src/runtime/sigtab_linux_generic.go                |    2 +-
 src/runtime/sigtab_linux_mips64x.go                |    2 +-
 src/runtime/slice.go                               |   63 +-
 src/runtime/softfloat_arm.go                       |   11 +-
 src/runtime/stack.go                               |    9 +-
 src/runtime/string.go                              |   12 +-
 src/runtime/string_test.go                         |   26 +-
 src/runtime/symtab.go                              |    5 +-
 src/runtime/sys_linux_s390x.s                      |  440 +
 src/runtime/sys_s390x.go                           |   45 +
 src/runtime/syscall_windows_test.go                |   66 +-
 src/runtime/tls_s390x.s                            |   51 +
 src/runtime/trace.go                               |  219 +-
 src/runtime/trace/trace_stack_test.go              |   12 +-
 src/runtime/trace/trace_test.go                    |   52 +-
 src/runtime/type.go                                |  428 +-
 src/runtime/unaligned1.go                          |    2 +-
 src/runtime/vdso_linux_amd64.go                    |   50 +-
 src/runtime/vdso_none.go                           |    4 +-
 src/runtime/vlop_arm_test.go                       |   44 +
 src/runtime/vlrt.go                                |    1 -
 src/strconv/atof.go                                |    4 +-
 src/strconv/atof_test.go                           |   24 +
 src/strconv/extfloat.go                            |    4 +-
 src/strings/reader.go                              |    5 +-
 src/strings/reader_test.go                         |   41 +-
 src/strings/strings.go                             |   27 +-
 src/strings/strings_test.go                        |   37 +-
 src/sync/atomic/asm_s390x.s                        |  143 +
 src/sync/pool.go                                   |    4 +-
 src/syscall/asm_linux_s390x.s                      |  156 +
 src/syscall/mksyscall_windows.go                   |    4 +-
 src/syscall/sockcmsg_unix.go                       |    2 +-
 src/syscall/types_linux.go                         |    3 +
 src/syscall/ztypes_linux_ppc64.go                  |    7 +-
 src/syscall/ztypes_linux_ppc64le.go                |    7 +-
 src/testing/benchmark.go                           |   45 +-
 src/testing/match.go                               |   71 +-
 src/testing/match_test.go                          |  118 +
 src/testing/sub_test.go                            |  180 +-
 src/testing/testing.go                             |   16 +-
 src/text/template/exec.go                          |   12 +-
 src/text/template/exec_test.go                     |   17 +
 src/text/template/helper.go                        |   14 +
 src/time/time.go                                   |   10 +-
 src/time/time_test.go                              |    2 +-
 src/time/zoneinfo_windows.go                       |    2 +-
 src/unicode/letter.go                              |    6 +-
 src/unicode/maketables.go                          |   20 +
 src/unicode/tables.go                              |  131 +
 test/alg.go                                        |   46 +
 test/bench/go1/divconst_test.go                    |   73 +
 test/checkbce.go                                   |   25 +
 test/fixedbugs/issue11361.go                       |   11 +
 test/fixedbugs/issue14729.go                       |   14 +
 test/fixedbugs/issue14988.go                       |   13 +
 test/fixedbugs/issue15084.go                       |   30 +
 test/fixedbugs/issue15091.go                       |   25 +
 test/fixedbugs/issue15175.go                       |   66 +
 test/fixedbugs/issue15252.go                       |   32 +
 test/fixedbugs/issue15281.go                       |   64 +
 test/fixedbugs/issue15311.go                       |   20 +
 test/fixedbugs/issue15439.go                       |   25 +
 test/goprint.go                                    |    9 +-
 test/init1.go                                      |    2 +-
 test/linkx_run.go                                  |    4 +-
 test/live_ssa.go                                   |   13 +-
 test/loopbce.go                                    |   77 +
 test/nilptr3.go                                    |   25 +-
 test/nilptr3_ssa.go                                |   21 +
 test/phiopt.go                                     |   73 +-
 test/prove.go                                      |    4 +
 test/writebarrier.go                               |   29 +
 764 files changed, 48177 insertions(+), 19513 deletions(-)

diff --cc src/runtime/malloc.go
index 31335dae80,081d1419cb..6fe4656603
--- a/src/runtime/malloc.go
+++ b/src/runtime/malloc.go
@@@ -490,77 -484,6 +487,71 @@@ func (h *mheap) sysAlloc(n uintptr) uns
  // base address for all 0-byte allocations
  var zerobase uintptr
  
- const (
- 	// flags to malloc
- 	_FlagNoScan = 1 << 0 // GC doesn't have to scan object
- 	_FlagNoZero = 1 << 1 // don't zero memory
- )
- 
 +// nextFreeFast returns the next free object if one is quickly available.
 +// Otherwise it returns 0.
 +func (c *mcache) nextFreeFast(sizeclass int8) gclinkptr {
 +	s := c.alloc[sizeclass]
 +	ctzIndex := uint8(s.allocCache & 0xff)
 +	if ctzIndex != 0 {
 +		theBit := uint64(ctzVals[ctzIndex])
 +		freeidx := s.freeindex // help the pre ssa compiler out here with cse.
 +		result := freeidx + uintptr(theBit)
 +		if result < s.nelems {
 +			s.allocCache >>= (theBit + 1)
 +			freeidx = result + 1
 +			if freeidx%64 == 0 && freeidx != s.nelems {
 +				// We just incremented s.freeindex so it isn't 0
 +				// so we are moving to the next aCache.
 +				whichByte := freeidx / 8
 +				s.refillAllocCache(whichByte)
 +			}
 +			s.freeindex = freeidx
 +			v := gclinkptr(result*s.elemsize + s.base())
 +			s.allocCount++
 +			return v
 +		}
 +	}
 +	return 0
 +}
 +
 +// nextFree returns the next free object from the cached span if one is available.
 +// Otherwise it refills the cache with a span with an available object and
 +// returns that object along with a flag indicating that this was a heavy
 +// weight allocation. If it is a heavy weight allocation the caller must
 +// determine whether a new GC cycle needs to be started or if the GC is active
 +// whether this goroutine needs to assist the GC.
 +func (c *mcache) nextFree(sizeclass int8) (v gclinkptr, shouldhelpgc bool) {
 +	s := c.alloc[sizeclass]
 +	shouldhelpgc = false
 +	freeIndex := s.nextFreeIndex()
 +	if freeIndex == s.nelems {
 +		// The span is full.
 +		if uintptr(s.allocCount) != s.nelems {
 +			println("runtime: s.allocCount=", s.allocCount, "s.nelems=", s.nelems)
 +			throw("s.allocCount != s.nelems && freeIndex == s.nelems")
 +		}
 +		systemstack(func() {
 +			c.refill(int32(sizeclass))
 +		})
 +		shouldhelpgc = true
 +		s = c.alloc[sizeclass]
 +
 +		freeIndex = s.nextFreeIndex()
 +	}
 +
 +	if freeIndex >= s.nelems {
 +		throw("freeIndex is not valid")
 +	}
 +
 +	v = gclinkptr(freeIndex*s.elemsize + s.base())
 +	s.allocCount++
 +	if uintptr(s.allocCount) > s.nelems {
 +		println("s.allocCount=", s.allocCount, "s.nelems=", s.nelems)
 +		throw("s.allocCount > s.nelems")
 +	}
 +	return
 +}
 +
  // Allocate an object of size bytes.
  // Small objects are allocated from the per-P cache's free lists.
  // Large objects (> 32 kB) are allocated straight from the heap.
@@@ -619,9 -538,11 +606,10 @@@ func mallocgc(size uintptr, typ *_type
  	shouldhelpgc := false
  	dataSize := size
  	c := gomcache()
 -	var s *mspan
  	var x unsafe.Pointer
+ 	noscan := typ == nil || typ.kind&kindNoPointers != 0
  	if size <= maxSmallSize {
- 		if flags&flagNoScan != 0 && size < maxTinySize {
+ 		if noscan && size < maxTinySize {
  			// Tiny allocator.
  			//
  			// Tiny allocator combines several tiny allocation requests
@@@ -693,30 -623,41 +681,31 @@@
  				sizeclass = size_to_class128[(size-1024+127)>>7]
  			}
  			size = uintptr(class_to_size[sizeclass])
 -			s = c.alloc[sizeclass]
 -			v := s.freelist
 -			if v.ptr() == nil {
 -				systemstack(func() {
 -					c.refill(int32(sizeclass))
 -				})
 -				shouldhelpgc = true
 -				s = c.alloc[sizeclass]
 -				v = s.freelist
 +			var v gclinkptr
 +			v = c.nextFreeFast(sizeclass)
 +			if v == 0 {
 +				v, shouldhelpgc = c.nextFree(sizeclass)
  			}
 -			s.freelist = v.ptr().next
 -			s.ref++
 -			// prefetchnta offers best performance, see change list message.
 -			prefetchnta(uintptr(v.ptr().next))
  			x = unsafe.Pointer(v)
- 			if flags&flagNoZero == 0 {
+ 			if needzero {
 -				v.ptr().next = 0
 -				if size > 2*sys.PtrSize && ((*[2]uintptr)(x))[1] != 0 {
 -					memclr(unsafe.Pointer(v), size)
 -				}
 +				memclr(unsafe.Pointer(v), size)
 +				// TODO:(rlh) Only clear if object is not known to be zeroed.
  			}
  		}
  	} else {
  		var s *mspan
  		shouldhelpgc = true
  		systemstack(func() {
- 			s = largeAlloc(size, flags)
+ 			s = largeAlloc(size, needzero)
  		})
 -		x = unsafe.Pointer(uintptr(s.start << pageShift))
 +		s.freeindex = 1
 +		x = unsafe.Pointer(s.base())
  		size = s.elemsize
  	}
  
- 	if flags&flagNoScan != 0 {
+ 	var scanSize uintptr
+ 	if noscan {
 -		// All objects are pre-marked as noscan. Nothing to do.
 +		heapBitsSetTypeNoScan(uintptr(x), size)
  	} else {
  		// If allocating a defer+arg block, now that we've picked a malloc size
  		// large enough to hold everything, cut the "asked for" size down to
@@@ -752,29 -694,10 +742,27 @@@
  	// All slots hold nil so no scanning is needed.
  	// This may be racing with GC so do it atomically if there can be
  	// a race marking the bit.
- 	if gcphase == _GCmarktermination || gcBlackenPromptly {
- 		systemstack(func() {
- 			gcmarknewobject_m(uintptr(x), size)
- 		})
+ 	if gcphase != _GCoff {
+ 		gcmarknewobject(uintptr(x), size, scanSize)
  	}
  
 +	// The object x is about to be reused but tracefree and msanfree
 +	// need to be informed.
 +	// TODO:(rlh) It is quite possible that this object is being allocated
 +	// out of a fresh span and that there is no preceding call to
 +	// tracealloc with this object. If this is an issue then initialization
 +	// of the fresh span needs to leave some crumbs around that can be used to
 +	// avoid these calls. Furthermore these crumbs a likely the same as
 +	// those needed to determine if the object needs to be zeroed.
 +	// In the case of msanfree it does not make sense to call msanfree
 +	// followed by msanmalloc. msanfree indicates that the bytes are not
 +	// initialized but msanmalloc is about to indicate that they are.
 +	// It makes no difference whether msanmalloc has been called on these
 +	// bytes or not.
 +	if debug.allocfreetrace != 0 {
 +		tracefree(unsafe.Pointer(x), size)
 +	}
 +
  	if raceenabled {
  		racemalloc(x, size)
  	}
diff --cc src/runtime/mbitmap.go
index b342de600e,3df697ee5c..af89577703
--- a/src/runtime/mbitmap.go
+++ b/src/runtime/mbitmap.go
@@@ -96,9 -95,8 +97,10 @@@ func addb(p *byte, n uintptr) *byte 
  }
  
  // subtractb returns the byte pointer p-n.
 +// subtractb is typically used when traversing the pointer tables referred to by hbits
 +// which are arranged in reverse order.
  //go:nowritebarrier
+ //go:nosplit
  func subtractb(p *byte, n uintptr) *byte {
  	// Note: wrote out full expression instead of calling add(p, -n)
  	// to reduce the number of temporaries generated by the
diff --cc src/runtime/mgcmark.go
index d05ad6549f,b5a9ff9b56..3704164527
--- a/src/runtime/mgcmark.go
+++ b/src/runtime/mgcmark.go
@@@ -1146,8 -1274,10 +1282,10 @@@ func gcmarknewobject(obj, size, scanSiz
  	if useCheckmark && !gcBlackenPromptly { // The world should be stopped so this should not happen.
  		throw("gcmarknewobject called while doing checkmark")
  	}
 -	heapBitsForAddr(obj).setMarked()
 +	markBitsForAddr(obj).setMarked()
- 	atomic.Xadd64(&work.bytesMarked, int64(size))
+ 	gcw := &getg().m.p.ptr().gcw
+ 	gcw.bytesMarked += uint64(size)
+ 	gcw.scanWork += int64(scanSize)
  }
  
  // Checkmarking
