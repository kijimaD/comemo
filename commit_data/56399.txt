commit 36d32f68f41561fb64677297e3733f5d5b866c2a
Author: Michael Anthony Knyszek <mknyszek@google.com>
Date:   Sun May 5 21:17:27 2024 +0000

    runtime: update large object stats before freeSpan in sweep
    
    Currently freeSpan is called before large object stats are updated when
    sweeping large objects. This means heapStats.inHeap might get subtracted
    before the large object is added to the largeFree field. The end result
    is that the /memory/classes/heap/unused:bytes metric, which subtracts
    live objects (alloc-free) from inHeap may overflow.
    
    Fix this by always updating the large object stats before calling
    freeSpan.
    
    Fixes #67019.
    
    Change-Id: Ib02bd8dcd1cf8cd1bc0110b6141e74f678c10445
    Reviewed-on: https://go-review.googlesource.com/c/go/+/583380
    Auto-Submit: Michael Knyszek <mknyszek@google.com>
    Reviewed-by: Felix Geisend√∂rfer <felix.geisendoerfer@datadoghq.com>
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>
    Reviewed-by: Michael Pratt <mpratt@google.com>

 src/runtime/metrics_test.go | 36 ++++++++++++++++++++++++++++++++++++
 src/runtime/mgcsweep.go     | 23 +++++++++++++----------
 2 files changed, 49 insertions(+), 10 deletions(-)
