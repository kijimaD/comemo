commit 28f8dbd7b941648aea311bb0cf331f88c02441b6
Author: qmuntal <quimmuntal@gmail.com>
Date:   Fri Dec 2 09:25:26 2022 +0100

    runtime,cmd/internal/obj/x86: use TEB TLS slots on windows/i386
    
    This CL redesign how we get the TLS pointer on windows/i386.
    It applies the same changes as done in CL 431775 for windows/amd64.
    
    We were previously reading it from the [TEB] arbitrary data slot,
    located at 0x14(FS), which can only hold 1 TLS pointer.
    
    With this CL, we will read the TLS pointer from the TEB TLS slot array,
    located at 0xE10(GS). The TLS slot array can hold multiple
    TLS pointers, up to 64, so multiple Go runtimes running on the
    same thread can coexists with different TLS.
    
    Each new TLS slot has to be allocated via [TlsAlloc],
    which returns the slot index. This index can then be used to get the
    slot offset from GS with the following formula: 0xE10 + index*4.
    
    The slot index is fixed per Go runtime, so we can store it
    in runtime.tls_g and use it latter on to read/update the TLS pointer.
    
    Loading the TLS pointer requires the following asm instructions:
    
      MOVQ runtime.tls_g, AX
      MOVQ AX(FS), AX
    
    Notice that this approach will now be implemented in all the supported
    windows arches.
    
    [TEB]: https://en.wikipedia.org/wiki/Win32_Thread_Information_Block
    [TlsAlloc]: https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-tlsalloc
    
    Change-Id: If4550b0d44694ee6480d4093b851f4991a088b32
    Reviewed-on: https://go-review.googlesource.com/c/go/+/454675
    Reviewed-by: Michael Pratt <mpratt@google.com>
    Run-TryBot: Quim Muntal <quimmuntal@gmail.com>
    Reviewed-by: Cherry Mui <cherryyz@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>

 src/cmd/internal/obj/x86/asm6.go  | 46 ++++++++++-----------------------------
 src/cmd/internal/obj/x86/obj6.go  | 18 ++++++++++-----
 src/runtime/asm_386.s             | 19 ++++++++++++----
 src/runtime/cgo/gcc_windows_386.c | 12 +++++-----
 src/runtime/sys_windows_386.s     | 46 ++++++++++++++++++++++++++++++++-------
 5 files changed, 84 insertions(+), 57 deletions(-)
