commit 80834af2063962bad87a56f0f45546cc18f30a9c
Author: Lynn Boger <laboger@linux.vnet.ibm.com>
Date:   Wed Sep 27 12:15:04 2023 -0500

    cmd/compile: avoid ANDCCconst on PPC64 if condition not needed
    
    In the PPC64 ISA, the instruction to do an 'and' operation
    using an immediate constant is only available in the form that
    also sets CR0 (i.e. clobbers the condition register.) This means
    CR0 is being clobbered unnecessarily in many cases. That
    affects some decisions made during some compiler passes
    that check for it.
    
    In those cases when the constant used by the ANDCC is a right
    justified consecutive set of bits, a shift instruction can
    be used which has the same effect if CR0 does not need to be
    set. The rule to do that has been added to the late rules file
    after other rules using ANDCCconst have been processed in the
    main rules file.
    
    Some codegen tests had to be updated since ANDCC is no
    longer generated for some cases. A new test case was added to
    verify the ANDCC is present if the results for both the AND
    and CR0 are used.
    
    Change-Id: I304f607c039a458e2d67d25351dd00aea72ba542
    Reviewed-on: https://go-review.googlesource.com/c/go/+/531435
    Run-TryBot: Lynn Boger <laboger@linux.vnet.ibm.com>
    Reviewed-by: Paul Murphy <murp@ibm.com>
    LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>
    Reviewed-by: Carlos Amedee <carlos@golang.org>
    Reviewed-by: Jayanth Krishnamurthy <jayanth.krishnamurthy@ibm.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Reviewed-by: Dmitri Shuralyov <dmitshur@google.com>

 src/cmd/compile/internal/ssa/_gen/PPC64.rules      |   8 +-
 .../compile/internal/ssa/_gen/PPC64latelower.rules |   3 +
 src/cmd/compile/internal/ssa/rewritePPC64.go       | 280 +++++----------------
 .../compile/internal/ssa/rewritePPC64latelower.go  |  24 ++
 test/codegen/arithmetic.go                         |  12 +-
 test/codegen/bool.go                               |  24 +-
 test/codegen/shift.go                              |  18 +-
 7 files changed, 120 insertions(+), 249 deletions(-)
