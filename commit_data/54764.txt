commit da564d0006e2cc286fecb3cec94ed143a2667866
Author: qmuntal <quimmuntal@gmail.com>
Date:   Mon Sep 19 12:19:38 2022 +0200

    runtime,cmd/internal/obj/x86: use TEB TLS slots on windows/amd64
    
    This CL redesign how we get the TLS pointer on windows/amd64.
    
    We were previously reading it from the [TEB] arbitrary data slot,
    located at 0x28(GS), which can only hold 1 TLS pointer.
    
    With this CL, we will read the TLS pointer from the TEB TLS slot array,
    located at 0x1480(GS). The TLS slot array can hold multiple
    TLS pointers, up to 64, so multiple Go runtimes running on the
    same thread can coexists with different TLS.
    
    Each new TLS slot has to be allocated via [TlsAlloc],
    which returns the slot index. This index can then be used to get the
    slot offset from GS with the following formula: 0x1480 + index*8
    
    The slot index is fixed per Go runtime, so we can store it
    in runtime.tls_g and use it latter on to read/update the TLS pointer.
    
    Loading the TLS pointer requires the following asm instructions:
    
      MOVQ runtime.tls_g, AX
      MOVQ AX(GS), AX
    
    Notice that this approach is also implemented on windows/arm64.
    
    [TEB]: https://en.wikipedia.org/wiki/Win32_Thread_Information_Block
    [TlsAlloc]: https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-tlsalloc
    
    Updates #22192
    
    Change-Id: Idea7119fd76a3cd083979a4d57ed64b552fa101b
    Reviewed-on: https://go-review.googlesource.com/c/go/+/431775
    Reviewed-by: Cherry Mui <cherryyz@google.com>
    TryBot-Result: Gopher Robot <gobot@golang.org>
    Run-TryBot: Quim Muntal <quimmuntal@gmail.com>
    Reviewed-by: Michael Knyszek <mknyszek@google.com>
    Reviewed-by: Alex Brainman <alex.brainman@gmail.com>

 src/cmd/internal/obj/x86/asm6.go    | 20 +++---------------
 src/cmd/internal/obj/x86/obj6.go    | 21 +++++++++++++++++--
 src/runtime/asm_amd64.s             | 13 +++++++++---
 src/runtime/cgo/gcc_windows_amd64.c |  6 ++++--
 src/runtime/sys_windows_amd64.s     | 41 +++++++++++++++++++++++++++++++++----
 5 files changed, 73 insertions(+), 28 deletions(-)
