commit f0d23c9dbb2142b975fa8fb13a57213d0c15bdd1
Author: Wei Fu <fuweid89@gmail.com>
Date:   Sun Jan 24 18:21:06 2021 +0800

    internal/poll: netpollcheckerr before sendfile
    
    In net/http package, the ServeContent/ServeFile doesn't check the I/O
    timeout error from chunkWriter or *net.TCPConn, which means that both
    HTTP status and headers might be missing when WriteTimeout happens. If
    the poll.SendFile() doesn't check the *poll.FD state before sending
    data, the client will only receive the response body with status and
    report "malformed http response/status code".
    
    This patch is to enable netpollcheckerr before sendfile, which should
    align with normal *poll.FD.Write() and Splice().
    
    Fixes #43822
    
    Change-Id: I32517e3f261bab883a58b577b813ef189214b954
    Reviewed-on: https://go-review.googlesource.com/c/go/+/285914
    Reviewed-by: Emmanuel Odeke <emmanuel@orijtech.com>
    Trust: Emmanuel Odeke <emmanuel@orijtech.com>
    Trust: Bryan C. Mills <bcmills@google.com>
    Run-TryBot: Emmanuel Odeke <emmanuel@orijtech.com>

 src/internal/poll/sendfile_bsd.go     |  4 +++
 src/internal/poll/sendfile_linux.go   |  3 ++
 src/internal/poll/sendfile_solaris.go |  3 ++
 src/net/sendfile_test.go              | 65 +++++++++++++++++++++++++++++++++++
 4 files changed, 75 insertions(+)
