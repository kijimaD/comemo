commit 67c83db60db744c17316a4dc1d590c9649d66e6c
Author: Russ Cox <rsc@golang.org>
Date:   Thu Feb 20 15:58:47 2014 -0500

    runtime: use goc2c as much as possible
    
    Package runtime's C functions written to be called from Go
    started out written in C using carefully constructed argument
    lists and the FLUSH macro to write a result back to memory.
    
    For some functions, the appropriate parameter list ended up
    being architecture-dependent due to differences in alignment,
    so we added 'goc2c', which takes a .goc file containing Go func
    declarations but C bodies, rewrites the Go func declaration to
    equivalent C declarations for the target architecture, adds the
    needed FLUSH statements, and writes out an equivalent C file.
    That C file is compiled as part of package runtime.
    
    Native Client's x86-64 support introduces the most complex
    alignment rules yet, breaking many functions that could until
    now be portably written in C. Using goc2c for those avoids the
    breakage.
    
    Separately, Keith's work on emitting stack information from
    the C compiler would require the hand-written functions
    to add #pragmas specifying how many arguments are result
    parameters. Using goc2c for those avoids maintaining #pragmas.
    
    For both reasons, use goc2c for as many Go-called C functions
    as possible.
    
    This CL is a replay of the bulk of CL 15400047 and CL 15790043,
    both of which were reviewed as part of the NaCl port and are
    checked in to the NaCl branch. This CL is part of bringing the
    NaCl code into the main tree.
    
    No new code here, just reformatting and occasional movement
    into .h files.
    
    LGTM=r
    R=dave, alex.brainman, r
    CC=golang-codereviews
    https://golang.org/cl/65220044

 src/cmd/dist/buildruntime.c                |   4 +-
 src/cmd/dist/goc2c.c                       |  97 ++++++---
 src/pkg/runtime/{alg.c => alg.goc}         |  29 ++-
 src/pkg/runtime/cgocall.c                  |  11 -
 src/pkg/runtime/{chan.c => chan.goc}       | 251 ++++-----------------
 src/pkg/runtime/chan.h                     |  75 +++++++
 src/pkg/runtime/{complex.c => complex.goc} |   8 +-
 src/pkg/runtime/{cpuprof.c => cpuprof.goc} |   6 +-
 src/pkg/runtime/{export_test.c => defs.c}  |  15 +-
 src/pkg/runtime/export_test.go             |  30 +--
 src/pkg/runtime/{hashmap.c => hashmap.goc} | 335 ++++++-----------------------
 src/pkg/runtime/hashmap.h                  | 147 +++++++++++++
 src/pkg/runtime/hashmap_fast.c             |   3 +
 src/pkg/runtime/{iface.c => iface.goc}     | 197 ++++-------------
 src/pkg/runtime/{lfstack.c => lfstack.goc} |  10 +-
 src/pkg/runtime/malloc.goc                 |   5 +-
 src/pkg/runtime/malloc.h                   |   1 +
 src/pkg/runtime/mgc0.c                     |  10 +-
 src/pkg/runtime/parfor.c                   |  28 +--
 src/pkg/runtime/pprof/pprof_test.go        |  10 +-
 src/pkg/runtime/print.c                    |  36 ++--
 src/pkg/runtime/proc.c                     |  43 +---
 src/pkg/runtime/rdebug.goc                 |  22 ++
 src/pkg/runtime/runtime.c                  |  81 -------
 src/pkg/runtime/runtime.h                  |  31 ++-
 src/pkg/runtime/runtime1.goc               | 114 ++++++++++
 src/pkg/runtime/{slice.c => slice.goc}     |  30 +--
 src/pkg/runtime/stack.c                    |   8 -
 src/pkg/runtime/string.goc                 |   5 +-
 src/pkg/runtime/{symtab.c => symtab.goc}   |  25 ++-
 30 files changed, 710 insertions(+), 957 deletions(-)
