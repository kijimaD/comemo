commit 7388956b76ce15a11346cebefcf6193db044caaf
Author: Matthew Dempsky <mdempsky@google.com>
Date:   Thu Jul 30 18:35:00 2020 -0700

    cmd/cgo: fix mangling of enum and union types
    
    Consider this test package:
    
        package p
    
        // enum E { E0 };
        // union U { long x; };
        // void f(enum E e, union U* up) {}
        import "C"
    
        func f() {
            C.f(C.enum_E(C.E0), (*C.union_U)(nil))
        }
    
    In Go 1.14, cgo translated this to (omitting irrelevant details):
    
        type _Ctype_union_U [8]byte
    
        func f() {
            _Cfunc_f(uint32(_Ciconst_E0), (*[8]byte)(nil))
        }
    
        func _Cfunc_f(p0 uint32, p1 *[8]byte) (r1 _Ctype_void) { ... }
    
    Notably, _Ctype_union_U was declared as a defined type, but uses were
    being rewritten into uses of the underlying type, which matched how
    _Cfunc_f was declared.
    
    After CL 230037, cgo started consistently rewriting "C.foo" type
    expressions as "_Ctype_foo", which caused it to start emitting:
    
        type _Ctype_enum_E uint32
        type _Ctype_union_U [8]byte
    
        func f() {
            _Cfunc_f(_Ctype_enum_E(_Ciconst_E0), (*_Ctype_union_U)(nil))
        }
    
        // _Cfunc_f unchanged
    
    Of course, this fails to type-check because _Ctype_enum_E and
    _Ctype_union_U are defined types.
    
    This CL changes cgo to emit:
    
        type _Ctype_enum_E = uint32
        type _Ctype_union_U = [8]byte
    
        // f unchanged since CL 230037
        // _Cfunc_f still unchanged
    
    It would probably be better to fix this in (*typeConv).loadType so
    that cgo generated code uses the _Ctype_foo aliases too. But as it
    wouldn't have any effect on actual compilation, it's not worth the
    risk of touching it at this point in the release cycle.
    
    Updates #39537.
    Fixes #40494.
    
    Change-Id: I88269660b40aeda80a9a9433777601a781b48ac0
    Reviewed-on: https://go-review.googlesource.com/c/go/+/246057
    Reviewed-by: Ian Lance Taylor <iant@golang.org>

 misc/cgo/test/test.go | 13 +++++++++++++
 src/cmd/cgo/out.go    |  4 +++-
 2 files changed, 16 insertions(+), 1 deletion(-)
