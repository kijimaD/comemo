commit 058bb7ea278d8e073be1e1c73d01fbfd74c170fd
Author: Austin Clements <austin@google.com>
Date:   Mon Dec 11 19:40:12 2017 -0500

    runtime: split object finding out of heapBitsForObject
    
    heapBitsForObject does two things: it finds the base of the object and
    it creates the heapBits for the base of the object. There are several
    places where we just care about the base of the object. Furthermore,
    greyobject only needs the heapBits in the checkmark path and can
    easily compute them only when needed. Once we eliminate passing the
    heap bits to grayobject, almost all uses of heapBitsForObject don't
    need the heap bits.
    
    Hence, this splits heapBitsForObject into findObject and
    heapBitsForAddr (the latter already exists), removes the hbits
    argument to grayobject, and replaces all heapBitsForObject calls with
    calls to findObject.
    
    In addition to making things cleaner overall, heapBitsForAddr is going
    to get more expensive shortly, so it's important that we don't do it
    needlessly.
    
    Note that there's an interesting performance pitfall here. I had
    originally moved findObject to mheap.go, since it made more sense
    there. However, that leads to a ~2% slow down and a whopping 11%
    increase in L1 icache misses on both the x/garbage and compilebench
    benchmarks. This suggests we may want to be more principled about
    this, but, for now, let's just leave findObject in mbitmap.go.
    
    (I tried to make findObject small enough to inline by splitting out
    the error case, but, sadly, wasn't quite able to get it under the
    inlining budget.)
    
    Change-Id: I7bcb92f383ade565d22a9f2494e4c66fd513fb10
    Reviewed-on: https://go-review.googlesource.com/85878
    Run-TryBot: Austin Clements <austin@google.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Rick Hudson <rlh@golang.org>

 src/runtime/cgocall.go |  3 ++-
 src/runtime/mbitmap.go | 19 +++++++++----------
 src/runtime/mfinal.go  |  2 +-
 src/runtime/mgcmark.go | 19 ++++++++++---------
 src/runtime/mheap.go   |  2 +-
 src/runtime/mwbbuf.go  |  6 +-----
 src/runtime/race.go    |  2 +-
 7 files changed, 25 insertions(+), 28 deletions(-)
