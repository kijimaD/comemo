commit a91ad4250c118d97d2f7fad648313fcb09b38d5f
Merge: 5beb39baf8 3b6b86d1fe
Author: Dmitri Shuralyov <dmitshur@golang.org>
Date:   Wed Jul 8 23:29:54 2020 -0400

    [dev.boringcrypto] all: merge master into dev.boringcrypto
    
    Change-Id: I948e086e11e1da571e2be23bb08a7bbd6618dc2f

 .gitattributes                                     |   20 +-
 AUTHORS                                            |    5 +-
 CONTRIBUTORS                                       |    7 +-
 api/go1.15.txt                                     |  132 ++
 api/next.txt                                       |    3 -
 doc/contribute.html                                |  144 +-
 doc/editors.html                                   |    2 +-
 doc/effective_go.html                              |   12 +-
 doc/gccgo_install.html                             |   25 +-
 doc/go1.10.html                                    |    4 +-
 doc/go1.14.html                                    |   10 +-
 doc/go1.15.html                                    |  705 ++++++-
 doc/go_faq.html                                    |    2 +-
 doc/help.html                                      |    2 +-
 doc/install-source.html                            |   18 +-
 misc/cgo/test/test.go                              |    4 +
 misc/cgo/test/testdata/issue27054/egl.h            |    1 +
 misc/cgo/test/testdata/issue27054/test27054.go     |    6 +-
 misc/cgo/testgodefs/testdata/issue39534.go         |   12 +
 misc/cgo/testgodefs/testgodefs_test.go             |    1 +
 misc/cgo/testplugin/plugin_test.go                 |    2 +-
 misc/cgo/testshared/shared_test.go                 |   22 +
 misc/cgo/testshared/testdata/gcdata/main/main.go   |   37 +
 misc/cgo/testshared/testdata/gcdata/p/p.go         |    7 +
 misc/cgo/testshared/testdata/issue39777/a/a.go     |    9 +
 misc/cgo/testshared/testdata/issue39777/b/b.go     |    7 +
 misc/wasm/wasm_exec.js                             |   48 +-
 src/all.bat                                        |   54 +-
 src/bufio/scan_test.go                             |   14 +-
 src/clean.bat                                      |   64 +-
 src/cmd/addr2line/addr2line_test.go                |   16 +-
 src/cmd/asm/doc.go                                 |    7 +-
 src/cmd/asm/internal/asm/testdata/arm64.s          |    3 +
 src/cmd/asm/internal/asm/testdata/arm64enc.s       |    1 +
 src/cmd/cgo/doc.go                                 |   11 +-
 src/cmd/cgo/gcc.go                                 |   10 +-
 src/cmd/cgo/out.go                                 |    5 +
 src/cmd/compile/doc.go                             |    2 +
 src/cmd/compile/fmt_test.go                        |   15 +-
 src/cmd/compile/fmtmap_test.go                     |    5 +
 src/cmd/compile/internal/amd64/ssa.go              |    8 +-
 src/cmd/compile/internal/arm/ssa.go                |   51 +-
 src/cmd/compile/internal/arm64/ssa.go              |   69 +-
 src/cmd/compile/internal/gc/alg.go                 |   89 +-
 src/cmd/compile/internal/gc/builtin.go             |  626 +++---
 src/cmd/compile/internal/gc/builtin/runtime.go     |    2 +
 src/cmd/compile/internal/gc/esc.go                 |   12 +-
 src/cmd/compile/internal/gc/fmt.go                 |  176 +-
 src/cmd/compile/internal/gc/gsubr.go               |    2 +-
 src/cmd/compile/internal/gc/noder.go               |    2 +-
 src/cmd/compile/internal/gc/op_string.go           |  161 +-
 src/cmd/compile/internal/gc/order.go               |   76 +-
 src/cmd/compile/internal/gc/pgen.go                |   25 +-
 src/cmd/compile/internal/gc/plive.go               |   14 +-
 .../compile/internal/gc/reproduciblebuilds_test.go |   50 +
 src/cmd/compile/internal/gc/ssa.go                 |   41 +-
 src/cmd/compile/internal/gc/subr.go                |    8 +-
 src/cmd/compile/internal/gc/syntax.go              |   60 +-
 .../gc/testdata/reproducible/issue38068.go         |   70 +
 src/cmd/compile/internal/gc/typecheck.go           |   50 +
 src/cmd/compile/internal/gc/walk.go                |   60 +
 src/cmd/compile/internal/ssa/check.go              |    5 +
 src/cmd/compile/internal/ssa/compile.go            |    3 +
 src/cmd/compile/internal/ssa/cse.go                |   38 +-
 src/cmd/compile/internal/ssa/deadstore.go          |   16 +-
 src/cmd/compile/internal/ssa/debug_test.go         |   20 +-
 src/cmd/compile/internal/ssa/flags_amd64_test.s    |   31 +
 src/cmd/compile/internal/ssa/flags_arm64_test.s    |   32 +
 src/cmd/compile/internal/ssa/flags_test.go         |  108 +
 src/cmd/compile/internal/ssa/gen/ARM.rules         |  368 ++--
 src/cmd/compile/internal/ssa/gen/ARM64.rules       |  284 +--
 src/cmd/compile/internal/ssa/gen/ARM64Ops.go       |   18 +-
 src/cmd/compile/internal/ssa/gen/ARMOps.go         |   18 +-
 src/cmd/compile/internal/ssa/gen/PPC64.rules       |   29 +-
 src/cmd/compile/internal/ssa/gen/PPC64Ops.go       |   24 +-
 src/cmd/compile/internal/ssa/gen/RISCV64.rules     |   32 +-
 src/cmd/compile/internal/ssa/gen/S390XOps.go       |   37 +-
 src/cmd/compile/internal/ssa/gen/rulegen.go        |    4 +-
 src/cmd/compile/internal/ssa/op.go                 |    1 +
 src/cmd/compile/internal/ssa/opGen.go              |  254 ++-
 src/cmd/compile/internal/ssa/prove.go              |   33 +-
 src/cmd/compile/internal/ssa/rewrite.go            |  255 ++-
 src/cmd/compile/internal/ssa/rewriteARM.go         | 1809 ++++++-----------
 src/cmd/compile/internal/ssa/rewriteARM64.go       | 1588 +++++----------
 src/cmd/compile/internal/ssa/rewriteCond_test.go   |  597 ++++++
 src/cmd/compile/internal/ssa/rewritePPC64.go       |   76 +-
 src/cmd/compile/internal/ssa/rewriteRISCV64.go     |  125 ++
 src/cmd/compile/internal/ssa/rewrite_test.go       |    9 +
 src/cmd/compile/internal/ssa/tuple.go              |   59 +
 src/cmd/compile/internal/ssa/value.go              |    2 +
 src/cmd/compile/internal/x86/ssa.go                |    8 +-
 src/cmd/dist/build.go                              |   11 -
 src/cmd/dist/buildruntime.go                       |    2 -
 src/cmd/dist/buildtool.go                          |    1 +
 src/cmd/dist/test.go                               |   21 +-
 src/cmd/fix/egltype.go                             |   28 +-
 src/cmd/fix/egltype_test.go                        |  141 +-
 src/cmd/go.mod                                     |    8 +-
 src/cmd/go.sum                                     |   16 +-
 src/cmd/go/alldocs.go                              |  114 +-
 src/cmd/go/go_test.go                              |   39 +-
 src/cmd/go/internal/cfg/cfg.go                     |    3 -
 src/cmd/go/internal/clean/clean.go                 |   25 +-
 src/cmd/go/internal/help/helpdoc.go                |  106 +-
 src/cmd/go/internal/load/pkg.go                    |   83 +-
 src/cmd/go/internal/load/test.go                   |    2 +-
 src/cmd/go/internal/modfetch/proxy.go              |   20 +-
 src/cmd/go/internal/modget/get.go                  |   12 +-
 src/cmd/go/internal/modload/import.go              |  104 +-
 src/cmd/go/internal/modload/load.go                |   38 +-
 src/cmd/go/internal/modload/mvs.go                 |    6 +
 src/cmd/go/internal/modload/query.go               |   51 +-
 src/cmd/go/internal/modload/search.go              |   44 +-
 src/cmd/go/internal/mvs/mvs.go                     |   23 +-
 src/cmd/go/internal/search/search.go               |   12 +-
 src/cmd/go/internal/test/test.go                   |   14 +-
 src/cmd/go/internal/test/testflag.go               |   17 +
 src/cmd/go/internal/web/http.go                    |    8 +
 src/cmd/go/internal/work/exec.go                   |   14 +-
 src/cmd/go/internal/work/gc.go                     |    2 +-
 src/cmd/go/internal/work/security.go               |    3 +
 src/cmd/go/internal/work/security_test.go          |    2 +
 src/cmd/go/note_test.go                            |    2 +-
 src/cmd/go/proxy_test.go                           |   19 +
 src/cmd/go/script_test.go                          |  284 ++-
 src/cmd/go/testdata/script/README                  |    6 +-
 src/cmd/go/testdata/script/build_trimpath.txt      |    4 +
 src/cmd/go/testdata/script/clean_cache_n.txt       |   25 +
 src/cmd/go/testdata/script/generate_env.txt        |    3 +-
 src/cmd/go/testdata/script/goroot_executable.txt   |    7 +
 src/cmd/go/testdata/script/issue36000.txt          |    6 +
 src/cmd/go/testdata/script/list_case_collision.txt |   10 +-
 src/cmd/go/testdata/script/list_dedup_packages.txt |    2 +-
 .../go/testdata/script/list_gofile_in_goroot.txt   |    3 +
 src/cmd/go/testdata/script/list_permissions.txt    |   84 +
 src/cmd/go/testdata/script/mod_convert_dep.txt     |    1 -
 .../testdata/script/mod_get_too_many_redirects.txt |   10 +
 src/cmd/go/testdata/script/mod_gomodcache.txt      |    3 +-
 src/cmd/go/testdata/script/mod_gonoproxy.txt       |   15 +-
 src/cmd/go/testdata/script/script_wait.txt         |    7 +-
 .../testdata/script/test_benchmark_chatty_fail.txt |   32 +
 .../script/test_benchmark_chatty_success.txt       |   29 +
 src/cmd/go/testdata/script/test_chatty_fail.txt    |   32 +
 .../testdata/script/test_chatty_parallel_fail.txt  |   58 +
 .../script/test_chatty_parallel_success.txt        |   52 +
 .../script/test_chatty_parallel_success_sleepy.txt |   39 +
 src/cmd/go/testdata/script/test_chatty_success.txt |   27 +
 src/cmd/go/testdata/script/test_flags.txt          |   14 +-
 src/cmd/go/testdata/script/test_regexps.txt        |   14 +-
 src/cmd/internal/goobj/goobj_test.go               |   19 +-
 src/cmd/internal/goobj/readnew.go                  |   19 +-
 src/cmd/internal/goobj2/objfile.go                 |   53 +
 src/cmd/internal/moddeps/moddeps_test.go           |    2 +-
 src/cmd/internal/obj/arm/a.out.go                  |    2 +-
 src/cmd/internal/obj/arm/asm5.go                   |    2 +-
 src/cmd/internal/obj/arm/list5.go                  |    2 +-
 src/cmd/internal/obj/arm/obj5.go                   |    2 +-
 src/cmd/internal/obj/arm64/asm7.go                 |   14 +-
 src/cmd/internal/obj/arm64/doc.go                  |    5 +-
 src/cmd/internal/obj/arm64/obj7.go                 |    9 +
 src/cmd/internal/obj/data.go                       |    4 +-
 src/cmd/internal/obj/ld.go                         |    4 +-
 src/cmd/internal/obj/link.go                       |    2 +-
 src/cmd/internal/obj/objfile.go                    |    8 +
 src/cmd/internal/obj/objfile2.go                   |   39 +
 src/cmd/internal/obj/pass.go                       |    2 +-
 src/cmd/internal/obj/ppc64/doc.go                  |   52 +-
 src/cmd/internal/obj/sym.go                        |    4 +-
 src/cmd/internal/obj/x86/a.out.go                  |    2 +-
 src/cmd/internal/obj/x86/asm6.go                   |    2 +-
 src/cmd/internal/obj/x86/list6.go                  |    2 +-
 src/cmd/internal/obj/x86/obj6.go                   |    2 +-
 src/cmd/internal/objabi/autotype.go                |    2 +-
 src/cmd/internal/objabi/head.go                    |    2 +-
 src/cmd/internal/objabi/reloctype.go               |    2 +-
 src/cmd/internal/objabi/symkind.go                 |    2 +-
 src/cmd/internal/objabi/util.go                    |   13 +-
 src/cmd/internal/test2json/test2json.go            |   12 +-
 .../internal/test2json/testdata/issue29755.json    |   38 +
 .../internal/test2json/testdata/issue29755.test    |   27 +
 src/cmd/internal/test2json/testdata/smiley.json    |   22 +-
 src/cmd/internal/test2json/testdata/smiley.test    |   22 +-
 src/cmd/internal/test2json/testdata/vet.json       |   22 +-
 src/cmd/internal/test2json/testdata/vet.test       |   22 +-
 src/cmd/link/dwarf_test.go                         |    4 +-
 src/cmd/link/internal/amd64/asm.go                 |    2 +-
 src/cmd/link/internal/amd64/l.go                   |    2 +-
 src/cmd/link/internal/amd64/obj.go                 |    2 +-
 src/cmd/link/internal/arm/asm.go                   |    8 +-
 src/cmd/link/internal/arm/l.go                     |    4 +-
 src/cmd/link/internal/arm/obj.go                   |    2 +-
 src/cmd/link/internal/arm64/asm.go                 |    2 +-
 src/cmd/link/internal/arm64/l.go                   |    2 +-
 src/cmd/link/internal/arm64/obj.go                 |    2 +-
 src/cmd/link/internal/ld/ar.go                     |    2 +-
 src/cmd/link/internal/ld/data.go                   |    8 +-
 src/cmd/link/internal/ld/decodesym.go              |   27 +-
 src/cmd/link/internal/ld/dwarf.go                  |   12 +
 src/cmd/link/internal/ld/dwarf_test.go             |  111 +
 src/cmd/link/internal/ld/fallocate_test.go         |   65 +
 src/cmd/link/internal/ld/ld.go                     |   11 +-
 src/cmd/link/internal/ld/lib.go                    |   33 +-
 src/cmd/link/internal/ld/link.go                   |    2 +-
 src/cmd/link/internal/ld/macho.go                  |    4 +-
 src/cmd/link/internal/ld/main.go                   |    2 +-
 src/cmd/link/internal/ld/outbuf.go                 |    1 -
 src/cmd/link/internal/ld/outbuf_darwin.go          |   20 +-
 src/cmd/link/internal/ld/outbuf_linux.go           |    2 +-
 src/cmd/link/internal/ld/outbuf_mmap.go            |    8 +-
 src/cmd/link/internal/ld/outbuf_windows.go         |    8 +-
 src/cmd/link/internal/ld/pcln.go                   |    2 +-
 src/cmd/link/internal/ld/pe.go                     |   13 +-
 src/cmd/link/internal/ld/sym.go                    |    4 +-
 src/cmd/link/internal/ld/symtab.go                 |    2 +-
 .../link/internal/ld/testdata/issue38192/main.go   |   11 +
 .../link/internal/ld/testdata/issue38192/oneline.s |    8 +
 src/cmd/link/internal/loader/loader.go             |   22 +-
 src/cmd/link/internal/mips/asm.go                  |    2 +-
 src/cmd/link/internal/mips/l.go                    |    2 +-
 src/cmd/link/internal/mips/obj.go                  |    2 +-
 src/cmd/link/internal/mips64/asm.go                |    2 +-
 src/cmd/link/internal/mips64/l.go                  |    2 +-
 src/cmd/link/internal/mips64/obj.go                |    2 +-
 src/cmd/link/internal/ppc64/asm.go                 |   17 +-
 src/cmd/link/internal/ppc64/l.go                   |    2 +-
 src/cmd/link/internal/ppc64/obj.go                 |    2 +-
 src/cmd/link/internal/s390x/asm.go                 |    2 +-
 src/cmd/link/internal/s390x/l.go                   |    2 +-
 src/cmd/link/internal/s390x/obj.go                 |    2 +-
 src/cmd/link/internal/sym/segment.go               |    2 +-
 src/cmd/link/internal/sym/symbols.go               |    2 +-
 src/cmd/link/internal/sym/symkind.go               |    2 +-
 src/cmd/link/internal/x86/asm.go                   |    2 +-
 src/cmd/link/internal/x86/l.go                     |    2 +-
 src/cmd/link/internal/x86/obj.go                   |    2 +-
 src/cmd/link/link_test.go                          |   53 +-
 src/cmd/link/testdata/testPErsrc/main.go           |   19 +
 src/cmd/link/testdata/testPErsrc/rsrc.syso         |  Bin 0 -> 228 bytes
 src/cmd/nm/nm_test.go                              |   10 +-
 src/cmd/objdump/objdump_test.go                    |   18 +-
 src/cmd/oldlink/internal/amd64/asm.go              |    2 +-
 src/cmd/oldlink/internal/amd64/l.go                |    2 +-
 src/cmd/oldlink/internal/amd64/obj.go              |    2 +-
 src/cmd/oldlink/internal/arm/asm.go                |    8 +-
 src/cmd/oldlink/internal/arm/l.go                  |    4 +-
 src/cmd/oldlink/internal/arm/obj.go                |    2 +-
 src/cmd/oldlink/internal/arm64/asm.go              |    2 +-
 src/cmd/oldlink/internal/arm64/l.go                |    2 +-
 src/cmd/oldlink/internal/arm64/obj.go              |    2 +-
 src/cmd/oldlink/internal/ld/ar.go                  |    2 +-
 src/cmd/oldlink/internal/ld/data.go                |    4 +-
 src/cmd/oldlink/internal/ld/decodesym.go           |   32 +-
 src/cmd/oldlink/internal/ld/ld.go                  |    4 +-
 src/cmd/oldlink/internal/ld/lib.go                 |    8 +-
 src/cmd/oldlink/internal/ld/link.go                |    2 +-
 src/cmd/oldlink/internal/ld/main.go                |    2 +-
 src/cmd/oldlink/internal/ld/pcln.go                |    2 +-
 src/cmd/oldlink/internal/ld/sym.go                 |    4 +-
 src/cmd/oldlink/internal/ld/symtab.go              |    2 +-
 src/cmd/oldlink/internal/mips/asm.go               |    2 +-
 src/cmd/oldlink/internal/mips/l.go                 |    2 +-
 src/cmd/oldlink/internal/mips/obj.go               |    2 +-
 src/cmd/oldlink/internal/mips64/asm.go             |    2 +-
 src/cmd/oldlink/internal/mips64/l.go               |    2 +-
 src/cmd/oldlink/internal/mips64/obj.go             |    2 +-
 src/cmd/oldlink/internal/objfile/objfile.go        |    6 +-
 src/cmd/oldlink/internal/ppc64/asm.go              |    8 +-
 src/cmd/oldlink/internal/ppc64/l.go                |    2 +-
 src/cmd/oldlink/internal/ppc64/obj.go              |    2 +-
 src/cmd/oldlink/internal/s390x/asm.go              |    2 +-
 src/cmd/oldlink/internal/s390x/l.go                |    2 +-
 src/cmd/oldlink/internal/s390x/obj.go              |    2 +-
 src/cmd/oldlink/internal/sym/attribute.go          |    6 +-
 src/cmd/oldlink/internal/sym/segment.go            |    2 +-
 src/cmd/oldlink/internal/sym/symbols.go            |    2 +-
 src/cmd/oldlink/internal/sym/symkind.go            |    2 +-
 src/cmd/oldlink/internal/x86/asm.go                |    2 +-
 src/cmd/oldlink/internal/x86/l.go                  |    2 +-
 src/cmd/oldlink/internal/x86/obj.go                |    2 +-
 .../vendor/golang.org/x/arch/ppc64/ppc64asm/gnu.go |   15 +
 .../golang.org/x/arch/ppc64/ppc64asm/plan9.go      |  165 +-
 .../golang.org/x/arch/ppc64/ppc64asm/tables.go     |  105 +
 .../vendor/golang.org/x/tools/go/analysis/doc.go   |    9 +
 .../x/tools/go/analysis/passes/printf/printf.go    |    1 +
 .../go/analysis/passes/stringintconv/string.go     |    2 +-
 .../x/tools/go/types/objectpath/objectpath.go      |    5 +-
 src/cmd/vendor/modules.txt                         |    8 +-
 src/container/list/list.go                         |    4 +-
 src/crypto/elliptic/elliptic.go                    |   70 +-
 src/crypto/elliptic/elliptic_test.go               |  147 +-
 src/crypto/hmac/hmac.go                            |   80 +-
 src/crypto/hmac/hmac_test.go                       |   13 +-
 src/crypto/tls/common.go                           |  298 ++-
 src/crypto/tls/conn.go                             |   48 +-
 src/crypto/tls/example_test.go                     |   79 +-
 src/crypto/tls/generate_cert.go                    |   12 +-
 src/crypto/tls/handshake_client.go                 |   82 +-
 src/crypto/tls/handshake_client_test.go            |  488 ++++-
 src/crypto/tls/handshake_client_tls13.go           |   13 +
 src/crypto/tls/handshake_messages_test.go          |    1 +
 src/crypto/tls/handshake_server.go                 |   85 +-
 src/crypto/tls/handshake_server_test.go            |   14 +-
 src/crypto/tls/handshake_server_tls13.go           |   17 +-
 .../testdata/Server-TLSv10-ExportKeyingMaterial    |   83 +-
 src/crypto/tls/testdata/Server-TLSv12-ALPN         |   83 +-
 src/crypto/tls/testdata/Server-TLSv12-ALPN-NoMatch |   83 +-
 .../testdata/Server-TLSv12-ExportKeyingMaterial    |   81 +-
 src/crypto/tls/testdata/Server-TLSv12-IssueTicket  |  167 +-
 .../testdata/Server-TLSv12-IssueTicketPreDisable   |  167 +-
 src/crypto/tls/testdata/Server-TLSv12-Resume       |   82 +-
 src/crypto/tls/ticket.go                           |   30 +-
 src/crypto/tls/tls.go                              |    2 +-
 src/crypto/tls/tls_test.go                         |   28 +-
 src/crypto/x509/cert_pool.go                       |   12 +-
 src/crypto/x509/internal/macOS/corefoundation.go   |  141 ++
 src/crypto/x509/internal/macOS/corefoundation.s    |   26 +
 src/crypto/x509/internal/macOS/security.go         |  116 ++
 src/crypto/x509/internal/macOS/security.s          |   16 +
 src/crypto/x509/root.go                            |    2 +
 ...root_cgo_darwin.go => root_cgo_darwin_amd64.go} |   12 +-
 src/crypto/x509/root_darwin.go                     |  288 ---
 src/crypto/x509/root_darwin_amd64.go               |  243 +++
 src/crypto/x509/root_darwin_arm_gen.go             |  184 --
 .../{root_darwin_arm64.go => root_darwin_ios.go}   | 2141 ++++++++++++++------
 src/crypto/x509/root_darwin_ios_gen.go             |  179 ++
 src/crypto/x509/root_darwin_test.go                |   98 +-
 src/crypto/x509/root_nocgo_darwin.go               |   11 -
 src/crypto/x509/root_omit.go                       |   10 +-
 src/crypto/x509/root_omit_test.go                  |    3 +-
 src/crypto/x509/root_unix_test.go                  |    5 +-
 src/crypto/x509/verify.go                          |   98 +-
 src/crypto/x509/verify_test.go                     |   43 +-
 src/crypto/x509/x509.go                            |   22 +-
 src/crypto/x509/x509_test.go                       |  132 +-
 src/database/sql/driver/driver.go                  |    2 +-
 src/database/sql/sql.go                            |    5 +-
 src/encoding/asn1/asn1.go                          |   12 +
 src/encoding/asn1/asn1_test.go                     |   12 +
 src/encoding/asn1/marshal.go                       |   56 +
 src/encoding/asn1/marshal_test.go                  |   57 +
 src/encoding/json/decode.go                        |   69 +-
 src/encoding/json/decode_test.go                   |   49 +-
 src/encoding/json/encode.go                        |   11 +-
 src/encoding/json/encode_test.go                   |   87 +-
 src/encoding/json/stream_test.go                   |    8 +-
 src/encoding/xml/marshal.go                        |   23 +-
 src/encoding/xml/marshal_test.go                   |   41 +-
 src/encoding/xml/read.go                           |   16 +-
 src/encoding/xml/typeinfo.go                       |   16 +-
 src/go.mod                                         |    4 +-
 src/go.sum                                         |    8 +-
 src/go/build/build.go                              |    3 +-
 src/go/build/build_test.go                         |    9 +
 src/go/build/deps_test.go                          | 1137 ++++++-----
 src/go/build/doc.go                                |   98 +-
 src/go/internal/srcimporter/srcimporter.go         |    6 +-
 src/go/internal/srcimporter/srcimporter_test.go    |   10 +
 src/go/token/position.go                           |   23 +-
 src/go/types/api.go                                |   10 +-
 src/go/types/check.go                              |    4 +-
 src/go/types/resolver.go                           |    4 +-
 src/html/template/html.go                          |    3 +-
 src/image/gif/writer_test.go                       |    7 +-
 src/image/png/reader.go                            |    5 +-
 src/internal/cfg/cfg.go                            |    1 -
 src/internal/poll/copy_file_range_linux.go         |    8 +-
 src/internal/poll/fd_plan9.go                      |   29 +-
 src/internal/poll/fd_unix.go                       |   61 +-
 src/internal/poll/fd_writev_unix.go                |   13 +-
 src/internal/poll/sendfile_bsd.go                  |    3 +
 src/internal/poll/sendfile_linux.go                |    3 +
 src/internal/poll/splice_linux.go                  |    3 +
 src/internal/poll/writev.go                        |    5 +-
 src/internal/trace/writer.go                       |    4 +
 src/io/ioutil/ioutil.go                            |    2 +-
 src/make.bat                                       |  305 ++-
 src/math/big/link_test.go                          |    7 +-
 src/math/exp_amd64.s                               |    2 +-
 src/net/http/cgi/host.go                           |    7 +-
 src/net/http/fs.go                                 |   13 +-
 src/net/http/fs_test.go                            |    9 +
 src/net/http/httptest/recorder.go                  |    4 +-
 src/net/http/httptest/recorder_test.go             |   36 +
 src/net/http/pprof/pprof.go                        |   10 +-
 src/net/http/request.go                            |    4 +-
 src/net/http/server.go                             |    6 +-
 src/net/http/transfer.go                           |   16 +-
 src/net/http/transfer_test.go                      |   36 +
 src/net/http/transport.go                          |   66 +-
 src/net/http/transport_test.go                     |   51 +-
 src/net/interface_plan9.go                         |    4 +-
 src/net/ipsock_plan9.go                            |   32 +-
 src/net/net.go                                     |   34 +-
 src/net/rpc/client.go                              |    2 +-
 src/net/sockopt_aix.go                             |    7 +-
 src/net/sockopt_bsd.go                             |    7 +-
 src/net/sockopt_linux.go                           |    7 +-
 src/net/sockopt_solaris.go                         |    7 +-
 src/net/sockopt_windows.go                         |    6 +-
 src/os/exec_unix.go                                |   15 +-
 src/os/file.go                                     |    2 +-
 src/os/file_plan9.go                               |    4 +-
 src/os/file_unix.go                                |    6 +-
 src/os/file_windows.go                             |   14 +-
 src/os/os_test.go                                  |   31 +
 src/os/os_windows_test.go                          |  119 +-
 src/os/readfrom_linux_test.go                      |    5 +-
 src/os/removeall_at.go                             |    3 +-
 src/os/signal/internal/pty/pty.go                  |    8 +-
 src/os/signal/signal_cgo_test.go                   |   44 +-
 src/os/wait_wait6.go                               |   23 +-
 src/os/wait_waitid.go                              |    8 +-
 src/path/filepath/match.go                         |    6 +-
 src/race.bat                                       |  102 +-
 src/reflect/all_test.go                            |    6 +
 src/reflect/deepequal.go                           |   16 +-
 src/reflect/type.go                                |    1 +
 src/reflect/value.go                               |    8 +
 src/regexp/syntax/compile.go                       |   68 +-
 src/run.bat                                        |  113 +-
 src/runtime/cgo/gcc_android.c                      |    2 +-
 src/runtime/cgo_sigaction.go                       |   10 +-
 src/runtime/crash_cgo_test.go                      |   27 +
 src/runtime/crash_test.go                          |   14 +-
 src/runtime/debugcall.go                           |    2 +-
 src/runtime/env_plan9.go                           |  136 +-
 src/runtime/env_posix.go                           |    2 +-
 src/runtime/env_test.go                            |    4 -
 src/runtime/export_test.go                         |   25 +-
 src/runtime/extern.go                              |    9 +-
 src/runtime/gc_test.go                             |   10 +
 src/runtime/hash_test.go                           |    8 +-
 src/runtime/lock_futex.go                          |    6 +-
 src/runtime/lock_js.go                             |   13 +-
 src/runtime/lock_sema.go                           |    6 +-
 src/runtime/lockrank.go                            |   60 +-
 src/runtime/lockrank_off.go                        |   12 +-
 src/runtime/lockrank_on.go                         |  104 +-
 src/runtime/malloc.go                              |   33 +-
 src/runtime/memclr_arm.s                           |    2 +-
 src/runtime/memmove_386.s                          |    2 +-
 src/runtime/memmove_amd64.s                        |    2 +-
 src/runtime/memmove_arm.s                          |    2 +-
 src/runtime/memmove_plan9_386.s                    |    2 +-
 src/runtime/memmove_plan9_amd64.s                  |    2 +-
 src/runtime/mgcmark.go                             |   14 +-
 src/runtime/mgcscavenge.go                         |  343 ++--
 src/runtime/mgcscavenge_test.go                    |    6 +-
 src/runtime/mgcsweep.go                            |   78 +-
 src/runtime/mheap.go                               |   48 +-
 src/runtime/mpagealloc.go                          |  181 +-
 src/runtime/mpagealloc_64bit.go                    |   12 +-
 src/runtime/mpagecache.go                          |   12 +-
 src/runtime/mranges.go                             |  186 +-
 src/runtime/mstats.go                              |    2 +-
 src/runtime/mwbbuf.go                              |    7 +
 src/runtime/netpoll_stub.go                        |    3 +
 src/runtime/os_plan9.go                            |    7 +-
 src/runtime/proc.go                                |   65 +-
 src/runtime/proc_test.go                           |   24 +
 src/runtime/rt0_openbsd_arm64.s                    |    8 +-
 src/runtime/runtime-gdb.py                         |   18 +-
 src/runtime/runtime-gdb_test.go                    |  105 +-
 src/runtime/runtime2.go                            |   28 +-
 src/runtime/signal_unix.go                         |    6 +-
 src/runtime/sizeof_test.go                         |    3 +-
 src/runtime/slice.go                               |   49 +
 src/runtime/slice_test.go                          |   78 +
 src/runtime/stack.go                               |   23 +-
 src/runtime/stubs.go                               |    2 +-
 src/runtime/symtab.go                              |    4 +-
 src/runtime/sys_darwin.go                          |   17 +-
 src/runtime/sys_darwin_amd64.s                     |   26 +
 src/runtime/sys_openbsd_arm.s                      |   80 +-
 src/runtime/sys_openbsd_arm64.s                    |   75 +-
 src/runtime/testdata/testprog/gc.go                |   36 +
 src/runtime/testdata/testprog/lockosthread.go      |   49 +
 src/runtime/testdata/testprog/numcpu_freebsd.go    |    8 +-
 src/runtime/testdata/testprogcgo/eintr.go          |  246 +++
 src/runtime/trace.go                               |   12 +
 src/runtime/trace/trace.go                         |    2 +-
 src/runtime/trace/trace_stack_test.go              |    1 +
 src/runtime/vlop_386.s                             |    2 +-
 src/runtime/vlop_arm.s                             |    2 +-
 src/runtime/vlrt.go                                |    2 +-
 src/strconv/atoc.go                                |  105 +
 src/strconv/atoc_test.go                           |  202 ++
 src/strconv/atof.go                                |    6 +-
 src/strconv/atof_test.go                           |    2 +-
 src/strconv/atoi.go                                |    2 +-
 src/strconv/ctoa.go                                |   27 +
 src/syscall/asm_openbsd_arm.s                      |   17 +-
 src/syscall/asm_openbsd_arm64.s                    |   16 +-
 src/syscall/dll_windows.go                         |   11 +-
 src/syscall/env_plan9.go                           |  122 --
 src/syscall/env_unix.go                            |   16 +-
 src/syscall/exec_linux_test.go                     |    6 +-
 src/syscall/exec_unix.go                           |    7 +-
 src/syscall/js/func.go                             |    3 +-
 src/syscall/js/js_test.go                          |   11 +
 src/syscall/syscall_dup2_linux.go                  |   10 +
 src/syscall/syscall_dup3_linux.go                  |    9 +
 src/syscall/syscall_linux.go                       |   16 +-
 src/syscall/syscall_linux_386.go                   |    5 +-
 src/syscall/syscall_linux_amd64.go                 |    5 +-
 src/syscall/syscall_linux_arm.go                   |    5 +-
 src/syscall/syscall_linux_arm64.go                 |    5 +-
 src/syscall/syscall_linux_mips64x.go               |    5 +-
 src/syscall/syscall_linux_mipsx.go                 |    5 +-
 src/syscall/syscall_linux_ppc64x.go                |    5 +-
 src/syscall/syscall_linux_riscv64.go               |    5 +-
 src/syscall/syscall_linux_s390x.go                 |    5 +-
 src/syscall/syscall_linux_test.go                  |    9 +-
 src/syscall/syscall_windows.go                     |   20 +
 src/testing/benchmark.go                           |    3 +
 src/testing/sub_test.go                            |  126 +-
 src/testing/testing.go                             |  104 +-
 src/testing/testing_test.go                        |    8 +-
 src/text/template/link_test.go                     |    2 +-
 src/text/template/parse/node.go                    |    2 +-
 src/time/example_test.go                           |    9 +-
 src/time/format.go                                 |    2 +-
 src/vendor/golang.org/x/crypto/cryptobyte/asn1.go  |    4 +-
 .../golang.org/x/net/dns/dnsmessage/message.go     |    3 +-
 src/vendor/modules.txt                             |    4 +-
 test/codegen/arithmetic.go                         |   11 +
 test/codegen/comparisons.go                        |  159 ++
 test/codegen/slices.go                             |  183 ++
 test/fixedbugs/issue25727.go                       |    8 +-
 test/fixedbugs/issue31053.dir/f1.go                |   18 +
 test/fixedbugs/issue31053.dir/main.go              |   42 +
 test/fixedbugs/issue31053.go                       |    7 +
 test/fixedbugs/issue36437.go                       |   49 +
 test/fixedbugs/issue37246.go                       |   23 +
 test/fixedbugs/issue38093.go                       |   49 +
 test/fixedbugs/issue38916.go                       |   14 +
 test/fixedbugs/issue39459.go                       |   22 +
 test/fixedbugs/issue39472.go                       |   12 +
 test/fixedbugs/issue39541.go                       |   33 +
 test/fixedbugs/issue39651.go                       |   26 +
 test/fixedbugs/issue8606.go                        |   93 +
 test/makeslice.go                                  |  149 ++
 test/prove.go                                      |   64 +
 test/winbatch.go                                   |   54 +-
 544 files changed, 17011 insertions(+), 8741 deletions(-)

diff --cc src/go/build/deps_test.go
index b8be271707,bd0ebce1c7..62d6e6296b
--- a/src/go/build/deps_test.go
+++ b/src/go/build/deps_test.go
@@@ -20,481 -20,470 +20,471 @@@ import 
  	"testing"
  )
  
- // pkgDeps defines the expected dependencies between packages in
+ // depsRules defines the expected dependencies between packages in
  // the Go source tree. It is a statement of policy.
- // Changes should not be made to this map without prior discussion.
- //
- // The map contains two kinds of entries:
- // 1) Lower-case keys are standard import paths and list the
- // allowed imports in that package.
- // 2) Upper-case keys define aliases for package sets, which can then
- // be used as dependencies by other rules.
  //
  // DO NOT CHANGE THIS DATA TO FIX BUILDS.
+ // Existing packages should not have their constraints relaxed
+ // without prior discussion.
+ // Negative assertions should almost never be removed.
  //
- var pkgDeps = map[string][]string{
- 	// L0 is the lowest level, core, nearly unavoidable packages.
- 	"errors":                  {"runtime", "internal/reflectlite"},
- 	"io":                      {"errors", "sync", "sync/atomic"},
- 	"runtime":                 {"unsafe", "runtime/internal/atomic", "runtime/internal/sys", "runtime/internal/math", "internal/cpu", "internal/bytealg"},
- 	"runtime/internal/sys":    {},
- 	"runtime/internal/atomic": {"unsafe", "internal/cpu"},
- 	"runtime/internal/math":   {"runtime/internal/sys"},
- 	"internal/race":           {"runtime", "unsafe"},
- 	"sync":                    {"internal/race", "runtime", "sync/atomic", "unsafe"},
- 	"sync/atomic":             {"unsafe"},
- 	"unsafe":                  {},
- 	"internal/cpu":            {},
- 	"internal/bytealg":        {"unsafe", "internal/cpu"},
- 	"internal/reflectlite":    {"runtime", "unsafe", "internal/unsafeheader"},
- 	"internal/unsafeheader":   {"unsafe"},
- 
- 	"L0": {
- 		"errors",
- 		"io",
- 		"runtime",
- 		"runtime/internal/atomic",
- 		"sync",
- 		"sync/atomic",
- 		"unsafe",
- 		"internal/cpu",
- 		"internal/bytealg",
- 		"internal/reflectlite",
- 	},
- 
- 	// L1 adds simple functions and strings processing,
- 	// but not Unicode tables.
- 	"math":          {"internal/cpu", "unsafe", "math/bits"},
- 	"math/bits":     {"unsafe"},
- 	"math/cmplx":    {"math", "math/bits"},
- 	"math/rand":     {"L0", "math"},
- 	"strconv":       {"L0", "unicode/utf8", "math", "math/bits"},
- 	"unicode/utf16": {},
- 	"unicode/utf8":  {},
- 
- 	"L1": {
- 		"L0",
- 		"math",
- 		"math/bits",
- 		"math/cmplx",
- 		"math/rand",
- 		"sort",
- 		"strconv",
- 		"unicode/utf16",
- 		"unicode/utf8",
- 	},
- 
- 	// L2 adds Unicode and strings processing.
- 	"bufio":   {"L0", "unicode/utf8", "bytes", "strings"},
- 	"bytes":   {"L0", "unicode", "unicode/utf8"},
- 	"path":    {"L0", "unicode/utf8", "strings"},
- 	"strings": {"L0", "unicode", "unicode/utf8"},
- 	"unicode": {},
- 
- 	"L2": {
- 		"L1",
- 		"bufio",
- 		"bytes",
- 		"path",
- 		"strings",
- 		"unicode",
- 	},
- 
- 	// L3 adds reflection and some basic utility packages
- 	// and interface definitions, but nothing that makes
- 	// system calls.
- 	"crypto":                 {"L2", "hash"}, // interfaces
- 	"crypto/cipher":          {"L2", "crypto/subtle", "crypto/internal/subtle", "encoding/binary"},
- 	"crypto/internal/subtle": {"unsafe", "reflect"}, // reflect behind a appengine tag
- 	"crypto/subtle":          {},
- 	"encoding/base32":        {"L2"},
- 	"encoding/base64":        {"L2", "encoding/binary"},
- 	"encoding/binary":        {"L2", "reflect"},
- 	"hash":                   {"L2"}, // interfaces
- 	"hash/adler32":           {"L2", "hash"},
- 	"hash/crc32":             {"L2", "hash"},
- 	"hash/crc64":             {"L2", "hash"},
- 	"hash/fnv":               {"L2", "hash"},
- 	"hash/maphash":           {"L2", "hash"},
- 	"image":                  {"L2", "image/color"}, // interfaces
- 	"image/color":            {"L2"},                // interfaces
- 	"image/color/palette":    {"L2", "image/color"},
- 	"internal/fmtsort":       {"reflect", "sort"},
- 	"reflect":                {"L2", "internal/unsafeheader"},
- 	"sort":                   {"internal/reflectlite"},
- 
- 	"crypto/internal/boring":         {"L2", "C", "crypto", "crypto/cipher", "crypto/internal/boring/sig", "crypto/subtle", "encoding/asn1", "hash", "math/big"},
- 	"crypto/internal/boring/fipstls": {"sync/atomic"},
- 	"crypto/internal/cipherhw":       {"crypto/internal/boring"},
- 	"crypto/tls/fipsonly":            {"crypto/internal/boring/fipstls", "crypto/internal/boring/sig"},
- 
- 	"L3": {
- 		"L2",
- 		"crypto",
- 		"crypto/cipher",
- 		"crypto/internal/boring",
- 		"crypto/internal/boring/fipstls",
- 		"crypto/internal/subtle",
- 		"crypto/subtle",
- 		"encoding/base32",
- 		"encoding/base64",
- 		"encoding/binary",
- 		"hash",
- 		"hash/adler32",
- 		"hash/crc32",
- 		"hash/crc64",
- 		"hash/fnv",
- 		"image",
- 		"image/color",
- 		"image/color/palette",
- 		"internal/fmtsort",
- 		"internal/oserror",
- 		"reflect",
- 	},
- 
- 	// End of linear dependency definitions.
- 
- 	// Operating system access.
- 	"syscall":                           {"L0", "internal/oserror", "internal/race", "internal/syscall/windows/sysdll", "internal/unsafeheader", "syscall/js", "unicode/utf16"},
- 	"syscall/js":                        {"L0"},
- 	"internal/oserror":                  {"L0"},
- 	"internal/syscall/unix":             {"L0", "syscall"},
- 	"internal/syscall/windows":          {"L0", "syscall", "internal/syscall/windows/sysdll", "internal/unsafeheader", "unicode/utf16"},
- 	"internal/syscall/windows/registry": {"L0", "syscall", "internal/syscall/windows/sysdll", "unicode/utf16"},
- 	"internal/syscall/execenv":          {"L0", "syscall", "internal/syscall/windows", "unicode/utf16"},
- 	"time": {
- 		// "L0" without the "io" package:
- 		"errors",
- 		"runtime",
- 		"runtime/internal/atomic",
- 		"sync",
- 		"sync/atomic",
- 		"unsafe",
- 		// Other time dependencies:
- 		"internal/syscall/windows/registry",
- 		"syscall",
- 		"syscall/js",
- 		"time/tzdata",
- 	},
- 	"time/tzdata": {"L0", "syscall"},
- 
- 	"internal/cfg":     {"L0"},
- 	"internal/poll":    {"L0", "internal/oserror", "internal/race", "syscall", "time", "unicode/utf16", "unicode/utf8", "internal/syscall/windows", "internal/syscall/unix"},
- 	"internal/testlog": {"L0"},
- 	"os":               {"L1", "os", "syscall", "time", "internal/oserror", "internal/poll", "internal/syscall/windows", "internal/syscall/unix", "internal/syscall/execenv", "internal/testlog"},
- 	"path/filepath":    {"L2", "os", "syscall", "internal/syscall/windows"},
- 	"io/ioutil":        {"L2", "os", "path/filepath", "time"},
- 	"os/exec":          {"L2", "os", "context", "path/filepath", "syscall", "internal/syscall/execenv"},
- 	"os/signal":        {"L2", "os", "syscall"},
- 
- 	// OS enables basic operating system functionality,
- 	// but not direct use of package syscall, nor os/signal.
- 	"OS": {
- 		"io/ioutil",
- 		"os",
- 		"os/exec",
- 		"path/filepath",
- 		"time",
- 	},
- 
- 	// Formatted I/O: few dependencies (L1) but we must add reflect and internal/fmtsort.
- 	"fmt": {"L1", "os", "reflect", "internal/fmtsort"},
- 	"log": {"L1", "os", "fmt", "time"},
- 
- 	// Packages used by testing must be low-level (L2+fmt).
- 	"regexp":         {"L2", "regexp/syntax"},
- 	"regexp/syntax":  {"L2"},
- 	"runtime/debug":  {"L2", "fmt", "io/ioutil", "os", "time"},
- 	"runtime/pprof":  {"L2", "compress/gzip", "context", "encoding/binary", "fmt", "io/ioutil", "os", "syscall", "text/tabwriter", "time"},
- 	"runtime/trace":  {"L0", "context", "fmt"},
- 	"text/tabwriter": {"L2"},
- 
- 	"testing":                  {"L2", "flag", "fmt", "internal/race", "io/ioutil", "os", "runtime/debug", "runtime/pprof", "runtime/trace", "time"},
- 	"testing/iotest":           {"L2", "log"},
- 	"testing/quick":            {"L2", "flag", "fmt", "reflect", "time"},
- 	"internal/obscuretestdata": {"L2", "OS", "encoding/base64"},
- 	"internal/testenv":         {"L2", "OS", "flag", "testing", "syscall", "internal/cfg"},
- 	"internal/lazyregexp":      {"L2", "OS", "regexp"},
- 	"internal/lazytemplate":    {"L2", "OS", "text/template"},
- 
- 	// L4 is defined as L3+fmt+log+time, because in general once
- 	// you're using L3 packages, use of fmt, log, or time is not a big deal.
- 	"L4": {
- 		"L3",
- 		"fmt",
- 		"log",
- 		"time",
- 	},
- 
- 	// Go parser.
- 	"go/ast":     {"L4", "OS", "go/scanner", "go/token"},
- 	"go/doc":     {"L4", "OS", "go/ast", "go/token", "regexp", "internal/lazyregexp", "text/template"},
- 	"go/parser":  {"L4", "OS", "go/ast", "go/scanner", "go/token"},
- 	"go/printer": {"L4", "OS", "go/ast", "go/scanner", "go/token", "text/tabwriter"},
- 	"go/scanner": {"L4", "OS", "go/token"},
- 	"go/token":   {"L4"},
- 
- 	"GOPARSER": {
- 		"go/ast",
- 		"go/doc",
- 		"go/parser",
- 		"go/printer",
- 		"go/scanner",
- 		"go/token",
- 	},
- 
- 	"go/format":       {"L4", "GOPARSER", "internal/format"},
- 	"internal/format": {"L4", "GOPARSER"},
- 
- 	// Go type checking.
- 	"go/constant":               {"L4", "go/token", "math/big"},
- 	"go/importer":               {"L4", "go/build", "go/internal/gccgoimporter", "go/internal/gcimporter", "go/internal/srcimporter", "go/token", "go/types"},
- 	"go/internal/gcimporter":    {"L4", "OS", "go/build", "go/constant", "go/token", "go/types", "text/scanner"},
- 	"go/internal/gccgoimporter": {"L4", "OS", "debug/elf", "go/constant", "go/token", "go/types", "internal/xcoff", "text/scanner"},
- 	"go/internal/srcimporter":   {"L4", "OS", "fmt", "go/ast", "go/build", "go/parser", "go/token", "go/types", "path/filepath"},
- 	"go/types":                  {"L4", "GOPARSER", "container/heap", "go/constant"},
- 
- 	// One of a kind.
- 	"archive/tar":               {"L4", "OS", "syscall", "os/user"},
- 	"archive/zip":               {"L4", "OS", "compress/flate"},
- 	"container/heap":            {"sort"},
- 	"compress/bzip2":            {"L4"},
- 	"compress/flate":            {"L4"},
- 	"compress/gzip":             {"L4", "compress/flate"},
- 	"compress/lzw":              {"L4"},
- 	"compress/zlib":             {"L4", "compress/flate"},
- 	"context":                   {"errors", "internal/reflectlite", "sync", "sync/atomic", "time"},
- 	"database/sql":              {"L4", "container/list", "context", "database/sql/driver", "database/sql/internal"},
- 	"database/sql/driver":       {"L4", "context", "time", "database/sql/internal"},
- 	"debug/dwarf":               {"L4"},
- 	"debug/elf":                 {"L4", "OS", "debug/dwarf", "compress/zlib"},
- 	"debug/gosym":               {"L4"},
- 	"debug/macho":               {"L4", "OS", "debug/dwarf", "compress/zlib"},
- 	"debug/pe":                  {"L4", "OS", "debug/dwarf", "compress/zlib"},
- 	"debug/plan9obj":            {"L4", "OS"},
- 	"encoding":                  {"L4"},
- 	"encoding/ascii85":          {"L4"},
- 	"encoding/asn1":             {"L4", "math/big"},
- 	"encoding/csv":              {"L4"},
- 	"encoding/gob":              {"L4", "OS", "encoding"},
- 	"encoding/hex":              {"L4"},
- 	"encoding/json":             {"L4", "encoding"},
- 	"encoding/pem":              {"L4"},
- 	"encoding/xml":              {"L4", "encoding"},
- 	"flag":                      {"L4", "OS"},
- 	"go/build":                  {"L4", "OS", "GOPARSER", "internal/goroot", "internal/goversion"},
- 	"html":                      {"L4"},
- 	"image/draw":                {"L4", "image/internal/imageutil"},
- 	"image/gif":                 {"L4", "compress/lzw", "image/color/palette", "image/draw"},
- 	"image/internal/imageutil":  {"L4"},
- 	"image/jpeg":                {"L4", "image/internal/imageutil"},
- 	"image/png":                 {"L4", "compress/zlib"},
- 	"index/suffixarray":         {"L4", "regexp"},
- 	"internal/goroot":           {"L4", "OS"},
- 	"internal/singleflight":     {"sync"},
- 	"internal/trace":            {"L4", "OS", "container/heap"},
- 	"internal/xcoff":            {"L4", "OS", "debug/dwarf"},
- 	"math/big":                  {"L4"},
- 	"mime":                      {"L4", "OS", "syscall", "internal/syscall/windows/registry"},
- 	"mime/quotedprintable":      {"L4"},
- 	"net/internal/socktest":     {"L4", "OS", "syscall", "internal/syscall/windows"},
- 	"net/url":                   {"L4"},
- 	"plugin":                    {"L0", "OS", "CGO"},
- 	"internal/profile":          {"L4", "OS", "compress/gzip", "regexp"},
- 	"testing/internal/testdeps": {"L4", "internal/testlog", "runtime/pprof", "regexp"},
- 	"text/scanner":              {"L4", "OS"},
- 	"text/template/parse":       {"L4"},
- 
- 	"html/template": {
- 		"L4", "OS", "encoding/json", "html", "text/template",
- 		"text/template/parse",
- 	},
- 	"text/template": {
- 		"L4", "OS", "net/url", "text/template/parse",
- 	},
- 
- 	// Cgo.
- 	// If you add a dependency on CGO, you must add the package to
- 	// cgoPackages in cmd/dist/test.go.
- 	"runtime/cgo": {"L0", "C"},
- 	"CGO":         {"C", "runtime/cgo"},
- 
- 	// Fake entry to satisfy the pseudo-import "C"
- 	// that shows up in programs that use cgo.
- 	"C": {},
- 
- 	// Race detector/MSan uses cgo.
- 	"runtime/race": {"C"},
- 	"runtime/msan": {"C"},
- 
- 	// Plan 9 alone needs io/ioutil and os.
- 	"os/user": {"L4", "CGO", "io/ioutil", "os", "syscall", "internal/syscall/windows", "internal/syscall/windows/registry"},
- 
- 	// Internal package used only for testing.
- 	"os/signal/internal/pty": {"CGO", "fmt", "os", "syscall"},
- 
- 	// Basic networking.
- 	// Because net must be used by any package that wants to
- 	// do networking portably, it must have a small dependency set: just L0+basic os.
- 	"net": {
- 		"L0", "CGO",
- 		"context", "math/rand", "os", "sort", "syscall", "time",
- 		"internal/nettrace", "internal/poll", "internal/syscall/unix",
- 		"internal/syscall/windows", "internal/singleflight", "internal/race",
- 		"golang.org/x/net/dns/dnsmessage", "golang.org/x/net/lif", "golang.org/x/net/route",
- 	},
- 
- 	// NET enables use of basic network-related packages.
- 	"NET": {
- 		"net",
- 		"mime",
- 		"net/textproto",
- 		"net/url",
- 	},
- 
- 	// Uses of networking.
- 	"log/syslog":    {"L4", "OS", "net"},
- 	"net/mail":      {"L4", "NET", "OS", "mime"},
- 	"net/textproto": {"L4", "OS", "net"},
- 
- 	// Core crypto.
- 	"crypto/aes":               {"L3"},
- 	"crypto/des":               {"L3"},
- 	"crypto/hmac":              {"L3"},
- 	"crypto/internal/randutil": {"io", "sync"},
- 	"crypto/md5":               {"L3"},
- 	"crypto/rc4":               {"L3"},
- 	"crypto/sha1":              {"L3"},
- 	"crypto/sha256":            {"L3"},
- 	"crypto/sha512":            {"L3"},
- 
- 	"CRYPTO": {
- 		"crypto/aes",
- 		"crypto/des",
- 		"crypto/hmac",
- 		"crypto/internal/randutil",
- 		"crypto/md5",
- 		"crypto/rc4",
- 		"crypto/sha1",
- 		"crypto/sha256",
- 		"crypto/sha512",
- 		"golang.org/x/crypto/chacha20poly1305",
- 		"golang.org/x/crypto/curve25519",
- 		"golang.org/x/crypto/poly1305",
- 	},
- 
- 	// Random byte, number generation.
- 	// This would be part of core crypto except that it imports
- 	// math/big, which imports fmt.
- 	"crypto/rand": {"L4", "CRYPTO", "OS", "math/big", "syscall", "syscall/js", "internal/syscall/unix"},
- 
- 	// Not part of CRYPTO because it imports crypto/rand and crypto/sha512.
- 	"crypto/ed25519":                       {"L3", "CRYPTO", "crypto/rand", "crypto/ed25519/internal/edwards25519"},
- 	"crypto/ed25519/internal/edwards25519": {"encoding/binary"},
- 
- 	// Mathematical crypto: dependencies on fmt (L4) and math/big.
- 	// We could avoid some of the fmt, but math/big imports fmt anyway.
- 	"crypto/dsa": {"L4", "CRYPTO", "math/big"},
- 	"crypto/ecdsa": {
- 		"L4", "CRYPTO", "crypto/elliptic", "math/big",
- 		"golang.org/x/crypto/cryptobyte", "golang.org/x/crypto/cryptobyte/asn1",
- 	},
- 	"crypto/elliptic": {"L4", "CRYPTO", "math/big"},
- 	"crypto/rsa":      {"L4", "CRYPTO", "crypto/rand", "math/big"},
- 
- 	"CRYPTO-MATH": {
- 		"CRYPTO",
- 		"crypto/dsa",
- 		"crypto/ecdsa",
- 		"crypto/elliptic",
- 		"crypto/rand",
- 		"crypto/rsa",
- 		"encoding/asn1",
- 		"math/big",
- 	},
- 
- 	// SSL/TLS.
- 	"crypto/tls": {
- 		"L4", "CRYPTO-MATH", "OS", "golang.org/x/crypto/cryptobyte", "golang.org/x/crypto/hkdf",
- 		"container/list", "context", "crypto/x509", "encoding/pem", "net", "syscall", "crypto/ed25519",
- 	},
- 	"crypto/x509": {
- 		"L4", "CRYPTO-MATH", "OS", "CGO", "crypto/ed25519",
- 		"crypto/x509/pkix", "encoding/pem", "encoding/hex", "net", "os/user", "syscall", "net/url",
- 		"golang.org/x/crypto/cryptobyte", "golang.org/x/crypto/cryptobyte/asn1",
- 	},
- 	"crypto/x509/pkix": {"L4", "CRYPTO-MATH", "encoding/hex"},
- 
- 	// Simple net+crypto-aware packages.
- 	"mime/multipart": {"L4", "OS", "mime", "crypto/rand", "net/textproto", "mime/quotedprintable"},
- 	"net/smtp":       {"L4", "CRYPTO", "NET", "crypto/tls"},
- 
- 	// HTTP, kingpin of dependencies.
- 	"net/http": {
- 		"L4", "NET", "OS",
- 		"compress/gzip",
- 		"container/list",
- 		"context",
- 		"crypto/rand",
- 		"crypto/tls",
- 		"golang.org/x/net/http/httpguts",
- 		"golang.org/x/net/http/httpproxy",
- 		"golang.org/x/net/http2/hpack",
- 		"golang.org/x/net/idna",
- 		"golang.org/x/text/unicode/norm",
- 		"golang.org/x/text/width",
- 		"internal/nettrace",
- 		"mime/multipart",
- 		"net/http/httptrace",
- 		"net/http/internal",
- 		"runtime/debug",
- 		"syscall/js",
- 	},
- 	"net/http/internal":  {"L4"},
- 	"net/http/httptrace": {"context", "crypto/tls", "internal/nettrace", "net", "net/textproto", "reflect", "time"},
- 
- 	// HTTP-using packages.
- 	"expvar":             {"L4", "OS", "encoding/json", "net/http"},
- 	"net/http/cgi":       {"L4", "NET", "OS", "crypto/tls", "net/http", "regexp"},
- 	"net/http/cookiejar": {"L4", "NET", "net/http"},
- 	"net/http/fcgi":      {"L4", "NET", "OS", "context", "net/http", "net/http/cgi"},
- 	"net/http/httptest": {
- 		"L4", "NET", "OS", "crypto/tls", "flag", "net/http", "net/http/internal", "crypto/x509",
- 		"golang.org/x/net/http/httpguts",
- 	},
- 	"net/http/httputil": {"L4", "NET", "OS", "context", "net/http", "net/http/internal", "golang.org/x/net/http/httpguts"},
- 	"net/http/pprof":    {"L4", "OS", "context", "html/template", "net/http", "runtime/pprof", "runtime/trace", "internal/profile"},
- 	"net/rpc":           {"L4", "NET", "encoding/gob", "html/template", "net/http", "go/token"},
- 	"net/rpc/jsonrpc":   {"L4", "NET", "encoding/json", "net/rpc"},
- }
+ // The general syntax of a rule is:
+ //
+ //		a, b < c, d;
+ //
+ // which means c and d come after a and b in the partial order
+ // (that is, c and d can import a and b),
+ // but doesn't provide a relative order between a vs b or c vs d.
+ //
+ // The rules can chain together, as in:
+ //
+ //		e < f, g < h;
+ //
+ // which is equivalent to
+ //
+ //		e < f, g;
+ //		f, g < h;
+ //
+ // Except for the special bottom element "NONE", each name
+ // must appear exactly once on the right-hand side of a rule.
+ // That rule serves as the definition of the allowed dependencies
+ // for that name. The definition must appear before any uses
+ // of the name on the left-hand side of a rule. (That is, the
+ // rules themselves must be ordered according to the partial
+ // order, for easier reading by people.)
+ //
+ // Negative assertions double-check the partial order:
+ //
+ //		i !< j
+ //
+ // means that it must NOT be the case that i < j.
+ // Negative assertions may appear anywhere in the rules,
+ // even before i and j have been defined.
+ //
+ // Comments begin with #.
+ //
+ // All-caps names are pseudo-names for specific points
+ // in the dependency lattice.
+ //
+ var depsRules = `
+ 	# No dependencies allowed for any of these packages.
+ 	NONE
+ 	< container/list, container/ring,
+ 	  internal/cfg, internal/cpu,
+ 	  internal/goversion, internal/nettrace,
+ 	  unicode/utf8, unicode/utf16, unicode,
+ 	  unsafe;
+ 
+ 	# RUNTIME is the core runtime group of packages, all of them very light-weight.
+ 	internal/cpu, unsafe
+ 	< internal/bytealg
+ 	< internal/unsafeheader
+ 	< runtime/internal/sys
+ 	< runtime/internal/atomic
+ 	< runtime/internal/math
+ 	< runtime
+ 	< sync/atomic
+ 	< internal/race
+ 	< sync
+ 	< internal/reflectlite
+ 	< errors
+ 	< internal/oserror, math/bits
+ 	< RUNTIME;
+ 
+ 	RUNTIME
+ 	< sort
+ 	< container/heap;
+ 
+ 	RUNTIME
+ 	< io;
+ 
+ 	reflect !< sort;
+ 
+ 	# SYSCALL is RUNTIME plus the packages necessary for basic system calls.
+ 	RUNTIME, unicode/utf8, unicode/utf16, io
+ 	< internal/syscall/windows/sysdll, syscall/js
+ 	< syscall
+ 	< internal/syscall/unix, internal/syscall/windows, internal/syscall/windows/registry
+ 	< internal/syscall/execenv
+ 	< SYSCALL;
+ 
+ 	# TIME is SYSCALL plus the core packages about time, including context.
+ 	SYSCALL
+ 	< time/tzdata
+ 	< time
+ 	< context
+ 	< TIME;
+ 
+ 	# MATH is RUNTIME plus the basic math packages.
+ 	RUNTIME
+ 	< math
+ 	< MATH;
+ 
+ 	unicode !< math;
+ 
+ 	MATH
+ 	< math/cmplx;
+ 
+ 	MATH
+ 	< math/rand;
+ 
+ 	MATH, unicode/utf8
+ 	< strconv;
+ 
+ 	unicode !< strconv;
+ 
+ 	# STR is basic string and buffer manipulation.
+ 	RUNTIME, io, unicode/utf8, unicode/utf16, unicode
+ 	< bytes, strings
+ 	< bufio, path;
+ 
+ 	bufio, path, strconv
+ 	< STR;
+ 
+ 	# OS is basic OS access, including helpers (path/filepath, os/exec, etc).
+ 	# OS includes string routines, but those must be layered above package os.
+ 	# OS does not include reflection.
+ 	TIME, io, sort
+ 	< internal/testlog
+ 	< internal/poll
+ 	< os
+ 	< os/signal;
+ 
+ 	unicode, fmt !< os, os/signal;
+ 
+ 	os/signal, STR
+ 	< path/filepath
+ 	< io/ioutil, os/exec
+ 	< OS;
+ 
+ 	reflect !< OS;
+ 
+ 	OS
+ 	< golang.org/x/sys/cpu, internal/goroot;
+ 
+ 	# FMT is OS (which includes string routines) plus reflect and fmt.
+ 	# It does not include package log, which should be avoided in core packages.
+ 	strconv, unicode
+ 	< reflect;
+ 
+ 	os, reflect
+ 	< internal/fmtsort
+ 	< fmt;
+ 
+ 	OS, fmt
+ 	< FMT;
+ 
+ 	log !< FMT;
+ 
+ 	# Misc packages needing only FMT.
+ 	FMT
+ 	< flag,
+ 	  html,
+ 	  mime/quotedprintable,
+ 	  net/internal/socktest,
+ 	  net/url,
+ 	  runtime/debug,
+ 	  runtime/trace,
+ 	  text/scanner,
+ 	  text/tabwriter;
+ 
+ 	# encodings
+ 	# core ones do not use fmt.
+ 	io, strconv
+ 	< encoding;
+ 
+ 	encoding, reflect
+ 	< encoding/binary
+ 	< encoding/base32, encoding/base64;
+ 
+ 	fmt !< encoding/base32, encoding/base64;
+ 
+ 	FMT, encoding/base32, encoding/base64
+ 	< encoding/ascii85, encoding/csv, encoding/gob, encoding/hex,
+ 	  encoding/json, encoding/pem, encoding/xml, mime;
+ 
+ 	# hashes
+ 	io
+ 	< hash
+ 	< hash/adler32, hash/crc32, hash/crc64, hash/fnv, hash/maphash;
+ 
+ 	# math/big
+ 	FMT, encoding/binary, math/rand
+ 	< math/big;
+ 
+ 	# compression
+ 	FMT, encoding/binary, hash/adler32, hash/crc32
+ 	< compress/bzip2, compress/flate, compress/lzw
+ 	< archive/zip, compress/gzip, compress/zlib;
+ 
+ 	# templates
+ 	FMT
+ 	< text/template/parse;
+ 
+ 	net/url, text/template/parse
+ 	< text/template
+ 	< internal/lazytemplate;
+ 
+ 	encoding/json, html, text/template
+ 	< html/template;
+ 
+ 	# regexp
+ 	FMT
+ 	< regexp/syntax
+ 	< regexp
+ 	< internal/lazyregexp;
+ 
+ 	# suffix array
+ 	encoding/binary, regexp
+ 	< index/suffixarray;
+ 
+ 	# executable parsing
+ 	FMT, encoding/binary, compress/zlib
+ 	< debug/dwarf
+ 	< debug/elf, debug/gosym, debug/macho, debug/pe, debug/plan9obj, internal/xcoff
+ 	< DEBUG;
+ 
+ 	# go parser and friends.
+ 	FMT
+ 	< go/token
+ 	< go/scanner
+ 	< go/ast
+ 	< go/parser;
+ 
+ 	go/parser, text/tabwriter
+ 	< go/printer
+ 	< go/format;
+ 
+ 	go/parser, internal/lazyregexp, text/template
+ 	< go/doc;
+ 
+ 	math/big, go/token
+ 	< go/constant;
+ 
+ 	container/heap, go/constant, go/parser
+ 	< go/types;
+ 
+ 	go/doc, go/parser, internal/goroot, internal/goversion
+ 	< go/build;
+ 
+ 	DEBUG, go/build, go/types, text/scanner
+ 	< go/internal/gcimporter, go/internal/gccgoimporter, go/internal/srcimporter
+ 	< go/importer;
+ 
+ 	# databases
+ 	FMT
+ 	< database/sql/internal
+ 	< database/sql/driver
+ 	< database/sql;
+ 
+ 	# images
+ 	FMT, compress/lzw, compress/zlib
+ 	< image/color
+ 	< image, image/color/palette
+ 	< image/internal/imageutil
+ 	< image/draw
+ 	< image/gif, image/jpeg, image/png;
+ 
+ 	# cgo, delayed as long as possible.
+ 	# If you add a dependency on CGO, you must add the package
+ 	# to cgoPackages in cmd/dist/test.go as well.
+ 	RUNTIME
+ 	< C
+ 	< runtime/cgo
+ 	< CGO
+ 	< runtime/race, runtime/msan;
+ 
+ 	# Bulk of the standard library must not use cgo.
+ 	# The prohibition stops at net and os/user.
 -	C !< fmt, go/types, CRYPTO-MATH;
++	C !< fmt, go/types;
+ 
+ 	CGO, OS
+ 	< plugin;
+ 
+ 	CGO, FMT
+ 	< os/user
+ 	< archive/tar;
+ 
+ 	sync
+ 	< internal/singleflight;
+ 
+ 	os
+ 	< golang.org/x/net/dns/dnsmessage,
+ 	  golang.org/x/net/lif,
+ 	  golang.org/x/net/route;
+ 
+ 	# net is unavoidable when doing any networking,
+ 	# so large dependencies must be kept out.
+ 	# This is a long-looking list but most of these
+ 	# are small with few dependencies.
+ 	# math/rand should probably be removed at some point.
+ 	CGO,
+ 	golang.org/x/net/dns/dnsmessage,
+ 	golang.org/x/net/lif,
+ 	golang.org/x/net/route,
+ 	internal/nettrace,
+ 	internal/poll,
+ 	internal/singleflight,
+ 	internal/race,
+ 	math/rand,
+ 	os
+ 	< net;
+ 
+ 	fmt, unicode !< net;
+ 
+ 	# NET is net plus net-helper packages.
+ 	FMT, net
+ 	< net/textproto;
+ 
+ 	mime, net/textproto, net/url
+ 	< NET;
+ 
+ 	# logging - most packages should not import; http and up is allowed
+ 	FMT
+ 	< log;
+ 
+ 	log !< crypto/tls, database/sql, go/importer, testing;
+ 
+ 	FMT, log, net
+ 	< log/syslog;
+ 
+ 	NET, log
+ 	< net/mail;
+ 
 -	# CRYPTO is core crypto algorithms - no cgo, fmt, net.
 -	# Unfortunately, stuck with reflect via encoding/binary.
 -	encoding/binary, golang.org/x/sys/cpu, hash
++	NONE < crypto/internal/boring/sig;
++	sync/atomic < crypto/internal/boring/fipstls;
++
++	encoding/binary, golang.org/x/sys/cpu, hash,
++	FMT, math/big,
++	CGO, crypto/internal/boring/sig, crypto/internal/boring/fipstls
+ 	< crypto
+ 	< crypto/subtle
+ 	< crypto/internal/subtle
+ 	< crypto/cipher
++	< encoding/asn1
++	< crypto/internal/boring
+ 	< crypto/aes, crypto/des, crypto/hmac, crypto/md5, crypto/rc4,
+ 	  crypto/sha1, crypto/sha256, crypto/sha512
 -	< CRYPTO;
 -
 -	CGO, fmt, net !< CRYPTO;
 -
 -	# CRYPTO-MATH is core bignum-based crypto - no cgo, net; fmt now ok.
 -	CRYPTO, FMT, math/big
+ 	< crypto/rand
+ 	< crypto/internal/randutil
+ 	< crypto/ed25519/internal/edwards25519
+ 	< crypto/ed25519
 -	< encoding/asn1
+ 	< golang.org/x/crypto/cryptobyte/asn1
+ 	< golang.org/x/crypto/cryptobyte
+ 	< golang.org/x/crypto/curve25519
+ 	< crypto/dsa, crypto/elliptic, crypto/rsa
+ 	< crypto/ecdsa
 -	< CRYPTO-MATH;
++	< CRYPTO-BORING;
+ 
 -	CGO, net !< CRYPTO-MATH;
++	net !< CRYPTO-BORING;
+ 
+ 	# TLS, Prince of Dependencies.
 -	CGO, CRYPTO-MATH, NET, container/list, encoding/hex, encoding/pem
++	CGO, CRYPTO-BORING, NET, container/list, encoding/hex, encoding/pem
+ 	< golang.org/x/crypto/internal/subtle
+ 	< golang.org/x/crypto/chacha20
+ 	< golang.org/x/crypto/poly1305
+ 	< golang.org/x/crypto/chacha20poly1305
+ 	< golang.org/x/crypto/hkdf
+ 	< crypto/x509/internal/macOS
+ 	< crypto/x509/pkix
+ 	< crypto/x509
+ 	< crypto/tls;
+ 
++	crypto/internal/boring/sig, crypto/internal/boring/fipstls
++	< crypto/tls/fipsonly;
++
+ 	# crypto-aware packages
+ 
+ 	NET, crypto/rand, mime/quotedprintable
+ 	< mime/multipart;
+ 
+ 	crypto/tls
+ 	< net/smtp;
+ 
+ 	# HTTP, King of Dependencies.
+ 
+ 	FMT
+ 	< golang.org/x/net/http2/hpack, net/http/internal;
+ 
+ 	FMT, NET, container/list, encoding/binary, log
+ 	< golang.org/x/text/transform
+ 	< golang.org/x/text/unicode/norm
+ 	< golang.org/x/text/unicode/bidi
+ 	< golang.org/x/text/secure/bidirule
+ 	< golang.org/x/net/idna
+ 	< golang.org/x/net/http/httpguts, golang.org/x/net/http/httpproxy;
+ 
+ 	NET, crypto/tls
+ 	< net/http/httptrace;
+ 
+ 	compress/gzip,
+ 	golang.org/x/net/http/httpguts,
+ 	golang.org/x/net/http/httpproxy,
+ 	golang.org/x/net/http2/hpack,
+ 	net/http/internal,
+ 	net/http/httptrace,
+ 	mime/multipart,
+ 	log
+ 	< net/http;
+ 
+ 	# HTTP-aware packages
  
- // isMacro reports whether p is a package dependency macro
- // (uppercase name).
- func isMacro(p string) bool {
- 	return 'A' <= p[0] && p[0] <= 'Z'
- }
+ 	encoding/json, net/http
+ 	< expvar;
  
- func allowed(pkg string) map[string]bool {
- 	m := map[string]bool{}
- 	var allow func(string)
- 	allow = func(p string) {
- 		if m[p] {
- 			return
- 		}
- 		m[p] = true // set even for macros, to avoid loop on cycle
+ 	net/http
+ 	< net/http/cookiejar, net/http/httputil;
+ 
+ 	net/http, flag
+ 	< net/http/httptest;
+ 
+ 	net/http, regexp
+ 	< net/http/cgi
+ 	< net/http/fcgi;
+ 
+ 	# Profiling
+ 	FMT, compress/gzip, encoding/binary, text/tabwriter
+ 	< runtime/pprof;
+ 
+ 	OS, compress/gzip, regexp
+ 	< internal/profile;
+ 
+ 	html/template, internal/profile, net/http, runtime/pprof, runtime/trace
+ 	< net/http/pprof;
+ 
+ 	# RPC
+ 	encoding/gob, encoding/json, go/token, html/template, net/http
+ 	< net/rpc
+ 	< net/rpc/jsonrpc;
+ 
+ 	# Test-only
+ 	log
+ 	< testing/iotest;
+ 
+ 	FMT, flag, math/rand
+ 	< testing/quick;
  
- 		// Upper-case names are macro-expanded.
- 		if isMacro(p) {
- 			for _, pp := range pkgDeps[p] {
- 				allow(pp)
- 			}
- 		}
- 	}
- 	for _, pp := range pkgDeps[pkg] {
- 		allow(pp)
- 	}
- 	return m
- }
+ 	FMT, flag, runtime/debug, runtime/trace
+ 	< testing;
+ 
+ 	internal/testlog, runtime/pprof, regexp
+ 	< testing/internal/testdeps;
+ 
+ 	OS, flag, testing, internal/cfg
+ 	< internal/testenv;
+ 
+ 	OS, encoding/base64
+ 	< internal/obscuretestdata;
+ 
+ 	CGO, OS, fmt
+ 	< os/signal/internal/pty;
+ 
+ 	NET, testing
+ 	< golang.org/x/net/nettest;
+ 
+ 	FMT, container/heap, math/rand
+ 	< internal/trace;
+ `
  
  // listStdPkgs returns the same list of packages as "go list std".
  func listStdPkgs(goroot string) ([]string, error) {
