commit 88382a9f97c96a610df5974cdeb165a6e7237861
Author: Cherry Zhang <cherryyz@google.com>
Date:   Tue Jul 14 14:46:59 2020 -0400

    [dev.link] cmd/link: stream out external relocations on AMD64 ELF
    
    Currently, when external linking, in relocsym (in asmb pass), we
    convert Go relocations to an in-memory representation of external
    relocations, and then in asmb2 pass we write them out to the
    output file. This is not memory efficient.
    
    This CL makes it not do the conversion but directly stream out
    the external relocations based on Go relocations. Currently only
    do this on AMD64 ELF systems.
    
    This reduces memory usage, but makes the asmb2 pass a little
    slower.
    
    Linking cmd/compile with external linking:
    
    name             old time/op    new time/op    delta
    Asmb_GC            83.8ms ± 7%    70.4ms ± 4%  -16.03%  (p=0.008 n=5+5)
    Asmb2_GC           95.6ms ± 4%   118.2ms ± 5%  +23.65%  (p=0.008 n=5+5)
    TotalTime_GC        1.59s ± 2%     1.62s ± 1%     ~     (p=0.151 n=5+5)
    
    name             old alloc/op   new alloc/op   delta
    Asmb_GC            26.0MB ± 0%     4.1MB ± 0%  -84.15%  (p=0.008 n=5+5)
    Asmb2_GC           8.19MB ± 0%    8.18MB ± 0%     ~     (p=0.222 n=5+5)
    
    name             old live-B     new live-B     delta
    Asmb_GC             49.2M ± 0%     27.4M ± 0%  -44.38%  (p=0.008 n=5+5)
    Asmb2_GC            51.5M ± 0%     29.7M ± 0%  -42.33%  (p=0.008 n=5+5)
    
    TODO: figure out what is slow. Possible improvements:
    - Remove redundant work in relocsym.
    - Maybe there is a better representation for external relocations
      now.
    - Fine-grained parallelism in emitting external relocations.
    - The old elfrelocsect only iterates over external relocations,
      now we iterate over all relocations. Is it too many?
    
    Change-Id: Ib0a8ee8c88d65864c62b89a8d634614f7f2c813e
    Reviewed-on: https://go-review.googlesource.com/c/go/+/242603
    Run-TryBot: Cherry Zhang <cherryyz@google.com>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Jeremy Faller <jeremy@golang.org>

 src/cmd/link/internal/ld/asmb.go       |   2 +-
 src/cmd/link/internal/ld/data.go       | 127 ++++++++++++++++++++++++++++++++-
 src/cmd/link/internal/ld/elf.go        |  58 +++++++++++----
 src/cmd/link/internal/loader/loader.go |   4 +-
 4 files changed, 170 insertions(+), 21 deletions(-)
