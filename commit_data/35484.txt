commit 482d241936deac1e50a77ab340345449f8579886
Author: Richard Musiol <mail@richard-musiol.de>
Date:   Fri Mar 9 00:14:58 2018 +0100

    cmd/compile: add wasm stack optimization
    
    Go's SSA instructions only operate on registers. For example, an add
    instruction would read two registers, do the addition and then write
    to a register. WebAssembly's instructions, on the other hand, operate
    on the stack. The add instruction first pops two values from the stack,
    does the addition, then pushes the result to the stack. To fulfill
    Go's semantics, one needs to map Go's single add instruction to
    4 WebAssembly instructions:
    - Push the value of local variable A to the stack
    - Push the value of local variable B to the stack
    - Do addition
    - Write value from stack to local variable C
    
    Now consider that B was set to the constant 42 before the addition:
    - Push constant 42 to the stack
    - Write value from stack to local variable B
    
    This works, but is inefficient. Instead, the stack is used directly
    by inlining instructions if possible. With inlining it becomes:
    - Push the value of local variable A to the stack (add)
    - Push constant 42 to the stack (constant)
    - Do addition (add)
    - Write value from stack to local variable C (add)
    
    Note that the two SSA instructions can not be generated sequentially
    anymore, because their WebAssembly instructions are interleaved.
    
    Design doc: https://docs.google.com/document/d/131vjr4DH6JFnb-blm_uRdaC0_Nv3OUwjEY5qVCxCup4
    
    Updates #18892
    
    Change-Id: Ie35e1c0bebf4985fddda0d6330eb2066f9ad6dec
    Reviewed-on: https://go-review.googlesource.com/103535
    Run-TryBot: Brad Fitzpatrick <bradfitz@golang.org>
    TryBot-Result: Gobot Gobot <gobot@golang.org>
    Reviewed-by: Cherry Zhang <cherryyz@google.com>

 logs.txt                                    |  0
 src/cmd/compile/internal/gc/ssa.go          |  3 +
 src/cmd/compile/internal/ssa/regalloc.go    | 72 ++++++++++++++++++++++-
 src/cmd/compile/internal/ssa/sizeof_test.go |  2 +-
 src/cmd/compile/internal/ssa/stackalloc.go  |  2 +-
 src/cmd/compile/internal/ssa/value.go       |  4 ++
 src/cmd/compile/internal/wasm/ssa.go        | 90 +++++++++++++++++++----------
 7 files changed, 137 insertions(+), 36 deletions(-)
